{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="{% static 'FeastArchitect/images/favicon.ico' %}">   
    <title>Feast Feature Store Architect{% if repo_name %} - {{ repo_name }}{% endif %}</title>

    <!-- Spark MD5 for hash computation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spark-md5/3.0.2/spark-md5.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            themeVariables: {
                primaryColor: '#3b82f6',
                primaryTextColor: '#fff',
                primaryBorderColor: '#60a5fa',
                lineColor: '#94a3b8',
                secondaryColor: '#1e293b',
                tertiaryColor: '#0f172a',
                fontFamily: 'Inter, sans-serif'
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                useMaxWidth: true
            }
        });
    </script>

    <!-- Django CSRF token for API calls -->
    <meta name="csrf-token" content="{{ csrf_token }}">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-elevated: #1e293b;
            --accent-primary: #3b82f6;
            --feast-orange: #f97316;
            --feast-blue: #3b82f6;
            --feast-purple: #8b5cf6;
            --feast-green: #10b981;
            --feast-yellow: #f59e0b;
            --feast-pink: #ec4899;
            --feast-cyan: #06b6d4;
            --feast-red: #ef4444;
            --feast-indigo: #6366f1;
            --feast-teal: #14b8a6;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: rgba(148, 163, 184, 0.2);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 20px rgba(249, 115, 22, 0.3);
            --code-bg: #0b1120;
            --grid-color: rgba(148, 163, 184, 0.05);
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #e2e8f0;
            --bg-elevated: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-color: rgba(148, 163, 184, 0.3);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.1);
            --shadow-glow: 0 0 20px rgba(249, 115, 22, 0.2);
            --code-bg: #f1f5f9;
            --grid-color: rgba(148, 163, 184, 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            line-height: 1.5;
            transition: background 0.3s, color 0.3s;
        }

        .app-container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        .toolbar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 1000;
            transition: all 0.3s;
        }

        .toolbar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toolbar-logo {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: url({% static 'FeastArchitect/images/disc-logo.png' %}) center / contain no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: var(--shadow-glow);
            cursor: pointer;
            flex-shrink: 0;
            transition: transform 0.2s;
        }

        .toolbar-logo:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .toolbar-title {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--feast-orange), #fbbf24);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .toolbar-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: -2px;
        }

        .toolbar-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .toolbar-divider {
            width: 1px;
            height: 32px;
            background: var(--border-color);
        }

        .view-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .layer-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .layer-toggle:hover {
            border-color: var(--feast-orange);
            color: var(--text-primary);
        }

        .layer-toggle.hidden-layer {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .layer-toggle .eye-icon {
            font-size: 14px;
        }

        .btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            background: var(--bg-primary);
            transform: translateY(-1px);
            border-color: var(--feast-orange);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--feast-orange), #ea580c);
            border-color: transparent;
            color: white;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }

        .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(249, 115, 22, 0.4);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-color: transparent;
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-icon {
            padding: 8px;
            font-size: 16px;
        }

        .btn-ghost {
            background: transparent;
            border-color: transparent;
        }

        .btn-ghost:hover {
            background: var(--bg-tertiary);
        }

        .btn-ai {
            border-color: transparent;
            color: white;
        }

        .btn-ai:hover {
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
            transform: translateY(-1px);
        }

        .btn-push {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-color: transparent;
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-push:hover {
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
            transform: translateY(-1px);
        }

        .canvas-wrapper {
            flex: 1;
            position: relative;
            margin-top: 64px;
            background: var(--bg-primary);
            overflow: hidden;
        }

        .grid-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
        }

        #diagramCanvas {
            width: 100%;
            height: 100%;
            cursor: grab;
            position: relative;
            z-index: 1;
        }

        #diagramCanvas:active {
            cursor: grabbing;
        }

        .canvas-controls {
            position: absolute;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: var(--bg-secondary);
            padding: 8px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            z-index: 100;
        }

        .canvas-btn {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            color: var(--text-secondary);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .canvas-btn:hover {
            background: var(--feast-orange);
            border-color: var(--feast-orange);
            color: white;
            transform: scale(1.05);
        }

        .mini-map {
            position: absolute;
            bottom: 24px;
            left: 24px;
            width: 200px;
            height: 150px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            z-index: 100;
        }

        #miniMapCanvas {
            width: 100%;
            height: 100%;
        }

        .fab-menu {
            position: absolute;
            top: 88px;
            left: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 100;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border-color);
            position: relative;
        }

        .fab:hover {
            transform: scale(1.2);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        }

        .fab-primary {
            background: linear-gradient(135deg, var(--feast-orange), #ea580c);
            color: white;
        }

        .fab-primary:hover {
            transform: scale(1.15);
            box-shadow: 0 8px 30px rgba(249, 115, 22, 0.4);
        }

        .fab-label {
            position: absolute;
            left: 70px;
            background: var(--bg-secondary);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            transform: translateX(-10px);
            transition: all 0.2s;
            pointer-events: none;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .fab:hover .fab-label {
            opacity: 1;
            transform: translateX(0);
        }

        /* Completely hideable side panel - no reserved space */
        .side-panel {
            position: fixed;
            top: 64px;
            right: 0;
            bottom: 0;
            width: 420px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 500;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-lg);
        }

        .side-panel.open {
            transform: translateX(0);
        }

        .panel-resize {
            position: absolute;
            left: -4px;
            top: 0;
            bottom: 0;
            width: 8px;
            cursor: col-resize;
            z-index: 10;
        }

        .panel-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .panel-title-section {
            flex: 1;
        }

        .panel-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .panel-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .panel-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .panel-actions {
            display: flex;
            gap: 8px;
        }

        .panel-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .panel-action-btn:hover {
            background: var(--feast-orange);
            border-color: var(--feast-orange);
            color: white;
        }

        .panel-action-btn.delete:hover {
            background: var(--feast-red);
            border-color: var(--feast-red);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .panel-section {
            margin-bottom: 28px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .section-badge {
            padding: 2px 8px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .detail-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .detail-value {
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 500;
            font-family: 'JetBrains Mono', monospace;
        }

        .detail-value.highlight {
            color: var(--feast-green);
        }

        .feature-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .feature-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .feature-item:hover {
            border-color: var(--feast-green);
            background: rgba(16, 185, 129, 0.05);
        }

        .feature-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feature-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(16, 185, 129, 0.1);
            color: var(--feast-green);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .feature-name {
            font-weight: 500;
            font-size: 14px;
        }

        .feature-type {
            font-size: 12px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .feature-badge {
            padding: 4px 10px;
            background: rgba(16, 185, 129, 0.1);
            color: var(--feast-green);
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
        }

        .connection-graph {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .connection-node {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .connection-node:hover {
            border-color: var(--feast-orange);
            transform: translateX(4px);
        }

        .connection-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .connection-info {
            flex: 1;
        }

        .connection-name {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .connection-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        .connection-arrow {
            color: var(--text-muted);
            font-size: 20px;
        }

        .notes-section {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
        }

        .notes-text {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
            white-space: pre-wrap;
        }

        .code-block {
            background: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            overflow-x: auto;
            position: relative;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .code-lang {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--feast-orange);
            font-weight: 600;
        }

        .code-copy {
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .code-content {
            color: #e2e8f0;
            line-height: 1.6;
        }

        [data-theme="light"] .code-content {
            color: #1e293b;
        }

        .code-keyword { color: #c084fc; }
        .code-string { color: #4ade80; }
        .code-function { color: #60a5fa; }
        .code-comment { color: #64748b; }
        .code-class { color: #f472b6; }

        .service-usage {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }

        .usage-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .usage-card:hover {
            border-color: var(--feast-orange);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .usage-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin: 0 auto 12px;
        }

        .usage-name {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .usage-type {
            font-size: 11px;
            color: var(--text-muted);
        }

        .usage-details {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--feast-orange);
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .usage-card:hover .usage-details {
            opacity: 1;
        }

        .stats-bar {
            position: absolute;
            bottom: 24px;
            left: 35%;
            right: 24px; 
            max-width: 550px; 
            display: flex;
            gap: 16px;
            padding: 12px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            transition: all 0.2s;
            z-index: 100;
        }

        .stats-bar:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            border-color: var(--feast-orange);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .stat-content {
            display: flex;
            flex-direction: column;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            line-height: 1;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .tooltip {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            pointer-events: none;
            z-index: 10000;
            max-width: 320px;
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-lg);
            display: none;
        }

        .tooltip-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .tooltip-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .tooltip-title-section {
            flex: 1;
        }

        .tooltip-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 2px;
        }

        .tooltip-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .tooltip-section {
            margin-bottom: 12px;
        }

        .tooltip-section-title {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }

        .tooltip-features {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tooltip-feature-tag {
            padding: 4px 8px;
            background: rgba(16, 185, 129, 0.1);
            color: var(--feast-green);
            border-radius: 4px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
        }

        .tooltip-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .tooltip-tag {
            padding: 2px 6px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 10px;
            color: var(--text-secondary);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(8px);
            padding: 24px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
        }

        .modal-xl {
            max-width: 900px;
        }

        .modal-xxl {
            max-width: 1100px;
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--feast-red);
            color: white;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--feast-orange);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .features-builder {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 16px;
        }

        .feature-input-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .feature-input {
            flex: 1;
        }

        .features-list-builder {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .feature-tag-builder {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 8px;
        }

        .feature-tag-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .feature-tag-name {
            font-weight: 500;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .feature-tag-type {
            padding: 2px 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .feature-tag-remove {
            background: none;
            border: none;
            color: var(--feast-red);
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .feature-tag-remove:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .entity-selector {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 4px;
        }

        .entity-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .entity-option:hover {
            border-color: var(--border-color);
        }

        .entity-option.selected {
            border-color: var(--feast-purple);
            background: rgba(139, 92, 246, 0.1);
        }

        .entity-option-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: rgba(139, 92, 246, 0.2);
            color: var(--feast-purple);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .guide-content {
            line-height: 1.7;
        }

        .guide-section {
            margin-bottom: 24px;
        }

        .guide-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--feast-orange);
        }

        .guide-text {
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .guide-code {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 12px 0;
        }

        .guide-list {
            list-style: none;
            padding: 0;
        }

        .guide-list li {
            padding: 8px 0;
            padding-left: 24px;
            position: relative;
            color: var(--text-secondary);
        }

        .guide-list li:before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            color: var(--feast-orange);
        }

        .search-box {
            position: relative;
        }

        .search-input {
            width: 280px;
            padding: 10px 16px 10px 40px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--feast-orange);
            width: 320px;
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        /* Search Dropdown Styles */
        .search-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            width: 400px;
            max-height: 500px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            z-index: 10001;
            overflow: hidden;
            display: none;
        }

        .search-dropdown.active {
            display: block;
        }

        .search-dropdown-header {
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .search-dropdown-content {
            max-height: 400px;
            overflow-y: auto;
        }

        .search-category {
            border-bottom: 1px solid var(--border-color);
        }

        .search-category:last-child {
            border-bottom: none;
        }

        .search-category-header {
            padding: 8px 16px;
            background: rgba(249, 115, 22, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--feast-orange);
            letter-spacing: 0.5px;
        }

        .search-category-icon {
            font-size: 14px;
        }

        .search-result-item {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .search-result-item:hover {
            background: var(--bg-tertiary);
            border-left-color: var(--feast-orange);
        }

        .search-result-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .search-result-info {
            flex: 1;
            min-width: 0;
        }

        .search-result-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-result-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .search-result-badge {
            padding: 2px 8px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            font-size: 10px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .search-no-results {
            padding: 24px;
            text-align: center;
            color: var(--text-muted);
            font-size: 14px;
        }

        .search-highlight {
            background: rgba(249, 115, 22, 0.3);
            color: var(--feast-orange);
            padding: 0 2px;
            border-radius: 3px;
            font-weight: 600;
        }

        .quick-actions {
            position: absolute;
            top: 88px;
            right: 24px;
            display: flex;
            gap: 8px;
            z-index: 100;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes slideIn {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .animate-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .tag {
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 11px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .tag.removable {
            padding-right: 6px;
            cursor: pointer;
        }

        .tag.removable:hover {
            border-color: var(--feast-red);
            color: var(--feast-red);
        }

        .tag-input {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 11px;
            width: 80px;
            outline: none;
        }

        /* Code Editor Panel - Slide out from right, hidden by default */
        .code-editor-panel {
            position: fixed;
            top: 64px;
            right: 0;
            bottom: 0;
            width: 600px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 400;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-lg);
        }

        .code-editor-panel.open {
            transform: translateX(0);
        }

        .code-editor-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .code-editor-title {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .code-editor-controls {
            display: flex;
            gap: 8px;
        }

        .code-editor-select {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
        }

        .code-editor-content {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .toggle-slider {
            width: 44px;
            height: 24px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            position: relative;
            transition: background 0.2s;
            border: 1px solid var(--border-color);
        }

        .toggle-slider.active {
            background: var(--feast-orange);
        }

        .toggle-knob {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 1px;
            left: 1px;
            transition: transform 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-slider.active .toggle-knob {
            transform: translateX(20px);
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .setting-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .theme-toggle {
            position: relative;
            width: 60px;
            height: 32px;
            background: var(--bg-tertiary);
            border-radius: 16px;
            cursor: pointer;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .theme-toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        [data-theme="light"] .theme-toggle-slider {
            transform: translateX(28px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .stat-detail-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .stat-detail-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .stat-detail-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-detail-title {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .stat-detail-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-detail-list {
            margin-top: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .stat-detail-item {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
            display: flex;
            justify-content: space-between;
        }

        .stat-detail-item:last-child {
            border-bottom: none;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
        }

        .data-table tr:hover td {
            background: var(--bg-tertiary);
        }

        .file-tree {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.8;
        }

        .file-tree-item {
            padding: 4px 0;
            padding-left: 20px;
            position: relative;
            color: var(--text-secondary);
        }

        .file-tree-item:before {
            content: "üìÑ";
            position: absolute;
            left: 0;
            opacity: 0.6;
        }

        .file-tree-item.dir:before {
            content: "üìÅ";
        }

        .file-tree-item.dir {
            color: var(--feast-orange);
            font-weight: 500;
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-icon {
            font-size: 20px;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            font-size: 14px;
        }

        .notification-text {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        @media (max-width: 1200px) {
            .side-panel {
                width: 100%;
            }
            
            .code-editor-panel {
                width: 100%;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        [data-theme="light"] ::-webkit-scrollbar-thumb:hover {
            background: #cbd5e1;
        }

        .lasso {
            position: absolute;
            border: 2px dashed var(--feast-orange);
            background: rgba(249, 115, 22, 0.1);
            pointer-events: none;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-healthy {
            background: rgba(16, 185, 129, 0.1);
            color: var(--feast-green);
        }

        .status-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--feast-yellow);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--feast-red);
        }

        .quality-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .quality-high {
            background: rgba(16, 185, 129, 0.1);
            color: var(--feast-green);
        }

        .quality-medium {
            background: rgba(245, 158, 11, 0.1);
            color: var(--feast-yellow);
        }

        .quality-low {
            background: rgba(239, 68, 68, 0.1);
            color: var(--feast-red);
        }

        /* Edge Manager Panel Styles */
        .edge-manager-panel {
            position: fixed;
            top: 64px;
            right: 0;
            bottom: 0;
            width: 480px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 450;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-lg);
        }

        .edge-manager-panel.open {
            transform: translateX(0);
        }

        .edge-manager-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .edge-manager-title {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .edge-manager-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .edge-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .edge-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s;
        }

        .edge-item:hover {
            border-color: var(--feast-orange);
            transform: translateX(4px);
        }

        .edge-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .edge-node-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .edge-arrow {
            color: var(--text-muted);
            font-size: 20px;
        }

        .edge-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .edge-btn {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .edge-btn:hover {
            border-color: var(--feast-orange);
            color: var(--feast-orange);
        }

        .edge-btn.danger:hover {
            border-color: var(--feast-red);
            color: var(--feast-red);
        }

        .add-edge-section {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 2px solid var(--border-color);
        }

        .add-edge-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .edge-select-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .edge-select {
            flex: 1;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 13px;
        }

        .edge-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .edge-stat-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
        }

        .edge-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--feast-orange);
        }

        .edge-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* File Browser in Code Editor */
        .file-browser {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 20px;
        }

        .file-browser-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .file-browser-item:hover {
            background: var(--bg-tertiary);
        }

        .file-browser-item.active {
            background: rgba(249, 115, 22, 0.1);
            border: 1px solid var(--feast-orange);
        }

        .file-icon {
            font-size: 16px;
        }

        .file-name {
            color: var(--text-primary);
        }

        .file-description {
            font-size: 11px;
            color: var(--text-muted);
            margin-left: auto;
        }

        .code-editor-layout {
            display: flex;
            gap: 20px;
            height: 100%;
        }

        .file-sidebar {
            width: 220px;
            flex-shrink: 0;
            border-right: 1px solid var(--border-color);
            padding-right: 20px;
        }

        .file-content-area {
            flex: 1;
            overflow: auto;
        }

        .file-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .file-header-icon {
            font-size: 20px;
        }

        .file-header-name {
            font-size: 16px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .file-header-path {
            font-size: 12px;
            color: var(--text-muted);
            margin-left: auto;
        }

        /* Data Flow Visualization Modal */
        .data-flow-stage {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .data-flow-stage:hover {
            border-color: var(--feast-orange);
            transform: translateX(8px);
        }

        .data-flow-stage.active {
            border-color: var(--feast-green);
            background: rgba(16, 185, 129, 0.05);
        }

        .stage-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .stage-info {
            flex: 1;
        }

        .stage-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .stage-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .stage-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-green { background: var(--feast-green); }
        .status-yellow { background: var(--feast-yellow); }
        .status-red { background: var(--feast-red); }

        .stage-details {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
            font-size: 12px;
            color: var(--text-secondary);
            display: none;
        }

        .data-flow-stage.expanded .stage-details {
            display: block;
        }

        .flow-connector {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 32px;
            color: var(--text-muted);
            font-size: 20px;
        }

        /* LLM Helper Panel */
        .llm-panel {
            position: fixed;
            top: 64px;
            right: 0;
            bottom: 0;
            width: 480px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 460;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-lg);
        }

        .llm-panel.open {
            transform: translateX(0);
        }

        .llm-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .llm-title {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .llm-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .llm-context {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
        }

        .llm-context-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .llm-context-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 13px;
            color: var(--text-primary);
        }

        .llm-prompts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .llm-prompt-btn {
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .llm-prompt-btn:hover {
            border-color: var(--feast-purple);
            background: rgba(139, 92, 246, 0.1);
        }

        .llm-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .llm-messages {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .llm-message {
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 90%;
            font-size: 13px;
            line-height: 1.6;
        }

        .llm-message.user {
            background: var(--feast-purple);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .llm-message.assistant {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .llm-message.assistant pre {
            background: var(--code-bg);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 8px 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        .llm-input-area {
            display: flex;
            gap: 8px;
        }

        .llm-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            resize: none;
            min-height: 44px;
            max-height: 120px;
        }

        .llm-input:focus {
            outline: none;
            border-color: var(--feast-purple);
        }

        .llm-send-btn {
            padding: 12px 20px;
            background: var(--feast-purple);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .llm-send-btn:hover {
            background: #7c3aed;
            transform: scale(1.05);
        }

        .llm-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .llm-action-btn {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .llm-action-btn:hover {
            border-color: var(--feast-purple);
            color: var(--feast-purple);
        }

        /* Django Admin Panel */
        .django-panel {
            position: fixed;
            top: 64px;
            right: 0;
            bottom: 0;
            width: 480px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 470;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-lg);
        }

        .django-panel.open {
            transform: translateX(0);
        }

        .django-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .django-title {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .django-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .django-section {
            margin-bottom: 24px;
        }

        .django-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .permission-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
        }

        .perm-owned {
            background: rgba(16, 185, 129, 0.1);
            color: var(--feast-green);
        }

        .perm-granted {
            background: rgba(59, 130, 246, 0.1);
            color: var(--feast-blue);
        }

        .perm-pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--feast-yellow);
        }

        .perm-denied {
            background: rgba(239, 68, 68, 0.1);
            color: var(--feast-red);
        }

        .audit-log-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .audit-time {
            color: var(--text-muted);
            font-size: 11px;
            min-width: 60px;
        }

        .audit-action {
            color: var(--text-primary);
        }

        .audit-user {
            color: var(--feast-blue);
        }

        .column-security-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
        }

        .column-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 13px;
        }

        .column-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-accessible { background: var(--feast-green); }
        .status-masked { background: var(--feast-yellow); }
        .status-denied { background: var(--feast-red); }

        /* Interactive Tour */
        .tour-highlight {
            position: fixed;
            border: 3px solid var(--feast-orange);
            border-radius: 12px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7);
            z-index: 10001;
            pointer-events: none;
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0%, 100% { box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7), 0 0 20px var(--feast-orange); }
            50% { box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7), 0 0 40px var(--feast-orange); }
        }

        .tour-tooltip {
            position: fixed;
            background: var(--bg-secondary);
            border: 2px solid var(--feast-orange);
            border-radius: 12px;
            padding: 20px;
            max-width: 320px;
            z-index: 10002;
            box-shadow: var(--shadow-lg);
        }

        .tour-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--feast-orange);
        }

        .tour-text {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .tour-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tour-step {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Pattern Library */
        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .pattern-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pattern-card:hover {
            border-color: var(--feast-orange);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .pattern-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 12px;
        }

        .pattern-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .pattern-desc {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .pattern-tags {
            display: flex;
            gap: 6px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .pattern-tag {
            padding: 2px 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-muted);
        }

        /* User Selector */
        .user-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-selector:hover {
            border-color: var(--feast-orange);
        }

        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--feast-orange), var(--feast-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-size: 13px;
            font-weight: 500;
        }

        .user-role {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Loading States */
        .loading-skeleton {
            background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-secondary) 50%, var(--bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--feast-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Access Request Button */
        .access-request-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--feast-green), #059669);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 12px;
        }

        .access-request-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .access-request-btn:disabled {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Guide Context Tabs */
        .guide-context-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 12px;
            overflow-x: auto;
        }

        .context-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .context-tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .context-tab.active {
            background: var(--feast-blue);
            color: white;
        }

        /* Guide Hero Section */
        .guide-hero {
            background: linear-gradient(135deg, #49699c 0%, #846656 100%);
            border-radius: 16px;
            padding: 40px;
            color: white;
            margin-bottom: 32px;
            text-align: center;
        }

        .guide-hero-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .guide-hero h2 {
            font-size: 32px;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .guide-hero p {
            font-size: 16px;
            opacity: 0.95;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Guide Grid */
        .guide-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .guide-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .guide-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }

        .guide-card-icon {
            font-size: 40px;
            margin-bottom: 16px;
        }

        .guide-card h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .guide-card p {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Mermaid Containers */
        .mermaid-container {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
        }

        .mermaid {
            display: flex;
            justify-content: center;
        }

        /* Component Showcase */
        .component-showcase {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .component-item {
            display: flex;
            gap: 16px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .component-badge {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .component-info h4 {
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .component-info p {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .component-info code {
            background: var(--bg-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: var(--feast-green);
        }

        /* Workflow Steps */
        .workflow-steps {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .step {
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }

        .step-number {
            width: 40px;
            height: 40px;
            background: var(--feast-blue);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            flex-shrink: 0;
        }

        .step-content h4 {
            font-size: 16px;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .step-content p {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Pattern Tabs */
        .pattern-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .pattern-tab {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .pattern-tab.active {
            background: var(--feast-blue);
            color: white;
            border-color: var(--feast-blue);
        }

        .pattern-details {
            margin-top: 20px;
        }

        .pattern-details h4 {
            font-size: 18px;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .pattern-details ul {
            margin-left: 20px;
            margin-bottom: 20px;
        }

        .pattern-details li {
            margin-bottom: 8px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Database Matrix */
        .db-matrix {
            overflow-x: auto;
        }

        /* Code Comparison */
        .code-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .code-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .code-header {
            background: var(--bg-tertiary);
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .code-panel pre {
            padding: 16px;
            margin: 0;
            font-size: 13px;
            line-height: 1.5;
            overflow-x: auto;
        }

        /* Strategy Cards */
        .strategy-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .strategy-card {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .strategy-header {
            padding: 16px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .latency-badge {
            background: rgba(255,255,255,0.2);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .strategy-body {
            padding: 16px;
            background: var(--bg-secondary);
        }

        .strategy-body p {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .strategy-body code {
            background: var(--bg-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: var(--feast-orange);
        }

        /* Feature Discovery */
        .feature-discovery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }

        .discovery-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .discovery-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .discovery-card h4 {
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .discovery-card p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .discovery-card code, .discovery-card kbd {
            background: var(--bg-primary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        /* Access Flow */
        .access-flow {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        .access-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            text-align: center;
            max-width: 120px;
        }

        .step-badge {
            width: 32px;
            height: 32px;
            background: var(--feast-blue);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .access-arrow {
            color: var(--text-muted);
            font-size: 20px;
        }

        /* Endpoint List */
        .endpoint-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .endpoint-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .endpoint-method {
            background: var(--feast-green);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            font-family: monospace;
            min-width: 80px;
            text-align: center;
        }

        .endpoint-path {
            font-family: monospace;
            font-size: 14px;
            color: var(--feast-blue);
            flex: 1;
        }

        .endpoint-desc {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Model Hierarchy */
        .model-hierarchy {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .model-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .model-card.primary {
            border-color: var(--feast-blue);
            border-width: 2px;
        }

        .model-card.secondary {
            border-color: var(--feast-green);
            border-style: dashed;
        }

        .model-children {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-left: 40px;
        }

        .model-card h4 {
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .model-card p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .code-comparison {
                grid-template-columns: 1fr;
            }
            
            .guide-context-tabs {
                flex-wrap: nowrap;
                overflow-x: scroll;
            }
            
            .model-children {
                margin-left: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="toolbar">
            <div class="toolbar-brand">
                <div class="toolbar-logo"></div>
                <div>
                    <div class="toolbar-title">Feast Architect</div>
                    <div class="toolbar-subtitle" id="repoSubtitle">Feature Store Visualization</div>
                </div>
            </div>

            <div class="toolbar-section">
                <!-- User/Team Selector -->
                <div class="user-selector" onclick="diagram.showUserSelector()">
                    <div class="user-avatar" id="userAvatar">JD</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">John Doe</div>
                        <div class="user-role" id="userRole">Data Engineer</div>
                    </div>
                </div>

                <div class="toolbar-divider"></div>

                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" placeholder="Search entities, features, tags, apps..." id="searchInput" autocomplete="off">
                    <div class="search-dropdown" id="searchDropdown">
                        <div class="search-dropdown-content" id="searchDropdownContent"></div>
                    </div>
                </div>

                <div class="toolbar-divider"></div>

                <button class="btn btn-icon" onclick="diagram.toggleTheme()" title="Toggle Theme">
                    <span id="themeIcon">‚òÄÔ∏è</span>
                </button>

                <button class="btn btn-icon" onclick="diagram.showSettings()" title="Settings">
                    <span>‚öôÔ∏è</span>
                </button>

                <button class="btn btn-icon" onclick="diagram.toggleEdgeManager()" title="Edge Manager">
                    <span>üîó</span>
                </button>

                <button class="btn btn-ai btn-icon" onclick="diagram.toggleLLMHelper()" title="AI Assistant (Ctrl+Shift+A)">
                    <span>ü§ñ</span>
                </button>

                <button class="btn btn-icon" onclick="diagram.toggleDjangoAdmin()" title="Django Admin (Ctrl+Shift+D)">
                    <span>üé≠</span>
                </button>

                <div class="toolbar-divider"></div>

                <div class="view-controls">
                    <button class="layer-toggle" id="toggleSources" onclick="diagram.toggleLayer('datasource')">
                        <span class="eye-icon">üëÅ</span>
                        <span>Sources</span>
                    </button>
                    <button class="layer-toggle" id="toggleEntities" onclick="diagram.toggleLayer('entity')">
                        <span class="eye-icon">üëÅ</span>
                        <span>Entities</span>
                    </button>
                    <button class="layer-toggle" id="toggleViews" onclick="diagram.toggleLayer('featureview')">
                        <span class="eye-icon">üëÅ</span>
                        <span>Views</span>
                    </button>
                    <button class="layer-toggle" id="toggleServices" onclick="diagram.toggleLayer('service')">
                        <span class="eye-icon">üëÅ</span>
                        <span>Services</span>
                    </button>
                </div>

                <div class="toolbar-divider"></div>

                <button class="btn btn-sm" onclick="diagram.showGuide()">
                    <span>üìñ</span>
                    <span>Guide</span>
                </button>
                <button class="btn btn-primary btn-sm" onclick="diagram.export()">
                    <span>üíæ</span>
                    <span>Export</span>
                </button>
                <button class="btn btn-sm" onclick="diagram.import()">
                    <span>üì•</span>
                    <span>Import</span>
                </button>
            </div>
        </div>

        <div class="quick-actions">
            <button class="btn btn-icon" onclick="diagram.fit()" title="Fit to screen">‚õ∂</button>
            <button class="btn btn-icon" onclick="diagram.resetView()" title="Reset view">‚åñ</button>
            <button class="btn btn-icon" onclick="diagram.toggleMiniMap()" title="Toggle minimap">üó∫</button>
            <button class="btn btn-icon" onclick="diagram.toggleCodeEditor()" title="Toggle Code Editor" id="codeEditorToggleBtn">üìù</button>
            <button class="btn btn-icon" onclick="diagram.showDataFlow()" title="Data Flow Architecture">üåä</button>
	    <button class="btn btn-icon btn-push" onclick="diagram.pushRepo()" title="Push Repository">üì§</button>
	    <button class="btn btn-icon" onclick="diagram.refreshRepo()" title="Refresh Repository">üîÑ</button>
        </div>

        <div class="fab-menu">
            <button class="fab fab-primary" onclick="diagram.showAddMenu()">
                <span>+</span>
                <span class="fab-label">Add Component</span>
            </button>
            <button class="fab" onclick="diagram.showAddModal('datasource')" style="display:none;" id="fabSource">
                <span>üóÑÔ∏è</span>
                <span class="fab-label">Data Source</span>
            </button>
            <button class="fab" onclick="diagram.showAddModal('entity')" style="display:none;" id="fabEntity">
                <span>üë§</span>
                <span class="fab-label">Entity</span>
            </button>
            <button class="fab" onclick="diagram.showAddModal('featureview')" style="display:none;" id="fabView">
                <span>üìä</span>
                <span class="fab-label">Feature View</span>
            </button>
            <button class="fab" onclick="diagram.showAddModal('service')" style="display:none;" id="fabService">
                <span>üöÄ</span>
                <span class="fab-label">Service</span>
            </button>
        </div>

        <div class="canvas-wrapper">
            <div class="grid-background"></div>
            <canvas id="diagramCanvas"></canvas>
            
            <div class="stats-bar" id="statsBar" onclick="diagram.showStatsModal()">
                <div class="stat-item">
                    <div class="stat-icon" style="background: rgba(59, 130, 246, 0.2); color: #60a5fa;">üóÑÔ∏è</div>
                    <div class="stat-content">
                        <div class="stat-value" id="statSources">0</div>
                        <div class="stat-label">Sources</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon" style="background: rgba(139, 92, 246, 0.2); color: #a78bfa;">üë§</div>
                    <div class="stat-content">
                        <div class="stat-value" id="statEntities">0</div>
                        <div class="stat-label">Entities</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon" style="background: rgba(16, 185, 129, 0.2); color: #34d399;">üìä</div>
                    <div class="stat-content">
                        <div class="stat-value" id="statViews">0</div>
                        <div class="stat-label">Views</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon" style="background: rgba(249, 115, 22, 0.2); color: #fb923c;">üöÄ</div>
                    <div class="stat-content">
                        <div class="stat-value" id="statServices">0</div>
                        <div class="stat-label">Services</div>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon" style="background: rgba(6, 182, 212, 0.2); color: #22d3ee;">‚ö°</div>
                    <div class="stat-content">
                        <div class="stat-value" id="statFeatures">0</div>
                        <div class="stat-label">Features</div>
                    </div>
                </div>
            </div>

            <div class="mini-map" id="miniMap">
                <canvas id="miniMapCanvas"></canvas>
            </div>

            <div class="canvas-controls">
                <button class="canvas-btn" onclick="diagram.zoomIn()">+</button>
                <button class="canvas-btn" onclick="diagram.zoomOut()">‚àí</button>
                <button class="canvas-btn" onclick="diagram.fit()">‚äò</button>
            </div>
        </div>

        <!-- Edge Manager Panel -->
        <div class="edge-manager-panel" id="edgeManagerPanel">
            <div class="edge-manager-header">
                <div class="edge-manager-title">
                    <span>üîó</span>
                    <span>Edge Manager</span>
                </div>
                <button class="btn btn-icon" onclick="diagram.toggleEdgeManager()">‚úï</button>
            </div>
            <div class="edge-manager-content" id="edgeManagerContent">
                <div class="edge-stats">
                    <div class="edge-stat-card">
                        <div class="edge-stat-value" id="edgeCountTotal">0</div>
                        <div class="edge-stat-label">Total Connections</div>
                    </div>
                    <div class="edge-stat-card">
                        <div class="edge-stat-value" id="edgeCountValid">0</div>
                        <div class="edge-stat-label">Valid</div>
                    </div>
                    <div class="edge-stat-card">
                        <div class="edge-stat-value" id="edgeCountOrphaned">0</div>
                        <div class="edge-stat-label">Orphaned</div>
                    </div>
                </div>
                
                <div class="edge-list" id="edgeList">
                    <!-- Edge items will be populated here -->
                </div>

                <div class="add-edge-section">
                    <div class="add-edge-title">‚ûï Add New Connection</div>
                    <div class="form-group">
                        <label class="form-label">From Node</label>
                        <select class="form-select" id="edgeFromSelect">
                            <option value="">Select source...</option>
                        </select>
                    </div>
                    <div class="edge-select-row">
                        <span style="font-size: 20px; color: var(--text-muted);">‚Üì</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">To Node</label>
                        <select class="form-select" id="edgeToSelect">
                            <option value="">Select target...</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; margin-top: 12px;" onclick="diagram.addEdgeFromManager()">
                        Create Connection
                    </button>
                </div>
            </div>
        </div>

        <!-- LLM Helper Panel -->
        <div class="llm-panel" id="llmPanel">
            <div class="llm-header">
                <div class="llm-title">
                    <span>ü§ñ</span>
                    <span>AI Assistant</span>
                </div>
                <button class="btn btn-icon" onclick="diagram.toggleLLMHelper()">‚úï</button>
            </div>
            <div class="llm-content">
                <div class="llm-context">
                    <div class="llm-context-title">Current Context</div>
                    <div id="llmContextContent">
                        <div class="llm-context-item">
                            <span>üìä</span>
                            <span>No node selected</span>
                        </div>
                    </div>
                </div>

                <div class="llm-prompts">
                    <button class="llm-prompt-btn" onclick="diagram.askLLM('generate_code')">
                        <strong>Generate Feast Code</strong><br>
                        <small>Create Python code for current architecture</small>
                    </button>
                    <button class="llm-prompt-btn" onclick="diagram.askLLM('optimize')">
                        <strong>Suggest Optimizations</strong><br>
                        <small>Improve feature view performance</small>
                    </button>
                    <button class="llm-prompt-btn" onclick="diagram.askLLM('lineage')">
                        <strong>Explain Data Lineage</strong><br>
                        <small>Trace data flow from source to service</small>
                    </button>
                    <button class="llm-prompt-btn" onclick="diagram.askLLM('validate')">
                        <strong>Validate Relationships</strong><br>
                        <small>Check entity and feature consistency</small>
                    </button>
                </div>

                <div class="llm-chat">
                    <div class="llm-messages" id="llmMessages">
                        <!-- Messages will appear here -->
                    </div>
                    <div class="llm-input-area">
                        <textarea class="llm-input" id="llmInput" placeholder="Ask anything about your feature store..." rows="1"></textarea>
                        <button class="llm-send-btn" onclick="diagram.sendLLMMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Django Admin Panel -->
        <div class="django-panel" id="djangoPanel">
            <div class="django-header">
                <div class="django-title">
                    <span>üé≠</span>
                    <span>Django Admin</span>
                </div>
                <button class="btn btn-icon" onclick="diagram.toggleDjangoAdmin()">‚úï</button>
            </div>
            <div class="django-content">
                <div class="django-section">
                    <div class="django-section-title">Access Control</div>
                    <div class="detail-card">
                        <div class="detail-row">
                            <span class="detail-label">Current User</span>
                            <span class="detail-value" id="djangoCurrentUser">John Doe</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Team</span>
                            <span class="detail-value" id="djangoTeam">Data Engineering</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Role</span>
                            <span class="detail-value" id="djangoRole">Feature Developer</span>
                        </div>
                    </div>
                </div>

                <div class="django-section">
                    <div class="django-section-title">Resource Permissions</div>
                    <div id="djangoPermissions">
                        <!-- Permissions will be populated here -->
                    </div>
                </div>

                <div class="django-section">
                    <div class="django-section-title">Recent Audit Log</div>
                    <div id="djangoAuditLog">
                        <!-- Audit log will be populated here -->
                    </div>
                </div>

                <div class="django-section">
                    <div class="django-section-title">Column Security</div>
                    <div id="djangoColumnSecurity">
                        <!-- Column security will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Code Editor Panel with File Browser -->
        <div class="code-editor-panel" id="codeEditorPanel">
            <div class="code-editor-header">
                <div class="code-editor-title">
                    <span>üìù</span>
                    <span>Feature Repository</span>
                </div>
                <div class="code-editor-controls">
                    <select class="code-editor-select" id="codeFormatSelect" onchange="diagram.updateCodeEditor()">
                        <option value="python">Python Files</option>
                        <option value="json">JSON (export)</option>
                        <option value="yaml">YAML (feature_store.yaml)</option>
                    </select>
                    <button class="btn btn-sm" onclick="diagram.copyCodeEditor()">üìã Copy</button>
                    <button class="btn btn-icon" onclick="diagram.toggleCodeEditor()">‚úï</button>
                </div>
            </div>
            <div class="code-editor-content">
                <div class="code-editor-layout">
                    <div class="file-sidebar" id="fileSidebar">
                        <!-- File browser populated by JS -->
                    </div>
                    <div class="file-content-area">
                        <div class="file-header" id="fileHeader">
                            <span class="file-header-icon">üìÑ</span>
                            <span class="file-header-name" id="currentFileName">Select a file</span>
                            <span class="file-header-path" id="currentFilePath"></span>
                        </div>
                        <div class="code-block" style="height: calc(100% - 60px);">
                            <pre class="code-content" id="codeEditorContent" style="white-space: pre-wrap; word-wrap: break-word;"></pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="side-panel" id="detailPanel">
            <div class="panel-resize"></div>
            <div class="panel-header">
                <div class="panel-title-section">
                    <div class="panel-type-badge" id="panelBadge">
                        <span id="panelIcon">üìä</span>
                        <span id="panelType">Feature View</span>
                    </div>
                    <div class="panel-title" id="panelTitle">Select a Component</div>
                    <div class="panel-subtitle" id="panelSubtitle">Click on any node to view details</div>
                    <div class="tags-container" id="panelTags"></div>
                </div>
                <div class="panel-actions">
                    <button class="panel-action-btn" onclick="diagram.editSelected()" title="Edit">‚úèÔ∏è</button>
                    <button class="panel-action-btn delete" onclick="diagram.deleteSelected()" title="Delete">üóëÔ∏è</button>
                    <button class="panel-action-btn" onclick="diagram.closePanel()" title="Close">‚úï</button>
                </div>
            </div>
            <div class="panel-content" id="panelContent">
                <div class="empty-state">
                    <div class="empty-icon">üìã</div>
                    <div class="empty-title">No Selection</div>
                    <p>Click on any component in the diagram to view its details, connections, and metadata.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip">
        <div class="tooltip-header">
            <div class="tooltip-icon" id="tooltipIcon">üìä</div>
            <div class="tooltip-title-section">
                <div class="tooltip-title" id="tooltipTitle">Component Name</div>
                <div class="tooltip-subtitle" id="tooltipSubtitle">Type ‚Ä¢ Subtype</div>
            </div>
        </div>
        <div class="tooltip-section" id="tooltipTags">
            <div class="tooltip-section-title">Tags</div>
            <div class="tooltip-tags" id="tooltipTagList"></div>
        </div>
        <div class="tooltip-section" id="tooltipFeatures">
            <div class="tooltip-section-title">Features</div>
            <div class="tooltip-features" id="tooltipFeatureList"></div>
        </div>
        <div class="tooltip-section" id="tooltipDescription">
            <div class="tooltip-section-title">Description</div>
            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;" id="tooltipDescText"></div>
        </div>
    </div>

    <div class="modal-overlay" id="componentModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Add Component</div>
                <button class="modal-close" onclick="diagram.closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button class="btn" onclick="diagram.closeModal()">Cancel</button>
                <button class="btn btn-danger" onclick="diagram.confirmDelete()" id="deleteBtn" style="display:none; margin-right: auto;">Delete</button>
                <button class="btn btn-primary" onclick="diagram.saveComponent()">Save Component</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">‚öôÔ∏è Settings</div>
                <button class="modal-close" onclick="document.getElementById('settingsModal').classList.remove('active')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <div class="settings-title">Appearance</div>
                    <div class="setting-item">
                        <span class="setting-label">Dark Mode</span>
                        <div class="theme-toggle" onclick="diagram.toggleTheme()">
                            <div class="theme-toggle-slider">
                                <span id="settingsThemeIcon">üåô</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title">Repository Info</div>
                    <div class="form-group">
                        <label class="form-label">Repository Name</label>
                        <input type="text" class="form-input" id="settingsRepoName" placeholder="my_feature_repo">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Repository Location</label>
                        <input type="text" class="form-input" id="settingsRepoLocation" placeholder="/path/to/feature_repo">
                    </div>
                    <!-- New description field -->
                    <div class="form-group">
                        <label class="form-label">Repository Description</label>
                        <textarea class="form-textarea" id="settingsRepoDescription" placeholder="Brief description of this feature repository" rows="2"></textarea>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title">Search Configuration</div>
                    <div class="setting-item">
                        <span class="setting-label">Include Descriptions</span>
                        <div class="toggle-switch" onclick="diagram.toggleSearchSetting('descriptions')">
                            <div class="toggle-slider active" id="toggleDescriptions">
                                <div class="toggle-knob"></div>
                            </div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Include Tags</span>
                        <div class="toggle-switch" onclick="diagram.toggleSearchSetting('tags')">
                            <div class="toggle-slider active" id="toggleTags">
                                <div class="toggle-knob"></div>
                            </div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Include Used By (Applications)</span>
                        <div class="toggle-switch" onclick="diagram.toggleSearchSetting('usedBy')">
                            <div class="toggle-slider active" id="toggleUsedBy">
                                <div class="toggle-knob"></div>
                            </div>
                        </div>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">Include Access Process</span>
                        <div class="toggle-switch" onclick="diagram.toggleSearchSetting('access')">
                            <div class="toggle-slider active" id="toggleAccess">
                                <div class="toggle-knob"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="settings-title">Data Sources</div>
                    <div class="setting-item">
                        <span class="setting-label">Default Owner Team</span>
                        <input type="text" class="form-input" id="settingsDefaultOwner" placeholder="Data Platform Team" style="width: 200px;">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="document.getElementById('settingsModal').classList.remove('active')">Cancel</button>
                <button class="btn btn-primary" onclick="diagram.saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="statsModal">
        <div class="modal modal-xl">
            <div class="modal-header">
                <div class="modal-title">üìä System Overview</div>
                <button class="modal-close" onclick="document.getElementById('statsModal').classList.remove('active')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="stats-grid" id="statsGrid"></div>
                
                <div style="margin-top: 24px;">
                    <div class="section-header">
                        <div class="section-title">Repository Structure</div>
                    </div>
                    <div class="detail-card">
                        <div class="file-tree" id="fileTree"></div>
                    </div>
                </div>

                <div style="margin-top: 24px;">
                    <div class="section-header">
                        <div class="section-title">Recent Activity</div>
                    </div>
                    <div class="detail-card">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Action</th>
                                    <th>Component</th>
                                    <th>User</th>
                                </tr>
                            </thead>
                            <tbody id="activityTable">
                                <tr>
                                    <td>Just now</td>
                                    <td>Viewed</td>
                                    <td>System Overview</td>
                                    <td>Current User</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="usageModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="usageModalTitle">Application Details</div>
                <button class="modal-close" onclick="document.getElementById('usageModal').classList.remove('active')">√ó</button>
            </div>
            <div class="modal-body" id="usageModalBody"></div>
            <div class="modal-footer">
                <button class="btn" onclick="document.getElementById('usageModal').classList.remove('active')">Close</button>
                <button class="btn btn-primary" onclick="diagram.saveUsageDetails()">Save Changes</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="guideModal">
        <div class="modal modal-xxl">
            <div class="modal-header">
                <div class="modal-title">üìñ Feature Architect Store Guide</div>
                <button class="modal-close" onclick="document.getElementById('guideModal').classList.remove('active')">√ó</button>
            </div>
            <div class="modal-body">
                <!-- User Context Selector -->
                <div class="guide-context-tabs">
                    <button class="context-tab active" onclick="diagram.switchGuideContext('overview')" id="tab-overview">
                        <span>üè†</span> Overview
                    </button>
                    <button class="context-tab" onclick="diagram.switchGuideContext('data-engineer')" id="tab-data-engineer">
                        <span>‚öôÔ∏è</span> Data Engineer
                    </button>
                    <button class="context-tab" onclick="diagram.switchGuideContext('ml-engineer')" id="tab-ml-engineer">
                        <span>ü§ñ</span> ML Engineer
                    </button>
                    <button class="context-tab" onclick="diagram.switchGuideContext('data-scientist')" id="tab-data-scientist">
                        <span>üìä</span> Data Scientist
                    </button>
                    <button class="context-tab" onclick="diagram.switchGuideContext('backend')" id="tab-backend">
                        <span>üîß</span> Backend API
                    </button>
                </div>

                <!-- OVERVIEW CONTEXT -->
                <div class="guide-content active" id="guide-overview">
                    <div class="guide-hero">
                        <div class="guide-hero-icon">üèóÔ∏è</div>
                        <h2>Feature Architect Store</h2>
                        <p>Visual design tool for Feast feature stores with collaborative architecture planning, 
                        code generation, and LLM-powered assistance. Bridge the gap between data infrastructure 
                        and machine learning with intuitive drag-and-drop design.</p>
                    </div>

                    <div class="guide-grid">
                        <div class="guide-card">
                            <div class="guide-card-icon">üéØ</div>
                            <h3>Visual Design</h3>
                            <p>Drag-and-drop interface for designing feature store architectures. 
                            Connect data sources to entities, feature views, and services with automatic validation.</p>
                        </div>
                        <div class="guide-card">
                            <div class="guide-card-icon">üíª</div>
                            <h3>Code Generation</h3>
                            <p>Auto-generate production-ready Python code for Feast entities, feature views, 
                            and services. Export complete repository structures with proper documentation.</p>
                        </div>
                        <div class="guide-card">
                            <div class="guide-card-icon">ü§ñ</div>
                            <h3>AI Assistant</h3>
                            <p>LLM-powered guidance for architecture decisions, optimization suggestions, 
                            and data lineage analysis. Get real-time feedback on your design patterns.</p>
                        </div>
                        <div class="guide-card">
                            <div class="guide-card-icon">üîê</div>
                            <h3>Access Control</h3>
                            <p>Built-in ownership tracking, access process documentation, and column-level 
                            security. Integrate with Django permissions for enterprise governance.</p>
                        </div>
                    </div>

                    <div class="guide-section">
                        <div class="guide-title">Architecture Overview</div>
                        <div class="mermaid-container">
                            <pre class="mermaid">
    flowchart TB
        subgraph DataSources["Data Sources Layer"]
            PG[(PostgreSQL)]
            MG[(MongoDB)]
            KF[/Kafka/]
            S3[(S3 Data Lake)]
            RD[(Redis)]
        end
        
        subgraph Ingestion["Ingestion Layer"]
            DBZ[Debezium CDC]
            SP[Spark Streaming]
            BATCH[Batch Jobs]
        end
        
        subgraph FeastCore["Feast Core"]
            REG[(Registry)]
            OFF[(Offline Store<br/>Snowflake/Postgres)]
            ON[(Online Store<br/>Redis/DynamoDB)]
        end
        
        subgraph Serving["Serving Layer"]
            API[Feature Server API]
            SDK[Python/Go/Java SDK]
        end
        
        subgraph Consumers["ML Consumers"]
            TRAIN[Training Pipelines]
            INF[Real-time Inference]
            BATCH_PRED[Batch Prediction]
        end
        
        PG --> DBZ --> KF --> SP --> OFF
        PG --> BATCH --> OFF
        MG --> BATCH --> OFF
        S3 --> BATCH --> OFF
        
        OFF -->|Materialize| ON
        ON --> API --> SDK
        
        SDK --> TRAIN
        SDK --> INF
        SDK --> BATCH_PRED
        
        REG -.->|Metadata| OFF
        REG -.->|Metadata| ON
                            </pre>
                        </div>
                    </div>

                    <div class="guide-section">
                        <div class="guide-title">The Four Core Components</div>
                        <div class="component-showcase">
                            <div class="component-item">
                                <div class="component-badge" style="background: #3b82f6;">üóÑÔ∏è</div>
                                <div class="component-info">
                                    <h4>Data Sources</h4>
                                    <p>30+ supported databases including PostgreSQL, MongoDB, Kafka, Snowflake, 
                                    and S3. Each with Debezium CDC support indicators and Spark integration patterns.</p>
                                    <code>FileSource, KafkaSource, PushSource</code>
                                </div>
                            </div>
                            <div class="component-item">
                                <div class="component-badge" style="background: #8b5cf6;">üë§</div>
                                <div class="component-info">
                                    <h4>Entities</h4>
                                    <p>Business objects with unique join keys. The backbone of feature relationships 
                                    enabling point-in-time correct joins across different feature views.</p>
                                    <code>Entity(name="user", join_keys=["user_id"])</code>
                                </div>
                            </div>
                            <div class="component-item">
                                <div class="component-badge" style="background: #10b981;">üìä</div>
                                <div class="component-info">
                                    <h4>Feature Views</h4>
                                    <p>Logical groupings of features with TTL, entities, and data sources. 
                                    Support batch, streaming, and on-demand computation modes.</p>
                                    <code>FeatureView, StreamFeatureView, OnDemandFeatureView</code>
                                </div>
                            </div>
                            <div class="component-item">
                                <div class="component-badge" style="background: #f97316;">üöÄ</div>
                                <div class="component-info">
                                    <h4>Feature Services</h4>
                                    <p>Model-ready feature bundles with versioning and SLA tracking. 
                                    Composite services can reference other services for layered abstractions.</p>
                                    <code>FeatureService(name="recommendation_v1")</code>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="guide-section">
                        <div class="guide-title">Quick Start Workflow</div>
                        <div class="workflow-steps">
                            <div class="step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h4>Design Architecture</h4>
                                    <p>Use the canvas to drag data sources, define entities, and connect feature views. 
                                    The Edge Manager helps validate all connections follow Feast patterns.</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h4>Configure Ownership</h4>
                                    <p>Set team ownership and access processes for each data source. 
                                    Document security requirements and column-level PII classifications.</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h4>Generate Code</h4>
                                    <p>Export Python files (entities.py, feature_views.py, services.py) or 
                                    complete JSON for version control. Includes Debezium configs and Spark jobs.</p>
                                </div>
                            </div>
                            <div class="step">
                                <div class="step-number">4</div>
                                <div class="step-content">
                                    <h4>Deploy & Monitor</h4>
                                    <p>Push to Feast registry, materialize to online store, and monitor 
                                    via the Data Flow view. Track lineage and performance in real-time.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DATA ENGINEER CONTEXT -->
                <div class="guide-content" id="guide-data-engineer" style="display: none;">
                    <div class="guide-hero" style="background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);">
                        <div class="guide-hero-icon">‚öôÔ∏è</div>
                        <h2>Data Engineer Guide</h2>
                        <p>Build robust data pipelines, configure CDC with Debezium, and manage the 
                        infrastructure layer of your feature store. Focus on data quality, latency, and scale.</p>
                    </div>

                    <div class="guide-section">
                        <div class="guide-title">Data Source Configuration Patterns</div>
                        
                        <div class="pattern-tabs">
                            <button class="pattern-tab active" onclick="diagram.showPattern('cdc-batch')">CDC Batch</button>
                            <button class="pattern-tab" onclick="diagram.showPattern('streaming')">Streaming</button>
                            <button class="pattern-tab" onclick="diagram.showPattern('hybrid')">Hybrid Lambda</button>
                        </div>

                        <div class="pattern-content active" id="pattern-cdc-batch">
                            <div class="mermaid-container">
                                <pre class="mermaid">
    flowchart LR
        A[(PostgreSQL)] -->|Debezium| B[Kafka Topic]
        B -->|Spark Batch| C[(Offline Store<br/>Snowflake)]
        C -->|Materialize| D[(Online Store<br/>Redis)]
        D --> E[Feature Server]
        
        style A fill:#3b82f6,color:#fff
        style D fill:#ef4444,color:#fff
                                </pre>
                            </div>
                            <div class="pattern-details">
                                <h4>Change Data Capture (CDC) Pattern</h4>
                                <p>Best for: Transactional databases requiring near real-time features with historical accuracy.</p>
                                <ul>
                                    <li><strong>Debezium</strong> captures row-level changes from PostgreSQL/MySQL transaction logs</li>
                                    <li><strong>Kafka</strong> provides durable event streaming with configurable retention</li>
                                    <li><strong>Spark Structured Streaming</strong> processes events into the offline store</li>
                                    <li><strong>Materialization</strong> syncs to online store for low-latency serving</li>
                                </ul>
                                <div class="code-block">
                                    <pre># Generated Debezium Config
    postgres_connector = {
        "name": "user-db-connector",
        "config": {
            "connector.class": "io.debezium.connector.postgresql.PostgresConnector",
            "database.hostname": "postgres.internal",
            "database.server.name": "dbz",
            "plugin.name": "pgoutput",
            "table.include.list": "public.users,public.transactions"
        }
    }</pre>
                                </div>
                            </div>
                        </div>

                        <div class="pattern-content" id="pattern-streaming" style="display: none;">
                            <div class="mermaid-container">
                                <pre class="mermaid">
    flowchart LR
        A[/Kafka Events/] -->|Spark Streaming| B[Stream Feature View]
        B -->|Write| C[(Online Store)]
        B -->|Checkpoint| D[(Offline Store)]
        
        style A fill:#f59e0b,color:#000
        style C fill:#ef4444,color:#fff
                                </pre>
                            </div>
                            <div class="pattern-details">
                                <h4>Streaming-First Pattern</h4>
                                <p>Best for: High-velocity event streams requiring sub-second feature freshness.</p>
                                <ul>
                                    <li>Direct Kafka-to-Feature-View ingestion using Spark Structured Streaming</li>
                                    <li>Windowed aggregations with watermarks for late data handling</li>
                                    <li>Dual write to online (low latency) and offline (historical) stores</li>
                                </ul>
                            </div>
                        </div>

                        <div class="pattern-content" id="pattern-hybrid" style="display: none;">
                            <div class="mermaid-container">
                                <pre class="mermaid">
    flowchart TB
        A[(Source DB)] -->|Batch| B[Batch Feature View]
        A -->|CDC| C[Stream Feature View]
        B --> D[Unified Feature View]
        C --> D
        D --> E[Feature Service]
        
        style D fill:#8b5cf6,color:#fff
                                </pre>
                            </div>
                            <div class="pattern-details">
                                <h4>Lambda Architecture Pattern</h4>
                                <p>Best for: Complex features requiring both historical completeness and real-time updates.</p>
                                <ul>
                                    <li><strong>Batch layer</strong>: Complete historical features with full accuracy</li>
                                    <li><strong>Speed layer</strong>: Real-time increments for immediate availability</li>
                                    <li><strong>Serving layer</strong>: Merged view combining both layers</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="guide-section">
                        <div class="guide-title">Database Support Matrix</div>
                        <div class="db-matrix">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Database</th>
                                        <th>Category</th>
                                        <th>Debezium CDC</th>
                                        <th>Feast Source Type</th>
                                        <th>Spark Pattern</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>üêò PostgreSQL</td>
                                        <td>Relational</td>
                                        <td>‚úÖ Yes</td>
                                        <td>PostgreSQLSource</td>
                                        <td>JDBC batch + CDC</td>
                                    </tr>
                                    <tr>
                                        <td>üçÉ MongoDB</td>
                                        <td>NoSQL</td>
                                        <td>‚úÖ Yes</td>
                                        <td>PushSource</td>
                                        <td>MongoDB Spark Connector</td>
                                    </tr>
                                    <tr>
                                        <td>‚ùÑÔ∏è Snowflake</td>
                                        <td>Cloud Warehouse</td>
                                        <td>‚ùå No</td>
                                        <td>SnowflakeSource</td>
                                        <td>Native connector</td>
                                    </tr>
                                    <tr>
                                        <td>üì® Kafka</td>
                                        <td>Streaming</td>
                                        <td>N/A</td>
                                        <td>KafkaSource</td>
                                        <td>Structured Streaming</td>
                                    </tr>
                                    <tr>
                                        <td>‚ö° DynamoDB</td>
                                        <td>NoSQL</td>
                                        <td>‚ùå No</td>
                                        <td>PushSource</td>
                                        <td>DynamoDB Streams</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="guide-section">
                        <div class="guide-title">Access Control Implementation</div>
                        <div class="mermaid-container">
                            <pre class="mermaid">
    flowchart LR
        subgraph Perimeter["Perimeter Security"]
            AUTH[Django Auth]
            RBAC[Role-Based Access]
        end
        
        subgraph DataLayer["Data Layer"]
            DS[Data Source Metadata]
            COL[Column Security]
            AUDIT[Audit Logging]
        end
        
        subgraph Infrastructure["Infrastructure"]
            KAFKA_ACL[Kafka ACLs]
            SPARK_CTX[Spark Security Context]
            RLS[Postgres RLS]
        end
        
        AUTH --> RBAC --> DS
        DS --> COL
        COL --> KAFKA_ACL
        COL --> SPARK_CTX
        COL --> RLS
        DS --> AUDIT
        
        style AUTH fill:#3b82f6,color:#fff
        style RLS fill:#10b981,color:#fff
                            </pre>
                        </div>
                        <p>Implement defense-in-depth with Django permissions flowing through to Kafka ACLs, 
                        Spark security contexts, and Postgres Row-Level Security (RLS) policies.</p>
                    </div>
                </div>

                <!-- ML ENGINEER CONTEXT -->
                <div class="guide-content" id="guide-ml-engineer" style="display: none;">
                    <div class="guide-hero" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);">
                        <div class="guide-hero-icon">ü§ñ</div>
                        <h2>ML Engineer Guide</h2>
                        <p>Deploy models with reliable feature serving, manage feature transformations, 
                        and optimize serving latency. Bridge training and inference with consistent feature logic.</p>
                    </div>

                    <div class="guide-section">
                        <div class="guide-title">Feature Serving Architecture</div>
                        <div class="mermaid-container">
                            <pre class="mermaid">
    flowchart TB
        subgraph Training["Training Pipeline"]
            HIST[Historical Features<br/>Point-in-Time Correct]
            MODEL[Model Training]
            REG[Model Registry]
        end
        
        subgraph Serving["Real-time Serving"]
            FEAT[Feature Retrieval]
            TRANS[On-Demand Transform]
            PRED[Prediction]
        end
        
        subgraph Stores["Feature Stores"]
            OFF[(Offline Store<br/>Batch/Historical)]
            ON[(Online Store<br/>Low Latency)]
        end
        
        OFF -->|get_historical_features| HIST
        HIST --> MODEL --> REG --> PRED
        ON -->|get_online_features| FEAT
        FEAT --> TRANS --> PRED
        
        style ON fill:#ef4444,color:#fff
        style OFF fill:#3b82f6,color:#fff
                            </pre>
                        </div>
                    </div>

                    <div class="guide-section">
                        <div class="guide-title">Python SDK Usage Patterns</div>
                        
                        <div class="code-comparison">
                            <div class="code-panel">
                                <div class="code-header">Batch Retrieval (Training)</div>
                                <pre class="code-content">from feast import FeatureStore
    import pandas as pd

    store = FeatureStore(repo_path=".")

    # Point-in-time correct join
    training_df = store.get_historical_features(
        entity_df=pd.DataFrame({
            "user_id": ["user_1", "user_2"],
            "event_timestamp": [
                datetime(2024, 1, 1),
                datetime(2024, 1, 2)
            ]
        }),
        features=[
            "user_demographics:age",
            "user_demographics:country",
            "transaction_stats:amount_30d"
        ]
    ).to_df()</pre>
                            </div>
                            
                            <div class="code-panel">
                                <div class="code-header">Online Retrieval (Inference)</div>
                                <pre class="code-content">from feast import FeatureStore

    store = FeatureStore(repo_path=".")

    # Low-latency feature lookup
    features = store.get_online_features(
        feature_service="recommendation_v1",
        entity_rows=[
            {"user_id": "user_123", "context": "mobile"}
        ]
    ).to_dict()

    # On-demand transformation
    prediction = model.predict(
        features["user_demographics:age"],
        features["transaction_stats:amount_30d"]
    )</pre>
                            </div>
                        </div>
                    </div>

                    <div class="guide-section">
                        <div class="guide-title">Feature Transformation Strategies</div>
                        <div class="strategy-cards">
                            <div class="strategy-card">
                                <div class="strategy-header" style="background: #10b981;">
                                    <span>Pre-computed</span>
                                    <span class="latency-badge">&lt; 10ms</span>
                                </div>
                                <div class="strategy-body">
                                    <p>Transformations applied during ingestion or materialization. 
                                    Best for: Aggregations, embeddings, complex SQL.</p>
                                    <code>FeatureView with SQL transformation</code>
                                </div>
                            </div>
                            <div class="strategy-card">
                                <div class="strategy-header" style="background: #f59e0b;">
                                    <span>On-Demand</span>
                                    <span class="latency-badge">&lt; 50ms</span>
                                </div>
                                <div class="strategy-body">
                                    <p>Computed at request time using request context. 
                                    Best for: Time-since features, personalization logic.</p>
                                    <code>OnDemandFeatureView with Python transform</code>
                                </div>
                            </div>
                            <div class="strategy-card">
                                <div class="strategy-header" style="background: #8b5cf6;">
                                    <span>Hybrid</span>
                                    <span class="latency-badge">Variable</span>
                                </div>
                                <div class="strategy-body">
                                    <p>Combine pre-computed base features with on-demand overlays. 
                                    Best for: Real-time personalization with historical context.</p>
                                    <code>Feature Service composition</code>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="guide-section">
                        <div class="guide-title">Performance Optimization</div>
                        <ul class="optimization-list">
                            <li>
                                <strong>Online Store Selection</strong>
                                <p>Redis for sub-5ms latency, DynamoDB for AWS-native, 
                                Bigtable for Google Cloud. Consider data size vs. latency requirements.</p>
                            </li>
                            <li>
                                <strong>Feature TTL Tuning</strong>
                                <p>Set aggressive TTLs for volatile features (1 hour for session data), 
                                longer for stable attributes (30 days for demographics).</p>
                            </li>
                            <li>
                                <strong>Materialization Strategy</strong>
                                <p>Incremental materialization for large datasets. 
                                Schedule during off-peak hours for batch updates.</p>
                            </li>
                            <li>
                                <strong>Embedding Caching</strong>
                                <p>Cache computed embeddings in the online store 
                                rather than computing on each request.</p>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- DATA SCIENTIST CONTEXT -->
                <div class="guide-content" id="guide-data-scientist" style="display: none;">
                    <div class="guide-hero" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <div class="guide-hero-icon">üìä</div>
                        <h2>Data Scientist Guide</h2>
                        <p>Explore available features, understand data lineage, and discover 
                        patterns for model features. Focus on feature engineering and experimentation.</p>
                    </div>

                    <div class="guide-section">
                        <div class="guide-title">Feature Discovery Workflow</div>
                        <div class="mermaid-container">
                            <pre class="mermaid">
    flowchart LR
        A[Search Features] --> B[View Lineage]
        B --> C[Check Statistics]
        C --> D[Request Access]
        D --> E[Experiment]
        E --> F[Register New Features]
        
        style A fill:#3b82f6,color:#fff
        style F fill:#10b981,color:#fff
                            </pre>
                        </div>
                    </div>

                    <div class="guide-section">
                        <div class="guide-title">Using the Search & Discovery Tools</div>
                        <div class="feature-discovery-grid">
                            <div class="discovery-card">
                                <div class="discovery-icon">üîç</div>
                                <h4>Global Search</h4>
                                <p>Search across feature names, descriptions, tags, and data sources. 
                                Use <kbd>Ctrl+F</kbd> to quickly find features by business context.</p>
                            </div>
                            <div class="discovery-card">
                                <div class="discovery-icon">üè∑Ô∏è</div>
                                <h4>Tag Filtering</h4>
                                <p>Browse features by tags like <code>#fraud</code>, <code>#recommendations</code>, 
                                or <code>#pii</code> to find relevant feature groups.</p>
                            </div>
                            <div class="discovery-card">
                                <div class="discovery-icon">üîó</div>
                                <h4>Lineage View</h4>
                                <p>Trace features back to source databases. Understand dependencies 
                                and upstream data quality issues.</p>
                            </div>
                            <div class="discovery-card">
                                <div class="discovery-icon">üìà</div>
                                <h4>Statistics Bar</h4>
                                <p>Click the stats bar to see repository overview. 
                                Check feature counts, data source coverage, and service utilization.</p>
                            </div>
                        </div>
                    </div>

                    <div class="guide-section">
                        <div class="guide-title">Exploring Feature Lineage</div>
                        <div class="mermaid-container">
                            <pre class="mermaid">
    flowchart TB
        subgraph Sources["Data Sources"]
            DB1[(User DB)]
            DB2[(Transaction DB)]
        end
        
        subgraph Entities["Entities"]
            E1[User]
            E2[Transaction]
        end
        
        subgraph Views["Feature Views"]
            F1[User Demographics]
            F2[User Behavior]
            F3[Transaction Stats]
        end
        
        subgraph Services["Services"]
            S1[Fraud Detection]
            S2[Recommendations]
        end
        
        DB1 --> E1
        DB2 --> E2
        E1 --> F1
        E1 --> F2
        E2 --> F3
        F1 --> S1
        F3 --> S1
        F1 --> S2
        F2 --> S2
        
        style S1 fill:#ef4444,color:#fff
        style S2 fill:#8b5cf6,color:#fff
                            </pre>
                        </div>
                        <p>Click any node in the diagram to see details. The side panel shows 
                        upstream dependencies (inputs) and downstream consumers (outputs).</p>
                    </div>

                    <div class="guide-section">
                        <div class="guide-title">Requesting Data Access</div>
                        <div class="access-flow">
                            <div class="access-step">
                                <div class="step-badge">1</div>
                                <p>Select a <strong>Data Source</strong> node</p>
                            </div>
                            <div class="access-arrow">‚Üí</div>
                            <div class="access-step">
                                <div class="step-badge">2</div>
                                <p>Review <strong>Access Process</strong> in side panel</p>
                            </div>
                            <div class="access-arrow">‚Üí</div>
                            <div class="access-step">
                                <div class="step-badge">3</div>
                                <p>Click <strong>Request Access</strong> button</p>
                            </div>
                            <div class="access-arrow">‚Üí</div>
                            <div class="access-step">
                                <div class="step-badge">4</div>
                                <p>Track in <strong>Django Admin</strong> panel</p>
                            </div>
                        </div>
                    </div>

                    <div class="guide-section">
                        <div class="guide-title">Experimentation with AI Assistant</div>
                        <p>Use the AI Assistant (<kbd>Ctrl+Shift+A</kbd>) to:</p>
                        <ul>
                            <li><strong>Generate Code:</strong> Auto-create feature definitions from descriptions</li>
                            <li><strong>Explain Lineage:</strong> Natural language explanation of data flow</li>
                            <li><strong>Suggest Features:</strong> Get recommendations based on your use case</li>
                            <li><strong>Validate Design:</strong> Check for common anti-patterns</li>
                        </ul>
                        <div class="code-block">
                            <pre>Example prompts:
    ‚Ä¢ "Create features for churn prediction using user activity"
    ‚Ä¢ "Explain the data lineage for the fraud detection service"
    ‚Ä¢ "What features are missing for a recommendation system?"
    ‚Ä¢ "Optimize these features for low-latency serving"</pre>
                        </div>
                    </div>
                </div>

                <!-- BACKEND API CONTEXT -->
                <div class="guide-content" id="guide-backend" style="display: none;">
                    <div class="guide-hero" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%);">
                        <div class="guide-hero-icon">üîß</div>
                        <h2>Backend API Reference</h2>
                        <p>Django REST Framework API with hash-based conflict detection, 
                        audit logging, and LLM integration. Designed for enterprise feature store management.</p>
                    </div>

                    <div class="guide-section">
                        <div class="guide-title">API Architecture</div>
                        <div class="mermaid-container">
                            <pre class="mermaid">
    flowchart TB
        subgraph Client["Client Layer"]
            UI[React/Vue UI]
            CLI[Python CLI]
            SDK[Feast SDK]
        end
        
        subgraph API["Django REST API"]
            AUTH[Authentication]
            RATE[Rate Limiting]
            VIEW[ViewSets]
            SERIAL[Serializers]
        end
        
        subgraph Services["Business Logic"]
            REPO[Repository Service]
            SYNC[Sync Service]
            LLM[LLM Client<br/>Groq Integration]
            AUDIT[Audit Logger]
        end
        
        subgraph Data["Data Layer"]
            PG[(PostgreSQL)]
            CACHE[(Redis Cache)]
            FS[(File Storage)]
        end
        
        UI -->|HTTP/JSON| AUTH
        CLI --> AUTH
        SDK --> AUTH
        AUTH --> RATE --> VIEW --> SERIAL
        VIEW --> REPO
        VIEW --> SYNC
        VIEW --> LLM
        REPO --> AUDIT
        REPO --> PG
        SYNC --> PG
        LLM -->|API| Groq[Groq API]
        
        style API fill:#3b82f6,color:#fff
        style Groq fill:#8b5cf6,color:#fff
                            </pre>
                        </div>
                    </div>

                    <div class="guide-section">
                        <div class="guide-title">Core Endpoints</div>
                        <div class="endpoint-list">
                            <div class="endpoint-item">
                                <div class="endpoint-method">GET/POST</div>
                                <div class="endpoint-path">/api/repositories/</div>
                                <div class="endpoint-desc">List or create feature repositories</div>
                            </div>
                            <div class="endpoint-item">
                                <div class="endpoint-method">GET/PUT/PATCH</div>
                                <div class="endpoint-path">/api/repositories/{id}/</div>
                                <div class="endpoint-desc">Retrieve or update repository with hash conflict detection</div>
                            </div>
                            <div class="endpoint-item">
                                <div class="endpoint-method">POST</div>
                                <div class="endpoint-path">/api/repositories/{id}/sync_datasources/</div>
                                <div class="endpoint-desc">Sync data sources with architecture JSON</div>
                            </div>
                            <div class="endpoint-item">
                                <div class="endpoint-method">POST</div>
                                <div class="endpoint-path">/api/repositories/{id}/export_json/</div>
                                <div class="endpoint-desc">Export repository with hash verification</div>
                            </div>
                            <div class="endpoint-item">
                                <div class="endpoint-method">POST</div>
                                <div class="endpoint-path">/api/repositories/import_json/</div>
                                <div class="endpoint-desc">Import from JSON with duplicate detection</div>
                            </div>
                            <div class="endpoint-item">
                                <div class="endpoint-method">GET/POST</div>
                                <div class="endpoint-path">/api/datasources/</div>
                                <div class="endpoint-desc">Manage data sources with filtering by kind/repo</div>
                            </div>
                            <div class="endpoint-item">
                                <div class="endpoint-method">GET/POST</div>
                                <div class="endpoint-path">/api/entities/</div>
                                <div class="endpoint-desc">Entity definitions with repository scoping</div>
                            </div>
                            <div class="endpoint-item">
                                <div class="endpoint-method">GET</div>
                                <div class="endpoint-path">/api/audit-logs/</div>
                                <div class="endpoint-desc">Read-only audit trail with filtering</div>
                            </div>
                            <div class="endpoint-item">
                                <div class="endpoint-method">POST</div>
                                <div class="endpoint-path">/api/chats/</div>
                                <div class="endpoint-desc">Create LLM chat session with initial message</div>
                            </div>
                            <div class="endpoint-item">
                                <div class="endpoint-method">POST</div>
                                <div class="endpoint-path">/api/chats/{id}/send_message/</div>
                                <div class="endpoint-desc">Send message to existing chat session</div>
                            </div>
                        </div>
                    </div>

                    <div class="guide-section">
                        <div class="guide-title">Conflict Detection & Resolution</div>
                        <div class="conflict-flow">
                            <div class="mermaid-container">
                                <pre class="mermaid">
    sequenceDiagram
        participant Client
        participant API
        participant DB
        
        Client->>Client: Compute MD5 hash of JSON
        Client->>API: PUT /repositories/123/ with client_hash
        API->>DB: Fetch current hash
        DB-->>API: server_hash
        
        alt Hash Match
            API->>DB: Update repository
            DB-->>API: Success
            API-->>Client: 200 OK
        else Hash Mismatch (Conflict)
            API-->>Client: 409 Conflict
            Note right of Client: Options:<br/>1. Fetch latest (GET)<br/>2. Force update (POST /force_update/)<br/>3. Merge changes manually
        end
                                </pre>
                            </div>
                        </div>
                        <p>Hash-based optimistic locking prevents accidental overwrites. 
                        Each repository stores an MD5 hash of its architecture JSON. 
                        Updates include the client's hash; mismatches return 409 Conflict with resolution options.</p>
                    </div>

                    <div class="guide-section">
                        <div class="guide-title">Django Models</div>
                        <div class="model-hierarchy">
                            <div class="model-card primary">
                                <h4>FeastRepository</h4>
                                <p>Core container with architecture_json, json_hash, settings</p>
                            </div>
                            <div class="model-children">
                                <div class="model-card">
                                    <h4>DataSource</h4>
                                    <p>30+ DB types, Debezium support, column_security</p>
                                </div>
                                <div class="model-card">
                                    <h4>Entity</h4>
                                    <p>Join keys, descriptions, canvas positions</p>
                                </div>
                                <div class="model-card">
                                    <h4>LLMChatSession</h4>
                                    <p>Context snapshot, message history</p>
                                </div>
                            </div>
                            <div class="model-card secondary">
                                <h4>AuditLog</h4>
                                <p>Immutable record of all changes with user/IP tracking</p>
                            </div>
                        </div>
                    </div>

                    <div class="guide-section">
                        <div class="guide-title">LLM Integration (Groq)</div>
                        <div class="llm-architecture">
                            <div class="mermaid-container">
                                <pre class="mermaid">
    flowchart LR
        A[User Query] --> B[Context Builder]
        B --> C[Prompt Engineering]
        C --> D[Groq API<br/>llama-3.1-70b]
        D --> E[Response Parser]
        E --> F[Save to DB]
        F --> G[Stream to Client]
        
        B -.->|Repo Context| H[(FeastRepository)]
        
        style D fill:#8b5cf6,color:#fff
                            </pre>
                            </div>
                        </div>
                        <p>Async LLM queries with token usage tracking. Supports streaming responses 
                        and context-aware prompts based on repository state.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Flow Modal -->
    <div class="modal-overlay" id="dataFlowModal">
        <div class="modal modal-xl">
            <div class="modal-header">
                <div class="modal-title">üåä Data Source Architecture</div>
                <button class="modal-close" onclick="document.getElementById('dataFlowModal').classList.remove('active')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="guide-section">
                    <div class="guide-title">Complete Data Flow</div>
                    <p class="guide-text">Visual guide showing data journey from source to feature store:</p>
                </div>

                <div id="dataFlowStages">
                    <!-- Stages populated by JS -->
                </div>

                <div class="guide-section" style="margin-top: 24px;">
                    <div class="guide-title">Connection Health</div>
                    <div class="detail-card">
                        <div class="detail-row">
                            <span class="detail-label">Debezium Connector</span>
                            <span class="status-indicator status-healthy">
                                <span class="status-green" style="width: 8px; height: 8px; border-radius: 50%; display: inline-block;"></span>
                                Healthy
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Kafka Topic</span>
                            <span class="status-indicator status-healthy">
                                <span class="status-green" style="width: 8px; height: 8px; border-radius: 50%; display: inline-block;"></span>
                                Healthy
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Spark Streaming</span>
                            <span class="status-indicator status-warning">
                                <span class="status-yellow" style="width: 8px; height: 8px; border-radius: 50%; display: inline-block;"></span>
                                High Latency
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Postgres Store</span>
                            <span class="status-indicator status-healthy">
                                <span class="status-green" style="width: 8px; height: 8px; border-radius: 50%; display: inline-block;"></span>
                                Healthy
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Selector Modal -->
    <div class="modal-overlay" id="userSelectorModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <div class="modal-title">üë§ Switch User Context</div>
                <button class="modal-close" onclick="document.getElementById('userSelectorModal').classList.remove('active')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select User</label>
                    <select class="form-select" id="userSelect" onchange="diagram.switchUser()">
                        <option value="john">John Doe (Data Engineer)</option>
                        <option value="jane">Jane Smith (Data Scientist)</option>
                        <option value="bob">Bob Johnson (Platform Admin)</option>
                        <option value="alice">Alice Chen (ML Engineer)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Team</label>
                    <select class="form-select" id="teamSelect">
                        <option>Data Engineering</option>
                        <option>Machine Learning</option>
                        <option>Platform</option>
                        <option>Analytics</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select class="form-select" id="roleSelect">
                        <option>Feature Developer</option>
                        <option>Feature Consumer</option>
                        <option>Admin</option>
                        <option>Viewer</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="document.getElementById('userSelectorModal').classList.remove('active')">Cancel</button>
                <button class="btn btn-primary" onclick="diagram.applyUserContext()">Apply Context</button>
            </div>
        </div>
    </div>

    <!-- Push Repository Modal -->
    <div class="modal-overlay" id="pushRepoModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title" id="pushModalTitle">Push Repository</div>
                <button class="modal-close" onclick="diagram.closePushModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div id="pushModalMessage"></div>
                <div class="status-bar" style="margin-top: 20px;">
                    <div id="pushProgress" class="progress-bar" style="width: 0%; height: 4px; background: var(--feast-orange); transition: width 0.3s;"></div>
                </div>
                <div id="pushStatus" style="margin-top: 12px; font-size: 13px; color: var(--text-secondary);"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="diagram.closePushModal()">Close</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        <div class="notification-icon" id="notifIcon">‚úÖ</div>
        <div class="notification-content">
            <div class="notification-title" id="notifTitle">Success</div>
            <div class="notification-text" id="notifText">Operation completed successfully</div>
        </div>
    </div>

    <!-- Passing Django context to JavaScript -->
    <script>
        // Django template variables available to JavaScript
        window.DJANGO_CONTEXT = {
            repoId: {{ repo_id|default:"null" }},
            repoName: "{{ repo_name|default:''|escapejs }}",
            repoError: "{{ repo_error|default:''|escapejs }}",
            apiBaseUrl: "{{ api_base_url }}",
            user: {
                id: {{ user.id }},
                username: "{{ user.username|escapejs }}",
                email: "{{ user.email|escapejs }}",
                firstName: "{{ user.first_name|escapejs }}",
                lastName: "{{ user.last_name|escapejs }}"
            },
            csrfToken: "{{ csrf_token }}"
        };
    </script>

    <script>
        class FeastDiagram {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.container = this.canvas.parentElement;
                
                // Using Django context or fall back to URL parsing
                const djangoContext = window.DJANGO_CONTEXT || {};
                this.apiBaseUrl = djangoContext.apiBaseUrl || '/api';
                this.repoId = djangoContext.repoId || this.getRepoIdFromUrl();

                // Initialising user from Django
                if (djangoContext.user) {
                    this.currentUser = {
                        id: djangoContext.user.id,
                        name: `${djangoContext.user.firstName} ${djangoContext.user.lastName}`.trim() || djangoContext.user.username,
                        initials: (djangoContext.user.firstName?.[0] || djangoContext.user.username[0]).toUpperCase(),
                        role: 'Data Engineer',
                        team: 'Data Engineering'
                    };
                    this.updateUserDisplay();
                }
                
                // Check for repo error from Django
                if (djangoContext.repoError) {
                    this.showNotification('Error', djangoContext.repoError);
                }
                
                this.nodes = new Map();
                this.edges = [];
                this.selectedNode = null;
                this.hoveredNode = null;
                
                // Load repo settings from backend or use defaults
                this.repoSettings = {
                    name: 'enterprise_feature_store',
                    location: '/opt/feast/feature_repo',
                    defaultOwner: 'Data Platform Team',
                    id: this.repoId,
                    description: ''
                };

                this.currentChatSession = null;  // Track active LLM session

                this.selectedNode = null;
                this.hoveredNode = null;
                
                this.repoSettings = {
                    name: 'enterprise_feature_store',
                    location: '/opt/feast/feature_repo',
                    defaultOwner: 'Data Platform Team',
		            id: 1, // null
                    description: 'Enterprise feature store powering machine learning across personalization, fraud detection, and search ranking use cases. The repository defines 8 data sources (PostgreSQL, MongoDB, Kafka, Snowflake, DynamoDB, Redis, S3, Neo4j), 5 entities (user, session, product, merchant, device), 10 feature views (6 batch, 3 streaming, 1 on-demand), and 5 feature services. It manages 75+ features with TTLs ranging from 1 hour to 30 days. Owned by the Data Platform team with contributions from fraud, search, and growth teams. Online store uses Redis with 99.99% availability; offline store is Snowflake with daily materialization. Supports both real-time inference (50ms p99 latency) and batch training pipelines. Implements column-level security (PII masking) and row-level access controls via integration with Django auth. Debezium CDC streams from transactional databases into Kafka, processed by Spark structured streaming. The architecture is designed for 100k QPS at peak with horizontal scaling.'
                };
                
                this.searchSettings = {
                    descriptions: true,
                    tags: true,
                    usedBy: true,
                    access: true
                };
                
                this.currentUser = {
                    id: 'john',
                    name: 'John Doe',
                    initials: 'JD',
                    role: 'Data Engineer',
                    team: 'Data Engineering'
                };
                
                this.scale = 1;
                this.offsetX = 50;
                this.offsetY = 50;
                this.isDragging = false;
                this.isPanning = false;
                this.draggedNode = null;
                this.panStart = { x: 0, y: 0 };
                this.lastMouse = { x: 0, y: 0 };
                
                this.visibleLayers = {
                    datasource: true,
                    entity: true,
                    featureview: true,
                    service: true
                };
                
                this.counters = {
                    datasource: 0,
                    entity: 0,
                    featureview: 0,
                    service: 0
                };
                
                this.config = {
                    colors: {
                        datasource: { bg: '#3b82f6', light: '#60a5fa', icon: 'üóÑÔ∏è', label: 'Data Source' },
                        entity: { bg: '#8b5cf6', light: '#a78bfa', icon: 'üë§', label: 'Entity' },
                        featureview: { bg: '#10b981', light: '#34d399', icon: 'üìä', label: 'Feature View' },
                        service: { bg: '#f97316', light: '#fb923c', icon: 'üöÄ', label: 'Feature Service' }
                    },
                    nodeWidth: 200,
                    nodeHeight: 100,
                    portRadius: 6,
                    miniMapEnabled: true
                };
                
                // Comprehensive database support
                this.databaseTypes = {
                    // Relational
                    postgres: { 
                        name: 'PostgreSQL', 
                        category: 'Relational',
                        debezium: true,
                        icon: 'üêò',
                        defaultProcess: 'Submit DBA ticket for read replica access',
                        sparkPattern: 'JDBC batch read with partition column'
                    },
                    mysql: { 
                        name: 'MySQL', 
                        category: 'Relational',
                        debezium: true,
                        icon: 'üê¨',
                        defaultProcess: 'Request via MySQL Workbench access form',
                        sparkPattern: 'JDBC connector with predicate pushdown'
                    },
                    sqlserver: { 
                        name: 'SQL Server', 
                        category: 'Relational',
                        debezium: true,
                        icon: 'üóÉÔ∏è',
                        defaultProcess: 'AD group membership request',
                        sparkPattern: 'MS JDBC driver with bulk copy'
                    },
                    oracle: { 
                        name: 'Oracle', 
                        category: 'Relational',
                        debezium: true,
                        icon: 'üèõÔ∏è',
                        defaultProcess: 'DBA approval required, VPN only',
                        sparkPattern: 'OCI driver with connection pooling'
                    },
                    sqlite: { 
                        name: 'SQLite', 
                        category: 'Relational',
                        debezium: false,
                        icon: 'ü™∂',
                        defaultProcess: 'File system access request',
                        sparkPattern: 'Direct file read via Spark'
                    },
                    // NoSQL
                    mongodb: { 
                        name: 'MongoDB', 
                        category: 'NoSQL',
                        debezium: true,
                        icon: 'üçÉ',
                        defaultProcess: 'MongoDB Atlas invitation',
                        sparkPattern: 'MongoDB Spark connector with aggregation pipeline'
                    },
                    dynamodb: { 
                        name: 'DynamoDB', 
                        category: 'NoSQL',
                        debezium: false,
                        icon: '‚ö°',
                        defaultProcess: 'IAM policy update via ServiceNow',
                        sparkPattern: 'DynamoDB Export to S3 + Spark read'
                    },
                    cassandra: { 
                        name: 'Cassandra', 
                        category: 'NoSQL',
                        debezium: true,
                        icon: 'üî±',
                        defaultProcess: 'CQL role grant by DBA team',
                        sparkPattern: 'Spark Cassandra connector with token range scan'
                    },
                    couchbase: { 
                        name: 'Couchbase', 
                        category: 'NoSQL',
                        debezium: true,
                        icon: 'üõãÔ∏è',
                        defaultProcess: 'Bucket access request',
                        sparkPattern: 'Couchbase Spark connector'
                    },
                    elasticsearch: { 
                        name: 'Elasticsearch', 
                        category: 'NoSQL',
                        debezium: true,
                        icon: 'üîç',
                        defaultProcess: 'Kibana role assignment',
                        sparkPattern: 'ES-Hadoop connector with scroll API'
                    },
                    // Cloud Warehouses
                    snowflake: { 
                        name: 'Snowflake', 
                        category: 'Cloud Warehouse',
                        debezium: false,
                        icon: '‚ùÑÔ∏è',
                        defaultProcess: 'Role grant via Snowflake UI',
                        sparkPattern: 'Snowflake Spark connector with external stages'
                    },
                    bigquery: { 
                        name: 'BigQuery', 
                        category: 'Cloud Warehouse',
                        debezium: false,
                        icon: 'üìä',
                        defaultProcess: 'IAM BigQuery Data Viewer role',
                        sparkPattern: 'BigQuery Storage API + Spark'
                    },
                    redshift: { 
                        name: 'Redshift', 
                        category: 'Cloud Warehouse',
                        debezium: true,
                        icon: 'üî∫',
                        defaultProcess: 'Security group + user creation',
                        sparkPattern: 'Redshift JDBC with UNLOAD to S3'
                    },
                    databricks: { 
                        name: 'Databricks Delta Lake', 
                        category: 'Cloud Warehouse',
                        debezium: false,
                        icon: 'üß±',
                        defaultProcess: 'Unity Catalog grant',
                        sparkPattern: 'Native Delta Lake read'
                    },
                    synapse: { 
                        name: 'Azure Synapse', 
                        category: 'Cloud Warehouse',
                        debezium: false,
                        icon: 'üî∑',
                        defaultProcess: 'Azure AD + Synapse workspace access',
                        sparkPattern: 'Synapse Spark pool with dedicated SQL pool'
                    },
                    // Streaming
                    kafka: { 
                        name: 'Apache Kafka', 
                        category: 'Streaming',
                        debezium: false,
                        icon: 'üì®',
                        defaultProcess: 'Self-service via Kafka Manager',
                        sparkPattern: 'Spark Structured Streaming with Kafka source'
                    },
                    kinesis: { 
                        name: 'AWS Kinesis', 
                        category: 'Streaming',
                        debezium: false,
                        icon: 'üíß',
                        defaultProcess: 'IAM role for Kinesis read',
                        sparkPattern: 'Kinesis Client Library + Spark'
                    },
                    pulsar: { 
                        name: 'Apache Pulsar', 
                        category: 'Streaming',
                        debezium: true,
                        icon: '‚≠ê',
                        defaultProcess: 'Pulsar tenant admin request',
                        sparkPattern: 'Pulsar Spark connector'
                    },
                    eventhubs: { 
                        name: 'Azure Event Hubs', 
                        category: 'Streaming',
                        debezium: true,
                        icon: 'üéØ',
                        defaultProcess: 'Event Hubs Data Receiver role',
                        sparkPattern: 'Azure Event Hubs connector for Spark'
                    },
                    // Object Storage
                    s3: { 
                        name: 'Amazon S3 (Parquet)', 
                        category: 'Object Storage',
                        debezium: false,
                        icon: 'ü™£',
                        defaultProcess: 'S3 bucket policy update',
                        sparkPattern: 'S3A filesystem with Parquet reader'
                    },
                    gcs: { 
                        name: 'Google Cloud Storage', 
                        category: 'Object Storage',
                        debezium: false,
                        icon: '‚òÅÔ∏è',
                        defaultProcess: 'GCS bucket IAM binding',
                        sparkPattern: 'GCS connector with Parquet'
                    },
                    azureblob: { 
                        name: 'Azure Blob Storage', 
                        category: 'Object Storage',
                        debezium: false,
                        icon: 'üîµ',
                        defaultProcess: 'Storage Blob Data Reader role',
                        sparkPattern: 'Azure Blob File System (ABFS)'
                    },
                    minio: { 
                        name: 'MinIO', 
                        category: 'Object Storage',
                        debezium: false,
                        icon: 'ü™£',
                        defaultProcess: 'MinIO policy assignment',
                        sparkPattern: 'S3A compatible API'
                    },
                    // In-Memory
                    redis: { 
                        name: 'Redis', 
                        category: 'In-Memory',
                        debezium: false,
                        icon: 'üî¥',
                        defaultProcess: 'Redis ACL set via config',
                        sparkPattern: 'Redis Spark connector for batch'
                    },
                    memcached: { 
                        name: 'Memcached', 
                        category: 'In-Memory',
                        debezium: false,
                        icon: 'üß†',
                        defaultProcess: 'Security group ingress rule',
                        sparkPattern: 'Custom Spark input format'
                    },
                    dragonfly: { 
                        name: 'Dragonfly', 
                        category: 'In-Memory',
                        debezium: false,
                        icon: 'üêâ',
                        defaultProcess: 'Dragonfly ACL configuration',
                        sparkPattern: 'Redis-compatible connector'
                    },
                    // Graph
                    neo4j: { 
                        name: 'Neo4j', 
                        category: 'Graph',
                        debezium: true,
                        icon: 'üï∏Ô∏è',
                        defaultProcess: 'Neo4j role assignment',
                        sparkPattern: 'Neo4j Spark connector with APOC'
                    },
                    neptune: { 
                        name: 'Amazon Neptune', 
                        category: 'Graph',
                        debezium: false,
                        icon: 'üåä',
                        defaultProcess: 'VPC security group + IAM auth',
                        sparkPattern: 'Gremlin Spark integration'
                    },
                    // Time-Series
                    influxdb: { 
                        name: 'InfluxDB', 
                        category: 'Time-Series',
                        debezium: false,
                        icon: 'üìà',
                        defaultProcess: 'InfluxDB token generation',
                        sparkPattern: 'InfluxDB Spark connector'
                    },
                    timescaledb: { 
                        name: 'TimescaleDB', 
                        category: 'Time-Series',
                        debezium: true,
                        icon: '‚è±Ô∏è',
                        defaultProcess: 'PostgreSQL access (Timescale extension)',
                        sparkPattern: 'PostgreSQL JDBC with time_bucket'
                    },
                    clickhouse: { 
                        name: 'ClickHouse', 
                        category: 'Time-Series',
                        debezium: true,
                        icon: 'üñ±Ô∏è',
                        defaultProcess: 'ClickHouse user creation',
                        sparkPattern: 'ClickHouse Native JDBC + Spark'
                    },
                    // Others
                    couchdb: { 
                        name: 'CouchDB', 
                        category: 'Document',
                        debezium: true,
                        icon: 'üõãÔ∏è',
                        defaultProcess: 'CouchDB _security object update',
                        sparkPattern: 'CouchDB Spark connector with _changes feed'
                    },
                    rethinkdb: { 
                        name: 'RethinkDB', 
                        category: 'Document',
                        debezium: false,
                        icon: 'ü§î',
                        defaultProcess: 'RethinkDB user grant',
                        sparkPattern: 'Custom Spark source with changefeeds'
                    },
                    firebase: { 
                        name: 'Firebase', 
                        category: 'Mobile/Realtime',
                        debezium: false,
                        icon: 'üî•',
                        defaultProcess: 'Firebase Admin SDK service account',
                        sparkPattern: 'Firebase to BigQuery export + Spark'
                    },
                    supabase: { 
                        name: 'Supabase', 
                        category: 'Backend-as-a-Service',
                        debezium: true,
                        icon: '‚ö°',
                        defaultProcess: 'Supabase RLS policy + service role',
                        sparkPattern: 'PostgreSQL JDBC (Supabase is Postgres)'
                    }
                };
                
                this.currentModalType = null;
                this.tempFeatures = [];
                this.tempTags = [];
                this.editingNode = null;
                this.editingUsage = null;
                
                this.theme = 'dark';
                this.codeEditorOpen = false;
                this.edgeManagerOpen = false;
                this.llmPanelOpen = false;
                this.djangoPanelOpen = false;
                this.currentCodeFile = 'entities.py';
                
                this.init();
            }

            
            updateUserDisplay() {
                document.getElementById('userAvatar').textContent = this.currentUser.initials;
                document.getElementById('userName').textContent = this.currentUser.name;
                document.getElementById('userRole').textContent = this.currentUser.role;
            }

            // Use Django's CSRF token
            getCsrfToken() {
                // First try from Django context
                const djangoContext = window.DJANGO_CONTEXT || {};
                if (djangoContext.csrfToken) {
                    return djangoContext.csrfToken;
                }
                // Fallback to cookie parsing
                const name = 'csrftoken';
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                // Final fallback to meta tag
                if (!cookieValue) {
                    const meta = document.querySelector('meta[name="csrf-token"]');
                    if (meta) {
                        cookieValue = meta.getAttribute('content');
                    }
                }
                return cookieValue;
            }
            
            getRepoIdFromUrl() {
                const params = new URLSearchParams(window.location.search);
                const repoId = params.get('repo_id');
                return repoId ? parseInt(repoId) : null;
            }
            
            init() {
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.bindEvents();
                this.animate();
                this.setupMiniMap();
                this.updateStats();
                this.updateRepoSubtitle();
                
                this.setupSearch();
                this.setupKeyboardShortcuts();
                
                // Load from backend if repo_id provided, else load example
                if (this.repoId) {
                    this.loadFromBackend();
                } else {
                    this.loadComplexExample();
                    setTimeout(() => this.animateFit(), 1000);
                }

                // Warn about unsaved changes when leaving
                window.addEventListener('beforeunload', (e) => {
                    // You could track dirty state here
                    // For now, just we warn if we have a repo ID (implying we should save)
                    if (this.repoId && this.nodes.size > 0) {
                        e.preventDefault();
                        e.returnValue = '';
                    }
                });
            }
            
            // ADD THESE NEW METHODS after init()
            
            async loadFromBackend() {
                try {
                    this.showNotification('Loading', 'Fetching repository from server...');
                    const response = await fetch(`${this.apiBaseUrl}/repositories/${this.repoId}/`);
                    
                    if (!response.ok) {
                        if (response.status === 404) {
                            this.showNotification('Error', 'Repository not found');
                            this.loadComplexExample();
                            return;
                        }
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Update repo settings from backend
                    this.repoSettings = {
                        name: data.name,
                        location: data.location,
                        defaultOwner: data.default_owner,
                        id: data.id,
                        description: data.description || ''
                    };
                    this.updateRepoSubtitle();
                    
                    // Load architecture JSON
                    if (data.architecture_json && Object.keys(data.architecture_json).length > 0) {
                        this.importFromJSON(data.architecture_json);
                    } else {
                        // Empty repo - start fresh
                        this.nodes.clear();
                        this.edges = [];
                    }
                    
                    // Load data sources as nodes if not in architecture_json
                    if (data.data_sources && this.nodes.size === 0) {
                        data.data_sources.forEach(ds => this.addDataSourceFromBackend(ds));
                    }
                    
                    // Load entities as nodes if not in architecture_json
                    if (data.entities && this.nodes.size === 0) {
                        data.entities.forEach(ent => this.addEntityFromBackend(ent));
                    }
                    
                    this.updateStats();
                    this.showNotification('Loaded', `Repository "${data.name}" loaded`);
                    setTimeout(() => this.animateFit(), 500);
                    
                } catch (error) {
                    console.error('Failed to load from backend:', error);
                    this.showNotification('Error', 'Failed to load repository. Using example data.');
                    this.loadComplexExample();
                }
            }
            
            addDataSourceFromBackend(ds) {
                const id = `source_${++this.counters.datasource}`;
                const dbType = this.databaseTypes[ds.kind] || { 
                    name: ds.kind, 
                    debezium: false,
                    defaultProcess: ds.access_process || 'Contact data platform team',
                    sparkPattern: 'Custom connector'
                };
                
                const node = {
                    id,
                    type: 'datasource',
                    name: ds.name,
                    kind: ds.kind,
                    dbType: dbType,
                    description: ds.description || '',
                    tags: ds.tags || [],
                    ownedBy: ds.owned_by || this.repoSettings.defaultOwner,
                    accessProcess: ds.access_process || '',
                    details: {
                        connection: ds.connection_string || '',
                        topic: ds.topic || '',
                        notes: ''
                    },
                    x: ds.pos_x || 100,
                    y: ds.pos_y || 100,
                    inputs: [],
                    outputs: [],
                    createdAt: ds.created_at,
                    debeziumAvailable: ds.debezium_supported,
                    sparkPattern: dbType.sparkPattern,
                    columnSecurity: ds.column_security || this.generateDefaultColumnSecurity()
                };
                this.nodes.set(id, node);
                return id;
            }
            
            addEntityFromBackend(ent) {
                const id = `entity_${++this.counters.entity}`;
                const node = {
                    id,
                    type: 'entity',
                    name: ent.name,
                    joinKey: ent.join_key || 'id',
                    description: ent.description || '',
                    tags: ent.tags || [],
                    details: {},
                    x: ent.pos_x || 100,
                    y: ent.pos_y || 100,
                    inputs: [],
                    outputs: [],
                    createdAt: ent.created_at
                };
                this.nodes.set(id, node);
                return id;
            }
            
            importFromJSON(arch) {
                if (!arch) return;
                
                // Clear existing
                this.nodes.clear();
                this.edges = [];
                
                // Import nodes
                if (arch.nodes) {
                    // Handle both Map-like object and array formats
                    const nodeEntries = Array.isArray(arch.nodes) ? arch.nodes : Object.entries(arch.nodes);
                    nodeEntries.forEach(([id, node]) => {
                        this.nodes.set(id, node);
                        // Update counters to avoid ID collisions
                        const type = node.type;
                        if (this.counters[type] !== undefined) {
                            const num = parseInt(id.split('_').pop()) || 0;
                            if (num > this.counters[type]) {
                                this.counters[type] = num;
                            }
                        }
                    });
                }
                
                // Import edges
                if (arch.edges) {
                    this.edges = arch.edges.filter(edge => {
                        return this.nodes.has(edge.from) && this.nodes.has(edge.to);
                    });
                    
                    // Rebuild inputs/outputs
                    this.nodes.forEach(node => {
                        node.inputs = [];
                        node.outputs = [];
                    });
                    this.edges.forEach(edge => {
                        const fromNode = this.nodes.get(edge.from);
                        const toNode = this.nodes.get(edge.to);
                        if (fromNode && toNode) {
                            fromNode.outputs.push(edge.to);
                            toNode.inputs.push(edge.from);
                        }
                    });
                }
                
                this.updateStats();
            }
            
            exportToJSON() {
                return {
                    nodes: Array.from(this.nodes.entries()),
                    edges: this.edges,
                    exportDate: new Date().toISOString(),
                    version: '3.0'
                };
            }

            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    if ((e.metaKey || e.ctrlKey) && e.shiftKey) {
                        if (e.key === 'A') {
                            e.preventDefault();
                            this.toggleLLMHelper();
                        } else if (e.key === 'D') {
                            e.preventDefault();
                            this.toggleDjangoAdmin();
                        }
                    }
                });
            }

            animateFit() {
                if (this.nodes.size === 0) return;
                
                const bounds = this.getBounds();
                const padding = 100;
                
                const targetScale = Math.min(
                    (this.width - padding * 2) / bounds.width,
                    (this.height - padding * 2) / bounds.height,
                    1.5
                );
                
                const targetOffsetX = (this.width - bounds.width * targetScale) / 2 - bounds.minX * targetScale;
                const targetOffsetY = (this.height - bounds.height * targetScale) / 2 - bounds.minY * targetScale;
                
                const startScale = this.scale;
                const startOffsetX = this.offsetX;
                const startOffsetY = this.offsetY;
                
                const duration = 500;
                const startTime = Date.now();
                
                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const eased = 1 - Math.pow(1 - progress, 3);
                    
                    this.scale = startScale + (targetScale - startScale) * eased;
                    this.offsetX = startOffsetX + (targetOffsetX - startOffsetX) * eased;
                    this.offsetY = startOffsetY + (targetOffsetY - startOffsetY) * eased;
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    }
                };
                
                animate();
            }
            
            setupSearch() {
                const searchInput = document.getElementById('searchInput');
                const searchDropdown = document.getElementById('searchDropdown');
                
                searchInput.addEventListener('input', (e) => this.handleSearch(e));
                searchInput.addEventListener('focus', (e) => {
                    if (searchInput.value.trim().length > 0) {
                        this.handleSearch(e);
                    }
                });
                
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.search-box')) {
                        searchDropdown.classList.remove('active');
                    }
                });
                
                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        searchDropdown.classList.remove('active');
                        searchInput.blur();
                    }
                });
            }
            
            handleSearch(e) {
                const query = e.target.value.toLowerCase().trim();
                const searchDropdown = document.getElementById('searchDropdown');
                const searchDropdownContent = document.getElementById('searchDropdownContent');
                
                if (!query) {
                    searchDropdown.classList.remove('active');
                    return;
                }
                
                const results = this.performSearch(query);
                
                if (results.length === 0) {
                    searchDropdownContent.innerHTML = '<div class="search-no-results">No results found</div>';
                } else {
                    searchDropdownContent.innerHTML = this.renderSearchResults(results, query);
                }
                
                searchDropdown.classList.add('active');
            }
            
            performSearch(query) {
                const results = [];
                
                this.nodes.forEach((node, id) => {
                    if (node.name.toLowerCase().includes(query)) {
                        results.push({
                            type: 'node',
                            nodeType: node.type,
                            id: id,
                            name: node.name,
                            matchType: 'name',
                            matchText: node.name
                        });
                    }
                    
                    if (this.searchSettings.descriptions && node.description && 
                        node.description.toLowerCase().includes(query)) {
                        results.push({
                            type: 'node',
                            nodeType: node.type,
                            id: id,
                            name: node.name,
                            matchType: 'description',
                            matchText: node.description
                        });
                    }
                    
                    if (this.searchSettings.tags && node.tags) {
                        node.tags.forEach(tag => {
                            if (tag.toLowerCase().includes(query)) {
                                results.push({
                                    type: 'node',
                                    nodeType: node.type,
                                    id: id,
                                    name: node.name,
                                    matchType: 'tag',
                                    matchText: tag
                                });
                            }
                        });
                    }
                    
                    if (node.type === 'featureview' && node.features) {
                        node.features.forEach(feature => {
                            const featureName = typeof feature === 'string' ? feature : feature.name;
                            if (featureName.toLowerCase().includes(query)) {
                                results.push({
                                    type: 'feature',
                                    nodeType: 'feature',
                                    id: id,
                                    name: featureName,
                                    parentName: node.name,
                                    matchType: 'feature',
                                    matchText: featureName,
                                    dataType: typeof feature === 'string' ? 'Unknown' : feature.type
                                });
                            }
                        });
                    }
                    
                    if (this.searchSettings.usedBy && node.details.usedBy) {
                        node.details.usedBy.forEach(app => {
                            const appName = typeof app === 'string' ? app : app.name;
                            if (appName.toLowerCase().includes(query)) {
                                results.push({
                                    type: 'app',
                                    nodeType: 'app',
                                    id: id,
                                    name: appName,
                                    parentName: node.name,
                                    matchType: 'usedBy',
                                    matchText: appName
                                });
                            }
                        });
                    }
                    
                    if (this.searchSettings.access && node.accessProcess && 
                        node.accessProcess.toLowerCase().includes(query)) {
                        results.push({
                            type: 'node',
                            nodeType: node.type,
                            id: id,
                            name: node.name,
                            matchType: 'access',
                            matchText: node.accessProcess
                        });
                    }
                });
                
                return this.groupSearchResults(results);
            }
            
            groupSearchResults(results) {
                const grouped = {
                    featureview: [],
                    feature: [],
                    entity: [],
                    service: [],
                    datasource: []
                };
                
                results.forEach(result => {
                    if (result.nodeType === 'featureview') {
                        if (grouped.featureview.length < 5) grouped.featureview.push(result);
                    } else if (result.nodeType === 'feature') {
                        if (grouped.feature.length < 5) grouped.feature.push(result);
                    } else if (result.nodeType === 'entity') {
                        if (grouped.entity.length < 5) grouped.entity.push(result);
                    } else if (result.nodeType === 'service') {
                        if (grouped.service.length < 5) grouped.service.push(result);
                    } else if (result.nodeType === 'datasource') {
                        if (grouped.datasource.length < 5) grouped.datasource.push(result);
                    }
                });
                
                return grouped;
            }
            
            renderSearchResults(grouped, query) {
                let html = '';
                
                const categories = [
                    { key: 'featureview', label: 'Feature Views', icon: 'üìä', color: '#10b981' },
                    { key: 'feature', label: 'Features', icon: '‚ö°', color: '#06b6d4' },
                    { key: 'entity', label: 'Entities', icon: 'üë§', color: '#8b5cf6' },
                    { key: 'service', label: 'Services', icon: 'üöÄ', color: '#f97316' },
                    { key: 'datasource', label: 'Data Sources', icon: 'üóÑÔ∏è', color: '#3b82f6' }
                ];
                
                categories.forEach(cat => {
                    const items = grouped[cat.key];
                    if (items && items.length > 0) {
                        html += `
                            <div class="search-category">
                                <div class="search-category-header">
                                    <span class="search-category-icon">${cat.icon}</span>
                                    <span>${cat.label}</span>
                                </div>
                        `;
                        
                        items.forEach(item => {
                            const highlightedName = this.highlightText(item.name, query);
                            const metaText = this.getSearchResultMeta(item);
                            
                            html += `
                                <div class="search-result-item" onclick="diagram.selectSearchResult('${item.id}', '${item.type}')">
                                    <div class="search-result-icon" style="background: ${cat.color}20; color: ${cat.color};">
                                        ${cat.icon}
                                    </div>
                                    <div class="search-result-info">
                                        <div class="search-result-name">${highlightedName}</div>
                                        <div class="search-result-meta">${metaText}</div>
                                    </div>
                                    ${item.matchType !== 'name' ? `<span class="search-result-badge">${item.matchType}</span>` : ''}
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                    }
                });
                
                return html;
            }
            
            highlightText(text, query) {
                if (!query) return text;
                const regex = new RegExp(`(${this.escapeRegex(query)})`, 'gi');
                return text.replace(regex, '<span class="search-highlight">$1</span>');
            }
            
            escapeRegex(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }
            
            getSearchResultMeta(item) {
                if (item.type === 'feature') {
                    return `in ${item.parentName} ‚Ä¢ ${item.dataType || 'Feature'}`;
                } else if (item.type === 'app') {
                    return `uses ${item.parentName}`;
                } else if (item.matchType === 'description') {
                    return 'matches description';
                } else if (item.matchType === 'tag') {
                    return `tag: #${item.matchText}`;
                } else if (item.matchType === 'access') {
                    return 'matches access process';
                }
                return this.config.colors[item.nodeType]?.label || '';
            }
            
            selectSearchResult(id, type) {
                document.getElementById('searchDropdown').classList.remove('active');
                document.getElementById('searchInput').value = '';
                
                if (type === 'feature' || type === 'app') {
                    this.selectNode(id);
                } else {
                    this.selectNode(id);
                }
                
                this.centerOnNode(id);
            }
            
            resize() {
                const rect = this.container.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;
                
                this.canvas.width = rect.width * dpr;
                this.canvas.height = rect.height * dpr;
                this.canvas.style.width = `${rect.width}px`;
                this.canvas.style.height = `${rect.height}px`;
                
                this.ctx.scale(dpr, dpr);
                this.width = rect.width;
                this.height = rect.height;
            }
            
            bindEvents() {
                this.canvas.addEventListener('mousedown', (e) => this.onMouseDown(e));
                this.canvas.addEventListener('mousemove', (e) => this.onMouseMove(e));
                this.canvas.addEventListener('mouseup', (e) => this.onMouseUp(e));
                this.canvas.addEventListener('wheel', (e) => this.onWheel(e));
                this.canvas.addEventListener('dblclick', (e) => this.onDoubleClick(e));
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closePanel();
                        this.closeModal();
                        document.getElementById('settingsModal').classList.remove('active');
                        document.getElementById('statsModal').classList.remove('active');
                        document.getElementById('usageModal').classList.remove('active');
                        document.getElementById('searchDropdown').classList.remove('active');
                        document.getElementById('dataFlowModal').classList.remove('active');
                    }
                    if (e.key === 'Delete' && this.selectedNode) {
                        this.deleteSelected();
                    }
                    if ((e.metaKey || e.ctrlKey) && e.key === 'f') {
                        e.preventDefault();
                        document.getElementById('searchInput').focus();
                    }
                    if ((e.metaKey || e.ctrlKey) && e.key === 's') {
                        e.preventDefault();
                        this.export();
                    }
                });
            }
            
            toggleTheme() {
                this.theme = this.theme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', this.theme);
                
                const icon = this.theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                document.getElementById('themeIcon').textContent = icon;
                document.getElementById('settingsThemeIcon').textContent = icon;
                
                this.showNotification('Theme Changed', `Switched to ${this.theme} mode`);
            }
            
            showSettings() {
                document.getElementById('settingsRepoName').value = this.repoSettings.name;
                document.getElementById('settingsRepoLocation').value = this.repoSettings.location;
                document.getElementById('settingsRepoDescription').value = this.repoSettings.description || '';
                document.getElementById('settingsDefaultOwner').value = this.repoSettings.defaultOwner;
                
                this.updateToggleUI('toggleDescriptions', this.searchSettings.descriptions);
                this.updateToggleUI('toggleTags', this.searchSettings.tags);
                this.updateToggleUI('toggleUsedBy', this.searchSettings.usedBy);
                this.updateToggleUI('toggleAccess', this.searchSettings.access);
                
                document.getElementById('settingsModal').classList.add('active');
            }
            
            updateToggleUI(id, active) {
                const el = document.getElementById(id);
                if (active) {
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            }
            
            toggleSearchSetting(setting) {
                this.searchSettings[setting] = !this.searchSettings[setting];
                this.updateToggleUI(`toggle${setting.charAt(0).toUpperCase() + setting.slice(1)}`, this.searchSettings[setting]);
            }
            
            async saveSettings() {
                this.repoSettings.name = document.getElementById('settingsRepoName').value || 'feature_repo';
                this.repoSettings.location = document.getElementById('settingsRepoLocation').value || '/opt/feast';
                this.repoSettings.defaultOwner = document.getElementById('settingsDefaultOwner').value || 'Data Platform Team';
                this.repoSettings.description = document.getElementById('settingsRepoDescription').value || '';
                
                this.updateRepoSubtitle();
                document.getElementById('settingsModal').classList.remove('active');
                
                // Persist to backend if we have a repo ID
                if (this.repoId) {
                    try {
                        const response = await fetch(`${this.apiBaseUrl}/repositories/${this.repoId}/`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCsrfToken()
                            },
                            body: JSON.stringify({
                                name: this.repoSettings.name,
                                location: this.repoSettings.location,
                                default_owner: this.repoSettings.defaultOwner,
                                description: this.repoSettings.description
                            })
                        });
                        
                        if (response.ok) {
                            this.showNotification('Settings Saved', 'Repository configuration updated on server');
                        } else {
                            throw new Error('Failed to save settings');
                        }
                    } catch (error) {
                        console.error('Save settings failed:', error);
                        this.showNotification('Warning', 'Settings saved locally but not synced to server');
                    }
                } else {
                    this.showNotification('Settings Saved', 'Repository configuration updated (local only)');
                }
                
                this.updateCodeEditor();
            }
            
            updateRepoSubtitle() {
                document.getElementById('repoSubtitle').textContent = `${this.repoSettings.name} ‚Ä¢ ${this.repoSettings.location}`;
            }
            
            addDatasource(config) {
                const id = `source_${++this.counters.datasource}`;
                const dbType = this.databaseTypes[config.kind] || { 
                    name: config.kind, 
                    debezium: false,
                    defaultProcess: 'Contact data platform team',
                    sparkPattern: 'Custom connector'
                };
                
                const node = {
                    id,
                    type: 'datasource',
                    name: config.name,
                    kind: config.kind,
                    dbType: dbType,
                    description: config.description || '',
                    tags: config.tags || [],
                    ownedBy: config.ownedBy || this.repoSettings.defaultOwner,
                    accessProcess: config.accessProcess || dbType.defaultProcess,
                    details: config.details || {},
                    x: config.x || 100,
                    y: config.y || 100,
                    inputs: [],
                    outputs: [],
                    createdAt: new Date().toISOString(),
                    // New fields for comprehensive DB support
                    debeziumAvailable: dbType.debezium,
                    sparkPattern: dbType.sparkPattern,
                    columnSecurity: config.columnSecurity || this.generateDefaultColumnSecurity()
                };
                this.nodes.set(id, node);
                this.updateStats();
                return id;
            }

            generateDefaultColumnSecurity() {
                return {
                    piiColumns: ['email', 'phone', 'ssn', 'address', 'name'],
                    maskedColumns: ['email', 'phone'],
                    restrictedColumns: ['ssn', 'salary']
                };
            }
            
            addEntity(config) {
                const id = `entity_${++this.counters.entity}`;
                const node = {
                    id,
                    type: 'entity',
                    name: config.name,
                    joinKey: config.joinKey || 'id',
                    description: config.description || '',
                    tags: config.tags || [],
                    details: config.details || {},
                    x: config.x || 100,
                    y: config.y || 100,
                    inputs: [],
                    outputs: [],
                    createdAt: new Date().toISOString()
                };
                this.nodes.set(id, node);
                this.updateStats();
                return id;
            }
            
            addFeatureView(config) {
                const id = `fv_${++this.counters.featureview}`;
                const node = {
                    id,
                    type: 'featureview',
                    name: config.name,
                    subtype: config.subtype || 'batch',
                    description: config.description || '',
                    tags: config.tags || [],
                    entities: config.entities || [],
                    features: config.features || [],
                    details: config.details || {},
                    x: config.x || 100,
                    y: config.y || 100,
                    inputs: [],
                    outputs: [],
                    createdAt: new Date().toISOString()
                };
                this.nodes.set(id, node);
                
                if (config.entities) {
                    config.entities.forEach(entityId => {
                        if (this.nodes.has(entityId)) {
                            this.addConnection(entityId, id);
                        }
                    });
                }
                
                this.updateStats();
                return id;
            }
            
            addService(config) {
                const id = `service_${++this.counters.service}`;
                const node = {
                    id,
                    type: 'service',
                    name: config.name,
                    description: config.description || '',
                    tags: config.tags || [],
                    features: config.features || [],
                    featureServices: config.featureServices || [],
                    details: config.details || {},
                    x: config.x || 100,
                    y: config.y || 100,
                    inputs: [],
                    outputs: [],
                    createdAt: new Date().toISOString()
                };
                this.nodes.set(id, node);
                
                if (config.features) {
                    config.features.forEach(fvId => {
                        if (this.nodes.has(fvId)) {
                            this.addConnection(fvId, id);
                        }
                    });
                }
                if (config.featureServices) {
                    config.featureServices.forEach(fsId => {
                        if (this.nodes.has(fsId)) {
                            this.addConnection(fsId, id);
                        }
                    });
                }
                
                this.updateStats();
                return id;
            }
            
            addConnection(fromId, toId) {
                if (!this.nodes.has(fromId) || !this.nodes.has(toId)) return;
                const exists = this.edges.some(e => e.from === fromId && e.to === toId);
                if (exists) return;
                
                const edge = { 
                    from: fromId, 
                    to: toId, 
                    id: `${fromId}->${toId}`,
                    animated: false
                };
                this.edges.push(edge);
                
                const fromNode = this.nodes.get(fromId);
                const toNode = this.nodes.get(toId);
                if (fromNode) fromNode.outputs.push(toId);
                if (toNode) toNode.inputs.push(fromId);
            }
            
            removeNode(id) {
                const nodeToRemove = this.nodes.get(id);
                if (!nodeToRemove) return;
                this.edges = this.edges.filter(e => e.from !== id && e.to !== id);
                
                this.nodes.forEach(node => {
                    node.inputs = node.inputs.filter(i => i !== id);
                    node.outputs = node.outputs.filter(o => o !== id);
                });
                
                this.nodes.forEach(node => {
                    if (node.type === 'featureview') {
                        node.entities = node.entities.filter(e => e !== id);
                    }
                    if (node.type === 'service') {
                        node.features = node.features.filter(f => f !== id);
                        node.featureServices = node.featureServices.filter(f => f !== id);
                    }
                });
                
                this.nodes.delete(id);
                if (this.selectedNode === id) {
                    this.selectedNode = null;
                    this.closePanel();
                }
                this.updateStats();
                this.updateCodeEditor();
            }
            
            deleteSelected() {
                if (!this.selectedNode) return;
                
                const node = this.nodes.get(this.selectedNode);
                if (confirm(`Are you sure you want to delete "${node.name}"? This action cannot be undone.`)) {
                    this.removeNode(this.selectedNode);
                    this.showNotification('Deleted', `"${node.name}" has been removed`);
                }
            }
            
            confirmDelete() {
                this.deleteSelected();
                this.closeModal();
            }
            
            updateStats() {
                const stats = {
                    datasource: 0,
                    entity: 0,
                    featureview: 0,
                    service: 0,
                    features: 0
                };
                
                this.nodes.forEach(node => {
                    if (stats[node.type] !== undefined) {
                        stats[node.type]++;
                    }
                    if (node.features && Array.isArray(node.features)) {
                        stats.features += node.features.length;
                    }
                });
                
                document.getElementById('statSources').textContent = stats.datasource;
                document.getElementById('statEntities').textContent = stats.entity;
                document.getElementById('statViews').textContent = stats.featureview;
                document.getElementById('statServices').textContent = stats.service;
                document.getElementById('statFeatures').textContent = stats.features;
            }
            
            autoLayout() {
                const columns = {
                    datasource: [],
                    entity: [],
                    featureview: [],
                    service: []
                };
                
                this.nodes.forEach((node, id) => {
                    if (columns[node.type]) {
                        columns[node.type].push(id);
                    }
                });
                
                const colWidth = 280;
                const rowHeight = 140;
                const startX = 120;
                const startY = 120;
                
                const sortByConnections = (ids) => {
                    return ids.sort((a, b) => {
                        const nodeA = this.nodes.get(a);
                        const nodeB = this.nodes.get(b);
                        return (nodeB.inputs.length + nodeB.outputs.length) - 
                               (nodeA.inputs.length + nodeA.outputs.length);
                    });
                };
                
                let colIndex = 0;
                ['datasource', 'entity', 'featureview', 'service'].forEach(type => {
                    let nodes = columns[type];
                    if (nodes.length === 0) return;
                    
                    nodes = sortByConnections(nodes);
                    
                    const colX = startX + colIndex * colWidth;
                    const totalHeight = nodes.length * rowHeight;
                    const startColY = Math.max(startY, (this.height - totalHeight) / 2);
                    
                    nodes.forEach((id, idx) => {
                        const node = this.nodes.get(id);
                        const targetY = startColY + idx * rowHeight;
                        this.animateNodePosition(node, colX, targetY);
                    });
                    
                    colIndex++;
                });
            }
            
            animateNodePosition(node, targetX, targetY) {
                const startX = node.x;
                const startY = node.y;
                const duration = 600;
                const startTime = Date.now();
                
                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const eased = 1 - Math.pow(1 - progress, 3);
                    
                    node.x = startX + (targetX - startX) * eased;
                    node.y = startY + (targetY - startY) * eased;
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    }
                };
                
                animate();
            }
            
            animate() {
                this.render();
                if (this.config.miniMapEnabled) {
                    this.renderMiniMap();
                }
                requestAnimationFrame(() => this.animate());
            }
            
            render() {
                this.ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--bg-primary').trim();
                this.ctx.fillRect(0, 0, this.width, this.height);
                
                this.ctx.save();
                this.ctx.translate(this.offsetX, this.offsetY);
                this.ctx.scale(this.scale, this.scale);
                
                this.drawEdges();
                
                this.nodes.forEach(node => {
                    if (this.isNodeVisible(node)) {
                        this.drawNode(node);
                    }
                });
                
                this.ctx.restore();
            }
            
            isNodeVisible(node) {
                return this.visibleLayers[node.type];
            }
            
            drawEdges() {
                this.edges.forEach(edge => {
                    const from = this.nodes.get(edge.from);
                    const to = this.nodes.get(edge.to);
                    
                    if (!from || !to) return;
                    if (!this.isNodeVisible(from) || !this.isNodeVisible(to)) return;
                    
                    const start = this.getPortPosition(from, 'output');
                    const end = this.getPortPosition(to, 'input');
                    
                    const isHighlighted = this.selectedNode && 
                        (edge.from === this.selectedNode || edge.to === this.selectedNode);
                    
                    this.ctx.beginPath();
                    
                    const dist = Math.abs(end.x - start.x);
                    const cp1x = start.x + dist * 0.5;
                    const cp1y = start.y;
                    const cp2x = end.x - dist * 0.5;
                    const cp2y = end.y;
                    
                    this.ctx.moveTo(start.x, start.y);
                    this.ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, end.x, end.y);
                    
                    if (isHighlighted) {
                        this.ctx.strokeStyle = '#f97316';
                        this.ctx.lineWidth = 3;
                        this.ctx.shadowColor = '#f97316';
                        this.ctx.shadowBlur = 10;
                    } else {
                        this.ctx.strokeStyle = 'rgba(148, 163, 184, 0.3)';
                        this.ctx.lineWidth = 2;
                        this.ctx.shadowBlur = 0;
                    }
                    
                    this.ctx.stroke();
                    this.ctx.shadowBlur = 0;
                    
                    const angle = Math.atan2(end.y - cp2y, end.x - cp2x);
                    const arrowLength = 10;
                    const arrowAngle = Math.PI / 6;
                    
                    this.ctx.beginPath();
                    this.ctx.moveTo(end.x, end.y);
                    this.ctx.lineTo(
                        end.x - arrowLength * Math.cos(angle - arrowAngle),
                        end.y - arrowLength * Math.sin(angle - arrowAngle)
                    );
                    this.ctx.moveTo(end.x, end.y);
                    this.ctx.lineTo(
                        end.x - arrowLength * Math.cos(angle + arrowAngle),
                        end.y - arrowLength * Math.sin(angle + arrowAngle)
                    );
                    this.ctx.strokeStyle = isHighlighted ? '#f97316' : 'rgba(148, 163, 184, 0.4)';
                    this.ctx.stroke();
                });
            }
            
            drawNode(node) {
                const config = this.config.colors[node.type];
                const isSelected = this.selectedNode === node.id;
                const isHovered = this.hoveredNode === node.id;
                
                const width = this.config.nodeWidth;
                const height = this.config.nodeHeight;
                
                if (isSelected) {
                    this.ctx.shadowColor = config.bg;
                    this.ctx.shadowBlur = 30;
                } else if (isHovered) {
                    this.ctx.shadowColor = config.bg;
                    this.ctx.shadowBlur = 15;
                }
                
                const gradient = this.ctx.createLinearGradient(node.x, node.y, node.x, node.y + height);
                const bgPrimary = getComputedStyle(document.body).getPropertyValue('--bg-secondary').trim();
                gradient.addColorStop(0, bgPrimary);
                gradient.addColorStop(1, getComputedStyle(document.body).getPropertyValue('--bg-primary').trim());
                
                this.ctx.fillStyle = gradient;
                this.roundRect(node.x, node.y, width, height, 12);
                this.ctx.fill();
                
                this.ctx.strokeStyle = isSelected ? config.bg : getComputedStyle(document.body).getPropertyValue('--border-color').trim();
                this.ctx.lineWidth = isSelected ? 3 : 1;
                this.ctx.stroke();
                
                this.ctx.shadowBlur = 0;
                
                this.ctx.fillStyle = config.bg;
                this.roundRect(node.x, node.y, width, 32, { tl: 12, tr: 12, bl: 0, br: 0 });
                this.ctx.fill();
                
                // Draw database icon for datasources if available
                let icon = config.icon;
                if (node.type === 'datasource' && node.dbType && node.dbType.icon) {
                    icon = node.dbType.icon;
                }
                
                this.ctx.font = '16px Arial';
                this.ctx.fillStyle = 'white';
                this.ctx.fillText(icon, node.x + 12, node.y + 24);
                
                this.ctx.fillStyle = 'white';
                this.ctx.font = 'bold 14px Inter, sans-serif';
                const title = this.truncateText(node.name, 22);
                this.ctx.fillText(title, node.x + 36, node.y + 22);
                
                this.ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
                this.ctx.font = '12px Inter, sans-serif';
                
                let contentY = node.y + 52;
                
                if (node.type === 'featureview') {
                    const entityCount = node.entities.length;
                    const featureCount = node.features.length;
                    this.ctx.fillStyle = config.light;
                    this.ctx.fillText(`${featureCount} features ‚Ä¢ ${entityCount} entities`, node.x + 12, contentY);
                    
                    this.ctx.fillStyle = this.getSubtypeColor(node.subtype);
                    this.roundRect(node.x + width - 60, node.y + 50, 48, 18, 9);
                    this.ctx.fill();
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = 'bold 10px Inter, sans-serif';
                    this.ctx.fillText(node.subtype, node.x + width - 48, node.y + 63);
                } else if (node.type === 'service') {
                    const viewCount = node.features.length;
                    const serviceCount = node.featureServices ? node.featureServices.length : 0;
                    this.ctx.fillStyle = config.light;
                    this.ctx.fillText(`${viewCount} views${serviceCount > 0 ? ` ‚Ä¢ ${serviceCount} services` : ''}`, node.x + 12, contentY);
                    
                    if (node.details.usedBy && node.details.usedBy.length > 0) {
                        this.ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-secondary').trim();
                        this.ctx.fillText(`Used by ${node.details.usedBy.length} apps`, node.x + 12, contentY + 16);
                    }
                } else if (node.type === 'entity') {
                    this.ctx.fillStyle = config.light;
                    this.ctx.fillText(`Key: ${node.joinKey}`, node.x + 12, contentY);
                } else if (node.type === 'datasource') {
                    this.ctx.fillStyle = config.light;
                    const dbName = node.dbType ? node.dbType.name : node.kind;
                    this.ctx.fillText(dbName, node.x + 12, contentY);
                    
                    if (node.ownedBy) {
                        this.ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-muted').trim();
                        this.ctx.font = '10px Inter, sans-serif';
                        this.ctx.fillText(`Owner: ${this.truncateText(node.ownedBy, 25)}`, node.x + 12, contentY + 16);
                    }
                }
                
                if (node.tags && node.tags.length > 0) {
                    this.ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-muted').trim();
                    this.ctx.font = '10px Inter, sans-serif';
                    this.ctx.fillText(`#${node.tags[0]}${node.tags.length > 1 ? ` +${node.tags.length - 1}` : ''}`, node.x + 12, node.y + height - 12);
                }
                
                this.drawPort(node, 'input');
                this.drawPort(node, 'output');
                
                if (isSelected) {
                    this.ctx.strokeStyle = config.bg;
                    this.ctx.lineWidth = 2;
                    this.ctx.setLineDash([5, 5]);
                    this.roundRect(node.x - 8, node.y - 8, width + 16, height + 16, 16);
                    this.ctx.stroke();
                    this.ctx.setLineDash([]);
                }
            }
            
            getSubtypeColor(subtype) {
                const colors = {
                    batch: '#10b981',
                    stream: '#f59e0b',
                    on_demand: '#ec4899'
                };
                return colors[subtype] || '#64748b';
            }
            
            drawPort(node, type) {
                const pos = this.getPortPosition(node, type);
                
                this.ctx.beginPath();
                this.ctx.arc(pos.x, pos.y, this.config.portRadius, 0, Math.PI * 2);
                this.ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--bg-primary').trim();
                this.ctx.fill();
                this.ctx.strokeStyle = 'rgba(148, 163, 184, 0.5)';
                this.ctx.lineWidth = 2;
                this.ctx.stroke();
            }
            
            getPortPosition(node, type) {
                const { nodeWidth, nodeHeight } = this.config;
                if (type === 'input') {
                    return { x: node.x, y: node.y + nodeHeight / 2 };
                } else {
                    return { x: node.x + nodeWidth, y: node.y + nodeHeight / 2 };
                }
            }
            
            roundRect(x, y, w, h, r) {
                if (typeof r === 'object') {
                    const { tl, tr, br, bl } = r;
                    this.ctx.beginPath();
                    this.ctx.moveTo(x + tl, y);
                    this.ctx.lineTo(x + w - tr, y);
                    this.ctx.quadraticCurveTo(x + w, y, x + w, y + tr);
                    this.ctx.lineTo(x + w, y + h - br);
                    this.ctx.quadraticCurveTo(x + w, y + h, x + w - br, y + h);
                    this.ctx.lineTo(x + bl, y + h);
                    this.ctx.quadraticCurveTo(x, y + h, x, y + h - bl);
                    this.ctx.lineTo(x, y + tl);
                    this.ctx.quadraticCurveTo(x, y, x + tl, y);
                    this.ctx.closePath();
                } else {
                    const radius = Math.min(r, w/2, h/2);
                    this.ctx.beginPath();
                    this.ctx.moveTo(x + radius, y);
                    this.ctx.lineTo(x + w - radius, y);
                    this.ctx.quadraticCurveTo(x + w, y, x + w, y + radius);
                    this.ctx.lineTo(x + w, y + h - radius);
                    this.ctx.quadraticCurveTo(x + w, y + h, x + w - radius, y + h);
                    this.ctx.lineTo(x + radius, y + h);
                    this.ctx.quadraticCurveTo(x, y + h, x, y + h - radius);
                    this.ctx.lineTo(x, y + radius);
                    this.ctx.quadraticCurveTo(x, y, x + radius, y);
                    this.ctx.closePath();
                }
            }
            
            truncateText(text, maxLen) {
                if (!text) return '';
                return text.length > maxLen ? text.substring(0, maxLen) + '...' : text;
            }
            
            setupMiniMap() {
                this.miniMapCanvas = document.getElementById('miniMapCanvas');
                this.miniMapCtx = this.miniMapCanvas.getContext('2d');
                this.miniMapContainer = document.getElementById('miniMap');
                
                this.miniMapCanvas.width = 200;
                this.miniMapCanvas.height = 150;
                
                this.miniMapCanvas.addEventListener('click', (e) => {
                    const rect = this.miniMapCanvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    const bounds = this.getBounds();
                    const scaleX = 200 / (bounds.width + 400);
                    const scaleY = 150 / (bounds.height + 400);
                    const scale = Math.min(scaleX, scaleY);
                    
                    const worldX = (x / scale) - 200 + bounds.minX;
                    const worldY = (y / scale) - 150 + bounds.minY;
                    
                    this.offsetX = (this.width / 2) - (worldX * this.scale);
                    this.offsetY = (this.height / 2) - (worldY * this.scale);
                });
            }
            
            getBounds() {
                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                
                this.nodes.forEach(node => {
                    minX = Math.min(minX, node.x);
                    minY = Math.min(minY, node.y);
                    maxX = Math.max(maxX, node.x + this.config.nodeWidth);
                    maxY = Math.max(maxY, node.y + this.config.nodeHeight);
                });
                
                if (minX === Infinity) {
                    return { minX: 0, minY: 0, width: 1000, height: 800 };
                }
                
                return {
                    minX: minX - 100,
                    minY: minY - 100,
                    width: maxX - minX + 200,
                    height: maxY - minY + 200
                };
            }
            
            renderMiniMap() {
                if (!this.miniMapCtx) return;
                
                const ctx = this.miniMapCtx;
                const bounds = this.getBounds();
                
                const scaleX = 200 / bounds.width;
                const scaleY = 150 / bounds.height;
                const scale = Math.min(scaleX, scaleY) * 0.9;
                
                ctx.clearRect(0, 0, 200, 150);
                
                ctx.fillStyle = this.theme === 'dark' ? 'rgba(15, 23, 42, 0.5)' : 'rgba(255, 255, 255, 0.5)';
                ctx.fillRect(0, 0, 200, 150);
                
                ctx.save();
                ctx.translate(
                    (200 - bounds.width * scale) / 2 - bounds.minX * scale,
                    (150 - bounds.height * scale) / 2 - bounds.minY * scale
                );
                ctx.scale(scale, scale);
                
                ctx.strokeStyle = 'rgba(148, 163, 184, 0.2)';
                ctx.lineWidth = 2 / scale;
                this.edges.forEach(edge => {
                    const from = this.nodes.get(edge.from);
                    const to = this.nodes.get(edge.to);
                    if (!from || !to) return;
                    
                    ctx.beginPath();
                    ctx.moveTo(from.x + this.config.nodeWidth / 2, from.y + this.config.nodeHeight / 2);
                    ctx.lineTo(to.x + this.config.nodeWidth / 2, to.y + this.config.nodeHeight / 2);
                    ctx.stroke();
                });
                
                this.nodes.forEach(node => {
                    if (!this.isNodeVisible(node)) return;
                    
                    const config = this.config.colors[node.type];
                    ctx.fillStyle = config.bg;
                    ctx.fillRect(node.x, node.y, this.config.nodeWidth, this.config.nodeHeight);
                });
                
                ctx.restore();
                
                const vpX = (-this.offsetX / this.scale - bounds.minX) * scale + (200 - bounds.width * scale) / 2;
                const vpY = (-this.offsetY / this.scale - bounds.minY) * scale + (150 - bounds.height * scale) / 2;
                const vpW = (this.width / this.scale) * scale;
                const vpH = (this.height / this.scale) * scale;
                
                ctx.strokeStyle = '#f97316';
                ctx.lineWidth = 2;
                ctx.strokeRect(vpX, vpY, vpW, vpH);
            }
            
            toggleMiniMap() {
                this.config.miniMapEnabled = !this.config.miniMapEnabled;
                document.getElementById('miniMap').style.display = 
                    this.config.miniMapEnabled ? 'block' : 'none';
            }
            
            screenToWorld(x, y) {
                return {
                    x: (x - this.offsetX) / this.scale,
                    y: (y - this.offsetY) / this.scale
                };
            }
            
            getNodeAt(x, y) {
                const pos = this.screenToWorld(x, y);
                for (const [id, node] of this.nodes) {
                    if (!this.isNodeVisible(node)) continue;
                    if (pos.x >= node.x && pos.x <= node.x + this.config.nodeWidth &&
                        pos.y >= node.y && pos.y <= node.y + this.config.nodeHeight) {
                        return id;
                    }
                }
                return null;
            }
            
            onMouseDown(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const nodeId = this.getNodeAt(x, y);
                if (nodeId) {
                    this.isDragging = true;
                    this.draggedNode = nodeId;
                    this.dragStart = { x, y };
                    this.selectNode(nodeId);
                } else {
                    this.isPanning = true;
                    this.panStart = { x, y };
                    this.canvas.style.cursor = 'grabbing';
                }
            }
            
            onMouseMove(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                this.lastMouse = { x, y };
                
                if (this.isDragging && this.draggedNode) {
                    const dx = (x - this.dragStart.x) / this.scale;
                    const dy = (y - this.dragStart.y) / this.scale;
                    
                    const node = this.nodes.get(this.draggedNode);
                    node.x += dx;
                    node.y += dy;
                    
                    this.dragStart = { x, y };
                } else if (this.isPanning) {
                    this.offsetX += x - this.panStart.x;
                    this.offsetY += y - this.panStart.y;
                    this.panStart = { x, y };
                } else {
                    const prevHover = this.hoveredNode;
                    this.hoveredNode = this.getNodeAt(x, y);
                    
                    if (this.hoveredNode !== prevHover) {
                        if (this.hoveredNode) {
                            this.showTooltip(this.hoveredNode, e.clientX, e.clientY);
                            this.canvas.style.cursor = 'pointer';
                        } else {
                            this.hideTooltip();
                            this.canvas.style.cursor = 'default';
                        }
                    } else if (this.hoveredNode) {
                        this.updateTooltip(e.clientX, e.clientY);
                    }
                }
            }
            
            onMouseUp(e) {
                this.isDragging = false;
                this.draggedNode = null;
                this.isPanning = false;
                this.canvas.style.cursor = this.hoveredNode ? 'pointer' : 'default';
            }
            
            onWheel(e) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                const newScale = Math.max(0.1, Math.min(4, this.scale * delta));
                
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const worldPos = this.screenToWorld(x, y);
                this.scale = newScale;
                this.offsetX = x - worldPos.x * this.scale;
                this.offsetY = y - worldPos.y * this.scale;
            }
            
            onDoubleClick(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const nodeId = this.getNodeAt(x, y);
                if (nodeId) {
                    this.showEditModal(nodeId);
                }
            }
            
            showTooltip(nodeId, x, y) {
                const node = this.nodes.get(nodeId);
                const tooltip = document.getElementById('tooltip');
                
                let icon = this.config.colors[node.type].icon;
                if (node.type === 'datasource' && node.dbType && node.dbType.icon) {
                    icon = node.dbType.icon;
                }
                
                document.getElementById('tooltipIcon').textContent = icon;
                document.getElementById('tooltipTitle').textContent = node.name;
                
                let subtitle = `${this.config.colors[node.type].label}`;
                if (node.subtype) subtitle += ` ‚Ä¢ ${node.subtype}`;
                if (node.kind) {
                    const dbName = node.dbType ? node.dbType.name : node.kind;
                    subtitle += ` ‚Ä¢ ${dbName}`;
                }
                document.getElementById('tooltipSubtitle').textContent = subtitle;
                
                const tagsDiv = document.getElementById('tooltipTags');
                const tagList = document.getElementById('tooltipTagList');
                if (node.tags && node.tags.length > 0) {
                    tagsDiv.style.display = 'block';
                    tagList.innerHTML = node.tags.map(tag => 
                        `<span class="tooltip-tag">#${tag}</span>`
                    ).join('');
                } else {
                    tagsDiv.style.display = 'none';
                }
                
                const featuresDiv = document.getElementById('tooltipFeatures');
                const featureList = document.getElementById('tooltipFeatureList');
                
                if (node.features && node.features.length > 0) {
                    featuresDiv.style.display = 'block';
                    featureList.innerHTML = node.features.slice(0, 5).map(f => {
                        const name = typeof f === 'string' ? f : f.name;
                        return `<span class="tooltip-feature-tag">${name}</span>`;
                    }).join('');
                    if (node.features.length > 5) {
                        featureList.innerHTML += `<span style="color: var(--text-muted); font-size: 11px;">+${node.features.length - 5} more</span>`;
                    }
                } else {
                    featuresDiv.style.display = 'none';
                }
                
                const descDiv = document.getElementById('tooltipDescription');
                const descText = document.getElementById('tooltipDescText');
                if (node.description) {
                    descDiv.style.display = 'block';
                    descText.textContent = node.description;
                } else {
                    descDiv.style.display = 'none';
                }
                
                tooltip.style.display = 'block';
                tooltip.style.left = `${Math.min(x + 20, window.innerWidth - 340)}px`;
                tooltip.style.top = `${Math.min(y + 20, window.innerHeight - 200)}px`;
            }
            
            updateTooltip(x, y) {
                const tooltip = document.getElementById('tooltip');
                tooltip.style.left = `${Math.min(x + 20, window.innerWidth - 340)}px`;
                tooltip.style.top = `${Math.min(y + 20, window.innerHeight - 200)}px`;
            }
            
            hideTooltip() {
                document.getElementById('tooltip').style.display = 'none';
            }
            
            selectNode(id) {
                this.selectedNode = id;
                this.showPanel(id);
                this.updateCodeEditor();
                this.updateLLMContext();
                this.updateDjangoPanel();
            }
            
            showPanel(id) {
                const node = this.nodes.get(id);
                const panel = document.getElementById('detailPanel');
                const config = this.config.colors[node.type];
                
                let icon = config.icon;
                if (node.type === 'datasource' && node.dbType && node.dbType.icon) {
                    icon = node.dbType.icon;
                }
                
                document.getElementById('panelIcon').textContent = icon;
                document.getElementById('panelType').textContent = config.label;
                document.getElementById('panelType').style.color = config.light;
                document.getElementById('panelBadge').style.background = `${config.bg}20`;
                
                document.getElementById('panelTitle').textContent = node.name;
                
                let subtitle = '';
                if (node.type === 'featureview') {
                    subtitle = `${node.subtype} ‚Ä¢ ${node.features.length} features`;
                } else if (node.type === 'service') {
                    const totalDeps = node.features.length + (node.featureServices ? node.featureServices.length : 0);
                    subtitle = `${totalDeps} dependencies`;
                } else if (node.type === 'entity') {
                    subtitle = `Join key: ${node.joinKey}`;
                } else if (node.type === 'datasource') {
                    const dbName = node.dbType ? node.dbType.name : node.kind;
                    subtitle = `${dbName} ‚Ä¢ ${node.ownedBy}`;
                }
                document.getElementById('panelSubtitle').textContent = subtitle;
                
                const tagsContainer = document.getElementById('panelTags');
                if (node.tags && node.tags.length > 0) {
                    tagsContainer.innerHTML = node.tags.map(tag => 
                        `<span class="tag">#${tag}</span>`
                    ).join('');
                } else {
                    tagsContainer.innerHTML = '';
                }
                
                const content = document.getElementById('panelContent');
                let html = '';
                
                if (node.description) {
                    html += `
                        <div class="panel-section">
                            <div class="section-header">
                                <div class="section-title">Description</div>
                            </div>
                            <div class="notes-section">
                                <div class="notes-text">${node.description}</div>
                            </div>
                        </div>
                    `;
                }
                
                html += `<div class="panel-section"><div class="detail-card">`;
                
                if (node.type === 'entity') {
                    html += `
                        <div class="detail-row">
                            <span class="detail-label">Join Key</span>
                            <span class="detail-value highlight">${node.joinKey}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Used By</span>
                            <span class="detail-value">${this.getUsedByCount(id)} views</span>
                        </div>
                    `;
                } else if (node.type === 'featureview') {
                    html += `
                        <div class="detail-row">
                            <span class="detail-label">Type</span>
                            <span class="detail-value" style="color: ${this.getSubtypeColor(node.subtype)}">${node.subtype}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Entities</span>
                            <span class="detail-value">${node.entities.length}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Features</span>
                            <span class="detail-value">${node.features.length}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">TTL</span>
                            <span class="detail-value">${node.details.ttl || 'Not set'}</span>
                        </div>
                    `;
                } else if (node.type === 'service') {
                    html += `
                        <div class="detail-row">
                            <span class="detail-label">Feature Views</span>
                            <span class="detail-value">${node.features.length}</span>
                        </div>
                        ${node.featureServices && node.featureServices.length > 0 ? `
                        <div class="detail-row">
                            <span class="detail-label">Feature Services</span>
                            <span class="detail-value">${node.featureServices.length}</span>
                        </div>
                        ` : ''}
                        <div class="detail-row">
                            <span class="detail-label">Used By</span>
                            <span class="detail-value">${node.details.usedBy ? node.details.usedBy.length : 0} applications</span>
                        </div>
                    `;
                } else if (node.type === 'datasource') {
                    const dbName = node.dbType ? node.dbType.name : node.kind;
                    html += `
                        <div class="detail-row">
                            <span class="detail-label">Type</span>
                            <span class="detail-value">${dbName}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Category</span>
                            <span class="detail-value">${node.dbType ? node.dbType.category : 'Unknown'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Debezium Support</span>
                            <span class="detail-value">${node.debeziumAvailable ? '‚úÖ Yes' : '‚ùå No'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Owned By</span>
                            <span class="detail-value">${node.ownedBy}</span>
                        </div>
                        ${node.details.connection ? `
                        <div class="detail-row">
                            <span class="detail-label">Connection</span>
                            <span class="detail-value" style="font-size: 11px;">${node.details.connection}</span>
                        </div>
                        ` : ''}
                    `;
                    
                    if (node.accessProcess) {
                        html += `</div></div>
                        <div class="panel-section">
                            <div class="section-header">
                                <div class="section-title">Access Process</div>
                            </div>
                            <div class="notes-section">
                                <div class="notes-text">${node.accessProcess}</div>
                            </div>
                            <button class="access-request-btn" onclick="diagram.requestAccess('${id}')">
                                <span>üîê</span>
                                <span>Request Access</span>
                            </button>
                        </div>
                        <div class="panel-section"><div class="detail-card">`;
                    }
                }
                
                html += `</div></div>`;
                
                if (node.type === 'featureview' && node.features.length > 0) {
                    html += `
                        <div class="panel-section">
                            <div class="section-header">
                                <div class="section-title">Features</div>
                                <div class="section-badge">${node.features.length}</div>
                            </div>
                            <div class="feature-list">
                                ${node.features.map(f => `
                                    <div class="feature-item">
                                        <div class="feature-info">
                                            <div class="feature-icon">‚ö°</div>
                                            <div>
                                                <div class="feature-name">${f.name}</div>
                                                <div class="feature-type">${f.type}</div>
                                            </div>
                                        </div>
                                        <span class="feature-badge">${f.type}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                html += `
                    <div class="panel-section">
                        <div class="section-header">
                            <div class="section-title">Lineage</div>
                        </div>
                        <div class="connection-graph">
                `;
                
                if (node.inputs.length > 0) {
                    node.inputs.forEach(inputId => {
                        const input = this.nodes.get(inputId);
                        if (input && this.isNodeVisible(input)) {
                            const inputConfig = this.config.colors[input.type];
                            let inputIcon = inputConfig.icon;
                            if (input.type === 'datasource' && input.dbType && input.dbType.icon) {
                                inputIcon = input.dbType.icon;
                            }
                            html += `
                                <div class="connection-node" onclick="diagram.selectNode('${inputId}')">
                                    <div class="connection-icon" style="background: ${inputConfig.bg}20; color: ${inputConfig.light};">
                                        ${inputIcon}
                                    </div>
                                    <div class="connection-info">
                                        <div class="connection-name">${input.name}</div>
                                        <div class="connection-meta">${inputConfig.label}</div>
                                    </div>
                                    <span class="connection-arrow">‚Üê</span>
                                </div>
                            `;
                        }
                    });
                }
                
                html += `
                    <div class="connection-node" style="border-color: ${config.bg}; background: ${config.bg}10;">
                        <div class="connection-icon" style="background: ${config.bg}20; color: ${config.light};">
                            ${icon}
                        </div>
                        <div class="connection-info">
                            <div class="connection-name">${node.name}</div>
                            <div class="connection-meta" style="color: ${config.light};">${config.label}</div>
                        </div>
                    </div>
                `;
                
                if (node.outputs.length > 0) {
                    node.outputs.forEach(outputId => {
                        const output = this.nodes.get(outputId);
                        if (output && this.isNodeVisible(output)) {
                            const outputConfig = this.config.colors[output.type];
                            let outputIcon = outputConfig.icon;
                            if (output.type === 'datasource' && output.dbType && output.dbType.icon) {
                                outputIcon = output.dbType.icon;
                            }
                            html += `
                                <div class="connection-node" onclick="diagram.selectNode('${outputId}')">
                                    <div class="connection-icon" style="background: ${outputConfig.bg}20; color: ${outputConfig.light};">
                                        ${outputIcon}
                                    </div>
                                    <div class="connection-info">
                                        <div class="connection-name">${output.name}</div>
                                        <div class="connection-meta">${outputConfig.label}</div>
                                    </div>
                                    <span class="connection-arrow">‚Üí</span>
                                </div>
                            `;
                        }
                    });
                }
                
                html += `</div></div>`;
                
                if (node.details.usedBy && node.details.usedBy.length > 0) {
                    html += `
                        <div class="panel-section">
                            <div class="section-header">
                                <div class="section-title">Used By Applications</div>
                                <div class="section-badge">${node.details.usedBy.length}</div>
                            </div>
                            <div class="service-usage">
                                ${node.details.usedBy.map((app, idx) => {
                                    const appData = typeof app === 'string' ? { name: app } : app;
                                    return `
                                    <div class="usage-card" onclick="diagram.showUsageDetails(${idx})">
                                        <div class="usage-details">‚ÑπÔ∏è</div>
                                        <div class="usage-icon" style="background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white;">
                                            üñ•Ô∏è
                                        </div>
                                        <div class="usage-name">${appData.name}</div>
                                        <div class="usage-type">${appData.environment || 'Production'}</div>
                                        ${appData.sla ? `<div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">SLA: ${appData.sla}</div>` : ''}
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    `;
                }
                
                if (node.details.notes) {
                    html += `
                        <div class="panel-section">
                            <div class="section-header">
                                <div class="section-title">Notes</div>
                            </div>
                            <div class="notes-section">
                                <div class="notes-text">${node.details.notes}</div>
                            </div>
                        </div>
                    `;
                }
                
                html += `
                    <div class="panel-section">
                        <div class="section-header">
                            <div class="section-title">Python API</div>
                        </div>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">Python</span>
                                <button class="code-copy" onclick="diagram.copyCode(this)">Copy</button>
                            </div>
                            <div class="code-content">${this.generateCodeExample(node)}</div>
                        </div>
                    </div>
                `;
                
                content.innerHTML = html;
                panel.classList.add('open');
            }

            async requestAccess(nodeId) {
                const node = this.nodes.get(nodeId);
                if (!node) return;
                
                // Find the backend data source ID if it exists
                // This requires storing backend IDs on nodes - add this when loading from backend
                const backendId = node.backendId;
                
                if (!backendId) {
                    // Local-only node, just show notification
                    this.showNotification('Access Requested', `Request sent to ${node.ownedBy} for ${node.name}`);
                    setTimeout(() => {
                        this.showNotification('Request Approved', `You now have read access to ${node.name}`);
                    }, 2000);
                    return;
                }
                
                try {
                    // Create audit log entry for access request
                    const response = await fetch(`${this.apiBaseUrl}/audit-logs/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCsrfToken()
                        },
                        body: JSON.stringify({
                            action: 'ACCESS_REQUEST',
                            resource_type: 'datasource',
                            resource_name: node.name,
                            details: {
                                data_source_id: backendId,
                                owner: node.ownedBy
                            }
                        })
                    });
                    
                    if (response.ok) {
                        this.showNotification('Access Requested', `Request logged for ${node.name}`);
                    } else {
                        throw new Error('Failed to log request');
                    }
                    
                } catch (error) {
                    console.error('Access request failed:', error);
                    this.showNotification('Error', 'Failed to submit access request');
                }
            }
            
            getUsedByCount(entityId) {
                let count = 0;
                this.nodes.forEach(node => {
                    if (node.type === 'featureview' && node.entities.includes(entityId)) {
                        count++;
                    }
                });
                return count;
            }
            
            showUsageDetails(idx) {
                const node = this.nodes.get(this.selectedNode);
                if (!node || !node.details.usedBy || !node.details.usedBy[idx]) return;
                
                const app = typeof node.details.usedBy[idx] === 'string' 
                    ? { name: node.details.usedBy[idx], environment: 'Production', sla: '99.9%', contact: '', description: '' }
                    : node.details.usedBy[idx];
                
                this.editingUsage = idx;
                
                document.getElementById('usageModalTitle').textContent = `Edit: ${app.name}`;
                document.getElementById('usageModalBody').innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Application Name</label>
                        <input type="text" class="form-input" id="usageName" value="${app.name}">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Environment</label>
                            <select class="form-select" id="usageEnv">
                                <option value="Production" ${app.environment === 'Production' ? 'selected' : ''}>Production</option>
                                <option value="Staging" ${app.environment === 'Staging' ? 'selected' : ''}>Staging</option>
                                <option value="Development" ${app.environment === 'Development' ? 'selected' : ''}>Development</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">SLA</label>
                            <input type="text" class="form-input" id="usageSLA" value="${app.sla || '99.9%'}" placeholder="99.9%">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contact</label>
                        <input type="text" class="form-input" id="usageContact" value="${app.contact || ''}" placeholder="team@company.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" id="usageDesc" placeholder="How this app uses the features...">${app.description || ''}</textarea>
                    </div>
                `;
                
                document.getElementById('usageModal').classList.add('active');
            }
            
            saveUsageDetails() {
                if (this.editingUsage === null) return;
                
                const node = this.nodes.get(this.selectedNode);
                if (!node) return;
                
                const updatedApp = {
                    name: document.getElementById('usageName').value,
                    environment: document.getElementById('usageEnv').value,
                    sla: document.getElementById('usageSLA').value,
                    contact: document.getElementById('usageContact').value,
                    description: document.getElementById('usageDesc').value
                };
                
                if (typeof node.details.usedBy[this.editingUsage] === 'string') {
                    node.details.usedBy[this.editingUsage] = updatedApp;
                } else {
                    node.details.usedBy[this.editingUsage] = { ...node.details.usedBy[this.editingUsage], ...updatedApp };
                }
                
                document.getElementById('usageModal').classList.remove('active');
                this.showPanel(this.selectedNode);
                this.showNotification('Updated', 'Application details saved');
            }
            
            generateCodeExample(node) {
                if (node.type === 'featureview') {
                    return `<span class="code-comment"># Retrieve features from ${node.name}</span>
<span class="code-keyword">from</span> feast <span class="code-keyword">import</span> FeatureStore

store = FeatureStore(repo_path=<span class="code-string">"${this.repoSettings.location}"</span>)

features = store.get_online_features(
    features=[
        ${node.features.slice(0, 2).map(f => `<span class="code-string">"${node.name}:${f.name}"</span>`).join(',\n        ')}${node.features.length > 2 ? ',' : ''}
    ],
    entity_rows=[{<span class="code-string">"${this.nodes.get(node.entities[0])?.joinKey || 'id'}"</span>: <span class="code-string">"123"</span>}]
).to_df()`;
                } else if (node.type === 'service') {
                    return `<span class="code-comment"># Use feature service</span>
<span class="code-keyword">from</span> feast <span class="code-keyword">import</span> FeatureStore

store = FeatureStore(repo_path=<span class="code-string">"${this.repoSettings.location}"</span>)

features = store.get_online_features(
    feature_service=<span class="code-string">"${node.name}"</span>,
    entity_rows=[{<span class="code-string">"user_id"</span>: <span class="code-string">"123"</span>}]
).to_df()`;
                } else if (node.type === 'entity') {
                    return `<span class="code-comment"># Define entity</span>
<span class="code-keyword">from</span> feast <span class="code-keyword">import</span> Entity, ValueType

<span class="code-keyword">${node.name.toLowerCase().replace(/\s+/g, '_')}</span> = Entity(
    name=<span class="code-string">"${node.name}"</span>,
    join_keys=[<span class="code-string">"${node.joinKey}"</span>],
    value_type=ValueType.STRING
)`;
                }
                return `<span class="code-comment"># Component code example</span>`;
            }
            
            copyCode(btn) {
                const code = btn.closest('.code-block').querySelector('.code-content').innerText;
                navigator.clipboard.writeText(code);
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = 'Copy', 2000);
            }
            
            closePanel() {
                document.getElementById('detailPanel').classList.remove('open');
                this.selectedNode = null;
            }
            
            editSelected() {
                if (this.selectedNode) {
                    this.showEditModal(this.selectedNode);
                }
            }
            
            toggleCodeEditor() {
                const panel = document.getElementById('codeEditorPanel');
                const isOpen = panel.classList.contains('open');
                
                if (isOpen) {
                    panel.classList.remove('open');
                    this.codeEditorOpen = false;
                    document.getElementById('codeEditorToggleBtn').textContent = 'üìù';
                } else {
                    panel.classList.add('open');
                    this.codeEditorOpen = true;
                    document.getElementById('codeEditorToggleBtn').textContent = '‚úï';
                    this.updateCodeEditor();
                }
            }
            
            updateCodeEditor() {
                if (!this.codeEditorOpen) return;
                
                const format = document.getElementById('codeFormatSelect').value;
                
                if (format === 'python') {
                    this.renderPythonFileBrowser();
                } else if (format === 'json') {
                    this.renderSingleFile('export.json', 'JSON Export', this.generateJSONExport());
                } else if (format === 'yaml') {
                    this.renderSingleFile('feature_store.yaml', 'YAML Config', this.generateYAMLConfig());
                }
            }
            
            renderPythonFileBrowser() {
                const sidebar = document.getElementById('fileSidebar');
                const files = [
                    { name: 'entities.py', icon: 'üë§', desc: 'Entity definitions', active: this.currentCodeFile === 'entities.py' },
                    { name: 'data_sources.py', icon: 'üóÑÔ∏è', desc: 'Data source configs', active: this.currentCodeFile === 'data_sources.py' },
                    { name: 'feature_views.py', icon: 'üìä', desc: 'Feature view definitions', active: this.currentCodeFile === 'feature_views.py' },
                    { name: 'services.py', icon: 'üöÄ', desc: 'Feature services', active: this.currentCodeFile === 'services.py' },
                    { name: 'debezium_configs.py', icon: '‚ö°', desc: 'CDC connectors', active: this.currentCodeFile === 'debezium_configs.py' },
                    { name: 'spark_jobs.py', icon: 'üî•', desc: 'Streaming jobs', active: this.currentCodeFile === 'spark_jobs.py' },
                    { name: 'django_models.py', icon: 'üé≠', desc: 'Access control models', active: this.currentCodeFile === 'django_models.py' },
                    { name: 'postgres_rls.sql', icon: 'üêò', desc: 'Row Level Security', active: this.currentCodeFile === 'postgres_rls.sql' }
                ];
                
                sidebar.innerHTML = `
                    <div style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                        Python Files
                    </div>
                    <div class="file-browser">
                        ${files.map(f => `
                            <div class="file-browser-item ${f.active ? 'active' : ''}" onclick="diagram.selectCodeFile('${f.name}')">
                                <span class="file-icon">${f.icon}</span>
                                <span class="file-name">${f.name}</span>
                                <span class="file-description">${f.desc}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                this.selectCodeFile(this.currentCodeFile);
            }
            
            selectCodeFile(filename) {
                this.currentCodeFile = filename;
                
                document.querySelectorAll('.file-browser-item').forEach(el => {
                    el.classList.remove('active');
                    if (el.querySelector('.file-name').textContent === filename) {
                        el.classList.add('active');
                    }
                });
                
                document.getElementById('currentFileName').textContent = filename;
                document.getElementById('currentFilePath').textContent = `${this.repoSettings.name}/${filename}`;
                
                let content = '';
                switch(filename) {
                    case 'entities.py':
                        content = this.generateEntitiesFile();
                        break;
                    case 'data_sources.py':
                        content = this.generateDataSourcesFile();
                        break;
                    case 'feature_views.py':
                        content = this.generateFeatureViewsFile();
                        break;
                    case 'services.py':
                        content = this.generateServicesFile();
                        break;
                    case 'debezium_configs.py':
                        content = this.generateDebeziumConfigs();
                        break;
                    case 'spark_jobs.py':
                        content = this.generateSparkJobs();
                        break;
                    case 'django_models.py':
                        content = this.generateDjangoModels();
                        break;
                    case 'postgres_rls.sql':
                        content = this.generatePostgresRLS();
                        break;
                }
                
                document.getElementById('codeEditorContent').innerHTML = content;
            }
            
            renderSingleFile(filename, title, content) {
                document.getElementById('fileSidebar').innerHTML = `
                    <div style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                        ${title}
                    </div>
                    <div class="file-browser">
                        <div class="file-browser-item active">
                            <span class="file-icon">üìÑ</span>
                            <span class="file-name">${filename}</span>
                        </div>
                    </div>
                `;
                
                document.getElementById('currentFileName').textContent = filename;
                document.getElementById('currentFilePath').textContent = `${this.repoSettings.name}/${filename}`;
                document.getElementById('codeEditorContent').innerHTML = content;
            }
            
            generateEntitiesFile() {
                const entities = Array.from(this.nodes.values()).filter(n => n.type === 'entity');
                
                let code = `<span class="code-comment">"""
entities.py
===========

Entity definitions for ${this.repoSettings.name}.

This module defines all entities used across the feature store. Entities are the 
primary keys used to join features together during retrieval.

Generated by Feast Architect v3.0
Repository: ${this.repoSettings.location}
Date: ${new Date().toISOString().split('T')[0]}
"""</span>

<span class="code-keyword">from</span> feast <span class="code-keyword">import</span> Entity, ValueType

<span class="code-comment"># ==========================================</span>
<span class="code-comment"># ENTITY DEFINITIONS</span>
<span class="code-comment"># ==========================================</span>

<span class="code-comment">"""
Available Entities:
${entities.map(e => `- ${e.name} (join_key: ${e.joinKey})`).join('\n')}

Total: ${entities.length} entities
"""</span>

`;
                
                if (entities.length === 0) {
                    code += `<span class="code-comment"># No entities defined yet. Add entities using the Feast Architect UI.</span>`;
                } else {
                    entities.forEach((node, idx) => {
                        const varName = node.name.toLowerCase().replace(/\s+/g, '_');
                        code += `<span class="code-comment">"""
${node.name} Entity
${'-'.repeat(node.name.length + 7)}

${node.description || 'No description provided.'}

Attributes:
    - join_key: "${node.joinKey}"
    - value_type: ValueType.STRING
${node.tags.length > 0 ? `    - tags: [${node.tags.map(t => `"${t}"`).join(', ')}]` : ''}

Usage:
    Used by ${this.getUsedByCount(node.id)} feature view(s)
"""</span>
<span class="code-keyword">${varName}</span> = Entity(
    name=<span class="code-string">"${node.name}"</span>,
    join_keys=[<span class="code-string">"${node.joinKey}"</span>],
    value_type=ValueType.STRING,
    description=<span class="code-string">"${node.description || ''}"</span>${node.tags.length > 0 ? `,
    tags={${node.tags.map(t => `"${t}": ""`).join(', ')}}` : ''}
)

`;
                    });
                }
                
                return code;
            }
            
            generateDataSourcesFile() {
                const sources = Array.from(this.nodes.values()).filter(n => n.type === 'datasource');
                
                let code = `<span class="code-comment">"""
data_sources.py
===============

Data source configurations for ${this.repoSettings.name}.

This module defines connections to all data sources used by feature views.
Includes ownership information and access control documentation.

Generated by Feast Architect v3.0
Repository: ${this.repoSettings.location}
Date: ${new Date().toISOString().split('T')[0]}
"""</span>

<span class="code-keyword">from</span> datetime <span class="code-keyword">import</span> timedelta
<span class="code-keyword">from</span> feast <span class="code-keyword">import</span> FileSource, KafkaSource, PushSource
<span class="code-keyword">from</span> feast.types <span class="code-keyword">import</span> Float32, Int64, String, Bool

<span class="code-comment"># ==========================================</span>
<span class="code-comment"># DATA SOURCE CONFIGURATIONS</span>
<span class="code-comment"># ==========================================</span>

<span class="code-comment">"""
Available Data Sources:
${sources.map(s => {
    const dbName = s.dbType ? s.dbType.name : s.kind;
    return `- ${s.name} (${dbName}) [Owner: ${s.ownedBy}]`;
}).join('\n')}

Total: ${sources.length} data sources
"""</span>

`;
                
                if (sources.length === 0) {
                    code += `<span class="code-comment"># No data sources defined yet. Add data sources using the Feast Architect UI.</span>`;
                } else {
                    sources.forEach(node => {
                        const varName = node.name.toLowerCase().replace(/\s+/g, '_') + '_source';
                        const isSupported = node.debeziumAvailable;
                        const dbName = node.dbType ? node.dbType.name : node.kind;
                        
                        code += `<span class="code-comment">"""
${node.name} Data Source
${'-'.repeat(node.name.length + 12)}

Type: ${dbName}
Category: ${node.dbType ? node.dbType.category : 'Unknown'}
Debezium Support: ${node.debeziumAvailable ? 'Yes' : 'No'}
Owner: ${node.ownedBy}
${node.description ? `Description: ${node.description}` : ''}

Access Process:
${node.accessProcess ? node.accessProcess.split('\n').map(l => `    ${l}`).join('\n') : '    Contact data platform team'}

Spark Pattern: ${node.sparkPattern || 'Custom connector'}
Connection: ${node.details.connection || 'N/A'}
"""</span>
`;
                        
                        if (!isSupported) {
                            code += `<span class="code-comment"># NOTE: ${dbName} does not support Debezium CDC.</span>
<span class="code-comment"># Using PushSource pattern - requires custom ingestion pipeline.</span>
<span class="code-keyword">${varName}</span> = PushSource(
    name=<span class="code-string">"${node.name}_push"</span>,
    schema={
        "entity_id": String,
        "event_timestamp": String,
        "value": Float32
    }
)

<span class="code-comment"># TODO: Implement ${node.sparkPattern}</span>
<span class="code-comment"># Original connection: ${node.details.connection || 'N/A'}</span>

`;
                        } else if (node.kind.toLowerCase() === 'kafka') {
                            code += `<span class="code-keyword">${varName}</span> = KafkaSource(
    name=<span class="code-string">"${node.name}"</span>,
    kafka_bootstrap_servers=<span class="code-string">"${node.details.connection || 'localhost:9092'}"</span>,
    topic=<span class="code-string">"${node.details.topic || 'events'}"</span>,
    timestamp_field=<span class="code-string">"event_timestamp"</span>,
    message_format=<span class="code-string">"json"</span>
)

`;
                        } else {
                            code += `<span class="code-comment"># Debezium CDC enabled source</span>
<span class="code-keyword">${varName}</span> = KafkaSource(
    name=<span class="code-string">"${node.name}_cdc"</span>,
    kafka_bootstrap_servers=<span class="code-string">"kafka:9092"</span>,
    topic=<span class="code-string">"dbz.${node.name.toLowerCase().replace(/\s+/g, '_')}"</span>,
    timestamp_field=<span class="code-string">"event_timestamp"</span>,
    message_format=<span class="code-string">"json"</span>
)

`;
                        }
                    });
                }
                
                return code;
            }
            
            generateFeatureViewsFile() {
                const views = Array.from(this.nodes.values()).filter(n => n.type === 'featureview');
                const batchViews = views.filter(v => v.subtype === 'batch');
                const streamViews = views.filter(v => v.subtype === 'stream');
                const onDemandViews = views.filter(v => v.subtype === 'on_demand');
                
                let code = `<span class="code-comment">"""
feature_views.py
================

Feature view definitions for ${this.repoSettings.name}.

This module contains all feature views organized by type:
- Batch Feature Views: Historical data processed in batches
- Stream Feature Views: Real-time data from streaming sources  
- On-Demand Feature Views: Computed at request time

Generated by Feast Architect v3.0
Repository: ${this.repoSettings.location}
Date: ${new Date().toISOString().split('T')[0]}
"""</span>

<span class="code-keyword">from</span> datetime <span class="code-keyword">import</span> timedelta
<span class="code-keyword">from</span> feast <span class="code-keyword">import</span> Feature, FeatureView
<span class="code-keyword">from</span> feast.types <span class="code-keyword">import</span> Float32, Int64, String, Bool

<span class="code-comment"># Import entities and data sources</span>
<span class="code-keyword">from</span> .entities <span class="code-keyword">import</span> *
<span class="code-keyword">from</span> .data_sources <span class="code-keyword">import</span> *

<span class="code-comment"># ==========================================</span>
<span class="code-comment"># FEATURE VIEW STATISTICS</span>
<span class="code-comment"># ==========================================</span>

<span class="code-comment">"""
Total Feature Views: ${views.length}
- Batch: ${batchViews.length}
- Stream: ${streamViews.length}  
- On-Demand: ${onDemandViews.length}

Total Features: ${views.reduce((acc, v) => acc + v.features.length, 0)}
"""</span>

`;
                
                if (views.length === 0) {
                    code += `<span class="code-comment"># No feature views defined yet. Add feature views using the Feast Architect UI.</span>`;
                    return code;
                }
                
                if (batchViews.length > 0) {
                    code += `<span class="code-comment"># ==========================================</span>
<span class="code-comment"># BATCH FEATURE VIEWS</span>
<span class="code-comment"># ==========================================</span>

<span class="code-comment">"""
Batch feature views are computed on historical data and stored in the 
offline store. They are ideal for features that don't require real-time updates.
"""</span>

`;
                    batchViews.forEach(node => {
                        code += this.generateFeatureViewCode(node);
                    });
                }
                
                if (streamViews.length > 0) {
                    code += `<span class="code-comment"># ==========================================</span>
<span class="code-comment"># STREAM FEATURE VIEWS</span>
<span class="code-comment"># ==========================================</span>

<span class="code-comment">"""
Stream feature views process real-time data from Kafka or other streaming sources.
They provide low-latency features for online serving.
"""</span>

`;
                    streamViews.forEach(node => {
                        code += this.generateFeatureViewCode(node);
                    });
                }
                
                if (onDemandViews.length > 0) {
                    code += `<span class="code-comment"># ==========================================</span>
<span class="code-comment"># ON-DEMAND FEATURE VIEWS</span>
<span class="code-comment"># ==========================================</span>

<span class="code-comment">"""
On-demand feature views are computed at request time using transformation logic.
They are useful for features that depend on request context or cannot be pre-computed.
"""</span>

`;
                    onDemandViews.forEach(node => {
                        code += this.generateFeatureViewCode(node);
                    });
                }
                
                return code;
            }
            
            generateFeatureViewCode(node) {
                const varName = node.name.toLowerCase().replace(/\s+/g, '_');
                const entityNames = node.entities.map(e => {
                    const entity = this.nodes.get(e);
                    return entity ? entity.name.toLowerCase().replace(/\s+/g, '_') : 'entity';
                }).join(', ');
                
                const sourceName = node.inputs.length > 0 ? 
                    this.nodes.get(node.inputs[0])?.name?.toLowerCase().replace(/\s+/g, '_') + '_source' : 
                    'None';
                
                return `<span class="code-comment">"""
${node.name} Feature View
${'-'.repeat(node.name.length + 14)}

Type: ${node.subtype}
Entities: [${entityNames}]
Features: ${node.features.length}
TTL: ${node.details.ttl || '86400'} seconds

${node.description || 'No description provided.'}

Schema:
${node.features.map(f => `    - ${f.name} (${f.type})`).join('\n')}
"""</span>
<span class="code-keyword">${varName}</span> = FeatureView(
    name=<span class="code-string">"${node.name}"</span>,
    entities=[${entityNames}],
    ttl=timedelta(seconds=${node.details.ttl || '86400'}),
    schema=[
        ${node.features.map(f => `Feature(name=<span class="code-string">"${f.name}"</span>, dtype=${f.type})`).join(',\n        ')}
    ],
    online=True,
    source=${sourceName}${node.tags.length > 0 ? `,
    tags={${node.tags.map(t => `"${t}": ""`).join(', ')}}` : ''}
)

`;
            }
            
            generateServicesFile() {
                const services = Array.from(this.nodes.values()).filter(n => n.type === 'service');
                
                let code = `<span class="code-comment">"""
services.py
===========

Feature service definitions for ${this.repoSettings.name}.

Feature services group related features together for serving to applications.
They provide a stable API for feature retrieval while allowing the underlying
feature views to evolve.

Generated by Feast Architect v3.0
Repository: ${this.repoSettings.location}
Date: ${new Date().toISOString().split('T')[0]}
"""</span>

<span class="code-keyword">from</span> feast <span class="code-keyword">import</span> FeatureService

<span class="code-comment"># Import feature views</span>
<span class="code-keyword">from</span> .feature_views <span class="code-keyword">import</span> *

<span class="code-comment"># ==========================================</span>
<span class="code-comment"># FEATURE SERVICE DEFINITIONS</span>
<span class="code-comment"># ==========================================</span>

<span class="code-comment">"""
Available Feature Services:
${services.map(s => {
    const deps = s.features.length + (s.featureServices ? s.featureServices.length : 0);
    const consumers = s.details.usedBy ? s.details.usedBy.length : 0;
    return `- ${s.name} (${deps} dependencies, ${consumers} consumers)`;
}).join('\n')}

Total: ${services.length} feature services
"""</span>

`;
                
                if (services.length === 0) {
                    code += `<span class="code-comment"># No feature services defined yet. Add feature services using the Feast Architect UI.</span>`;
                } else {
                    services.forEach(node => {
                        const varName = node.name.toLowerCase().replace(/\s+/g, '_') + '_service';
                        const viewNames = node.features.map(f => {
                            const view = this.nodes.get(f);
                            return view ? view.name.toLowerCase().replace(/\s+/g, '_') : 'view';
                        }).join(', ');
                        
                        const usedBy = node.details.usedBy || [];
                        
                        code += `<span class="code-comment">"""
${node.name} Feature Service
${'-'.repeat(node.name.length + 16)}

${node.description || 'No description provided.'}

Dependencies:
${node.features.map(f => {
    const view = this.nodes.get(f);
    return view ? `    - ${view.name} (Feature View)` : '';
}).filter(Boolean).join('\n')}

Consumers:
${usedBy.length > 0 ? usedBy.map(u => {
    const app = typeof u === 'string' ? u : u.name;
    const env = typeof u === 'string' ? 'Production' : u.environment;
    return `    - ${app} (${env})`;
}).join('\n') : '    None defined'}

Usage:
    store.get_online_features(
        feature_service="${node.name}",
        entity_rows=[{"entity_id": "value"}]
    )
"""</span>
<span class="code-keyword">${varName}</span> = FeatureService(
    name=<span class="code-string">"${node.name}"</span>,
    features=[${viewNames}]${node.tags.length > 0 ? `,
    tags={${node.tags.map(t => `"${t}": ""`).join(', ')}}` : ''}${node.description ? `,
    description=<span class="code-string">"${node.description}"</span>` : ''}
)

`;
                    });
                }
                
                return code;
            }

            generateDebeziumConfigs() {
                const sources = Array.from(this.nodes.values()).filter(n => 
                    n.type === 'datasource' && n.debeziumAvailable
                );
                
                let code = `<span class="code-comment">"""
debezium_configs.py
===================

Debezium Connector configurations for CDC (Change Data Capture).

This module contains Python dictionaries representing Debezium connector
configurations for each supported database source.

Generated by Feast Architect v3.0
Date: ${new Date().toISOString().split('T')[0]}
"""</span>

<span class="code-comment"># ==========================================</span>
<span class="code-comment"># DEBEZIUM CONNECTOR CONFIGURATIONS</span>
<span class="code-comment"># ==========================================</span>

`;
                
                if (sources.length === 0) {
                    code += `<span class="code-comment"># No Debezium-compatible sources configured.</span>`;
                } else {
                    sources.forEach(node => {
                        const connectorName = node.name.toLowerCase().replace(/\s+/g, '_');
                        code += `<span class="code-comment"># ${node.name} CDC Connector</span>
<span class="code-keyword">${connectorName}_connector</span> = {
    "name": <span class="code-string">"${connectorName}-connector"</span>,
    "config": {
        "connector.class": <span class="code-string">"io.debezium.connector.${node.kind === 'postgres' ? 'postgresql' : node.kind}.DebeziumConnector"</span>,
        "database.hostname": <span class="code-string">"${node.details.connection?.split(':')[0] || 'localhost'}"</span>,
        "database.port": <span class="code-string">"${node.details.connection?.split(':')[1]?.split('/')[0] || '5432'}"</span>,
        "database.user": <span class="code-string">"debezium"</span>,
        "database.password": <span class="code-string">"dbz"</span>,
        "database.dbname": <span class="code-string">"${node.details.connection?.split('/').pop() || 'database'}"</span>,
        "database.server.name": <span class="code-string">"${connectorName}"</span>,
        "table.include.list": <span class="code-string">"public.*"</span>,
        "plugin.name": <span class="code-string">"pgoutput"</span>,
        "kafka.bootstrap.servers": <span class="code-string">"kafka:9092"</span>,
        "topic.prefix": <span class="code-string">"dbz"</span>,
        "tombstones.on.delete": <span class="code-string">"true"</span>,
        "decimal.handling.mode": <span class="code-string">"string"</span>
    }
}

`;
                    });
                }
                
                return code;
            }

            generateSparkJobs() {
                const streamViews = Array.from(this.nodes.values()).filter(n => 
                    n.type === 'featureview' && n.subtype === 'stream'
                );
                
                let code = `<span class="code-comment">"""
spark_jobs.py
=============

Spark Structured Streaming jobs for real-time feature computation.

This module contains PySpark code for processing CDC events from Kafka
and writing to the Postgres offline store.

Generated by Feast Architect v3.0
Date: ${new Date().toISOString().split('T')[0]}
"""</span>

<span class="code-keyword">from</span> pyspark.sql <span class="code-keyword">import</span> SparkSession
<span class="code-keyword">from</span> pyspark.sql.functions <span class="code-keyword">import</span> *
<span class="code-keyword">from</span> pyspark.sql.types <span class="code-keyword">import</span> *

<span class="code-comment"># Initialize Spark session with security context</span>
spark = SparkSession.builder \\
    .appName(<span class="code-string">"FeastStreaming"</span>) \\
    .config(<span class="code-string">"spark.sql.streaming.checkpointLocation"</span>, <span class="code-string">"/tmp/checkpoints"</span>) \\
    .config(<span class="code-string">"spark.hadoop.security.authentication"</span>, <span class="code-string">"kerberos"</span>) \\
    .getOrCreate()

<span class="code-comment"># ==========================================</span>
<span class="code-comment"># STREAMING JOBS</span>
<span class="code-comment"># ==========================================</span>

`;
                
                if (streamViews.length === 0) {
                    code += `<span class="code-comment"># No streaming feature views configured.</span>`;
                } else {
                    streamViews.forEach(view => {
                        const jobName = view.name.toLowerCase().replace(/\s+/g, '_');
                        code += `<span class="code-keyword">def</span> <span class="code-function">${jobName}_job</span>():
    <span class="code-comment">"""
    Streaming job for ${view.name}
    Reads from Kafka, processes aggregations, writes to Postgres
    """</span>
    
    <span class="code-comment"># Read from Kafka</span>
    df = spark \\
        .readStream \\
        .format(<span class="code-string">"kafka"</span>) \\
        .option(<span class="code-string">"kafka.bootstrap.servers"</span>, <span class="code-string">"kafka:9092"</span>) \\
        .option(<span class="code-string">"subscribe"</span>, <span class="code-string">"dbz.${view.inputs[0] ? this.nodes.get(view.inputs[0])?.name?.toLowerCase().replace(/\s+/g, '_') : 'source'}"</span>) \\
        .option(<span class="code-string">"startingOffsets"</span>, <span class="code-string">"latest"</span>) \\
        .load()
    
    <span class="code-comment"># Parse JSON payload</span>
    parsed = df.select(
        from_json(col(<span class="code-string">"value"</span>).cast(<span class="code-string">"string"</span>), schema).alias(<span class="code-string">"data"</span>)
    ).select(<span class="code-string">"data.*"</span>)
    
    <span class="code-comment"># Apply transformations</span>
    transformed = parsed \\
        .withWatermark(<span class="code-string">"event_timestamp"</span>, <span class="code-string">"10 minutes"</span>) \\
        .groupBy(
            window(<span class="code-string">"event_timestamp"</span>, <span class="code-string">"5 minutes"</span>),
            <span class="code-string">"entity_id"</span>
        ) \\
        .agg(
            ${view.features.map(f => `sum(<span class="code-string">"${f.name}"</span>).alias(<span class="code-string">"${f.name}"</span>)`).join(',\n            ')}
        )
    
    <span class="code-comment"># Write to Postgres with RLS context</span>
    query = transformed.writeStream \\
        .foreachBatch(<span class="code-keyword">lambda</span> batch_df, batch_id: 
            batch_df.write \\
                .mode(<span class="code-string">"append"</span>) \\
                .jdbc(<span class="code-string">"jdbc:postgresql://postgres:5432/feast"</span>, 
                      <span class="code-string">"${jobName}"</span>,
                      properties={<span class="code-string">"user"</span>: <span class="code-string">"feast"</span>, <span class="code-string">"password"</span>: <span class="code-string">"feast"</span>})
        ) \\
        .start()
    
    <span class="code-keyword">return</span> query

`;
                    });
                }
                
                return code;
            }

            generateDjangoModels() {
                return `<span class="code-comment">"""
django_models.py
================

Django models for access control and audit logging.

Generated by Feast Architect v3.0
Date: ${new Date().toISOString().split('T')[0]}
"""</span>

<span class="code-keyword">from</span> django.db <span class="code-keyword">import</span> models
<span class="code-keyword">from</span> django.contrib.auth.models <span class="code-keyword">import</span> User

<span class="code-keyword">class</span> <span class="code-class">DataSourceAccess</span>(models.Model):
    <span class="code-comment">"""
    Tracks user access permissions to data sources
    """</span>
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    data_source_name = models.CharField(max_length=255)
    permission_level = models.CharField(
        choices=[
            (<span class="code-string">'owned'</span>, <span class="code-string">'Owned'</span>),
            (<span class="code-string">'granted'</span>, <span class="code-string">'Granted'</span>),
            (<span class="code-string">'pending'</span>, <span class="code-string">'Pending'</span>),
            (<span class="code-string">'denied'</span>, <span class="code-string">'Denied'</span>),
        ],
        max_length=20
    )
    requested_at = models.DateTimeField(auto_now_add=True)
    granted_at = models.DateTimeField(null=True, blank=True)
    granted_by = models.ForeignKey(
        User, 
        on_delete=models.SET_NULL, 
        null=True, 
        blank=True,
        related_name=<span class="code-string">'granted_access'</span>
    )
    
    <span class="code-keyword">class</span> <span class="code-class">Meta</span>:
        unique_together = [<span class="code-string">'user'</span>, <span class="code-string">'data_source_name'</span>]

<span class="code-keyword">class</span> <span class="code-class">AuditLog</span>(models.Model):
    <span class="code-comment">"""
    Audit trail for all data access events
    """</span>
    timestamp = models.DateTimeField(auto_now_add=True)
    user = models.ForeignKey(User, on_delete=models.SET_NULL, null=True)
    action = models.CharField(max_length=50)
    resource_type = models.CharField(max_length=50)
    resource_name = models.CharField(max_length=255)
    details = models.JSONField(default=dict)
    ip_address = models.GenericIPAddressField()
    
    <span class="code-keyword">class</span> <span class="code-class">Meta</span>:
        ordering = [<span class="code-string">'-timestamp'</span>]

<span class="code-keyword">class</span> <span class="code-class">ColumnSecurity</span>(models.Model):
    <span class="code-comment">"""
    Column-level security policies
    """</span>
    data_source = models.CharField(max_length=255)
    column_name = models.CharField(max_length=255)
    security_level = models.CharField(
        choices=[
            (<span class="code-string">'accessible'</span>, <span class="code-string">'Accessible'</span>),
            (<span class="code-string">'masked'</span>, <span class="code-string">'Masked'</span>),
            (<span class="code-string">'denied'</span>, <span class="code-string">'Denied'</span>),
        ],
        max_length=20
    )
    pii_classification = models.CharField(
        choices=[
            (<span class="code-string">'none'</span>, <span class="code-string">'None'</span>),
            (<span class="code-string">'low'</span>, <span class="code-string">'Low'</span>),
            (<span class="code-string">'medium'</span>, <span class="code-string">'Medium'</span>),
            (<span class="code-string">'high'</span>, <span class="code-string">'High'</span>),
        ],
        max_length=20
    )`;
            }

            generatePostgresRLS() {
                return `<span class="code-comment">-- postgres_rls.sql
-- Row Level Security policies for Postgres offline store
-- Generated by Feast Architect v3.0

-- Enable RLS on feature tables
ALTER TABLE feature_store ENABLE ROW LEVEL SECURITY;

-- Create policy for team-based access
CREATE POLICY team_isolation_policy ON feature_store
    USING (
        team_id = current_setting('app.current_team')::INTEGER
        OR 
        current_setting('app.user_role') = 'admin'
    );

-- Create policy for PII masking
CREATE POLICY pii_masking_policy ON feature_store
    USING (true)
    WITH CHECK (
        current_setting('app.pii_access') = 'true'
        OR
        NOT EXISTS (
            SELECT 1 FROM pii_columns 
            WHERE table_name = 'feature_store'
        )
    );

-- Function to set security context
CREATE OR REPLACE FUNCTION set_security_context(
    user_id INTEGER,
    team_id INTEGER,
    user_role VARCHAR,
    pii_access BOOLEAN
) RETURNS VOID AS $$
BEGIN
    PERFORM set_config('app.current_user', user_id::TEXT, false);
    PERFORM set_config('app.current_team', team_id::TEXT, false);
    PERFORM set_config('app.user_role', user_role, false);
    PERFORM set_config('app.pii_access', pii_access::TEXT, false);
END;
$$ LANGUAGE plpgsql;</span>`;
            }
            
            generateJSONExport() {
                const data = {
                    repository: this.repoSettings,
                    exportDate: new Date().toISOString(),
                    version: '3.0',
                    nodes: Array.from(this.nodes.entries()),
                    edges: this.edges,
                    stats: {
                        totalNodes: this.nodes.size,
                        totalEdges: this.edges.length,
                        totalFeatures: Array.from(this.nodes.values()).reduce((acc, n) => acc + (n.features?.length || 0), 0)
                    }
                };
                return `<span class="code-keyword">${JSON.stringify(data, null, 2).replace(/"([^"]+)":/g, '<span class="code-string">"$1"</span>:').replace(/: "([^"]+)"/g, ': <span class="code-string">"$1"</span>')}</span>`;
            }
            
            generateYAMLConfig() {
                return `<span class="code-comment">"""
feature_store.yaml
==================

Feature store configuration for ${this.repoSettings.name}.

This file configures the Feast feature store infrastructure including
the registry, online store, and offline store settings.
"""</span>

<span class="code-keyword">project:</span> <span class="code-string">${this.repoSettings.name}</span>
<span class="code-keyword">registry:</span> <span class="code-string">data/registry.db</span>
<span class="code-keyword">provider:</span> <span class="code-string">local</span>

<span class="code-comment"># Online store configuration for low-latency serving</span>
<span class="code-keyword">online_store:</span>
  <span class="code-keyword">type:</span> <span class="code-string">redis</span>
  <span class="code-keyword">connection_string:</span> <span class="code-string">localhost:6379</span>

<span class="code-comment"># Offline store configuration for batch processing</span>
<span class="code-keyword">offline_store:</span>
  <span class="code-keyword">type:</span> <span class="code-string">postgres</span>
  <span class="code-keyword">host:</span> <span class="code-string">postgres</span>
  <span class="code-keyword">port:</span> <span class="code-string">5432</span>
  <span class="code-keyword">database:</span> <span class="code-string">feast</span>
  <span class="code-keyword">schema:</span> <span class="code-string">offline</span>

<span class="code-comment"># Entity key serialization version</span>
<span class="code-keyword">entity_key_serialization_version:</span> <span class="code-string">2</span>

<span class="code-comment"># Feature server configuration</span>
<span class="code-keyword">feature_server:</span>
  <span class="code-keyword">enabled:</span> <span class="code-string">true</span>
  <span class="code-keyword">port:</span> <span class="code-string">6566</span>`;
            }
            
            copyCodeEditor() {
                const content = document.getElementById('codeEditorContent').innerText;
                navigator.clipboard.writeText(content);
                this.showNotification('Copied', 'Code copied to clipboard');
            }
            
            showAddMenu() {
                const menu = document.querySelector('.fab-menu');
                const buttons = ['fabSource', 'fabEntity', 'fabView', 'fabService'];
                const isVisible = document.getElementById('fabSource').style.display !== 'none';
                
                buttons.forEach((id, idx) => {
                    setTimeout(() => {
                        document.getElementById(id).style.display = isVisible ? 'none' : 'flex';
                    }, idx * 50);
                });
            }
            
            showAddModal(type) {
                this.currentModalType = type;
                this.tempFeatures = [];
                this.tempTags = [];
                this.editingNode = null;
                document.getElementById('deleteBtn').style.display = 'none';
                this.openModal(type);
            }
            
            showEditModal(id) {
                const node = this.nodes.get(id);
                if (!node) return;
                
                this.editingNode = id;
                this.currentModalType = node.type;
                this.tempFeatures = node.features ? [...node.features] : [];
                this.tempTags = node.tags ? [...node.tags] : [];
                document.getElementById('deleteBtn').style.display = 'inline-flex';
                this.openModal(node.type, node);
            }
            
            openModal(type, existingNode = null) {
                const modal = document.getElementById('componentModal');
                const title = document.getElementById('modalTitle');
                const body = document.getElementById('modalBody');
                
                const titles = {
                    datasource: existingNode ? 'Edit Data Source' : 'Add Data Source',
                    entity: existingNode ? 'Edit Entity' : 'Add Entity',
                    featureview: existingNode ? 'Edit Feature View' : 'Add Feature View',
                    service: existingNode ? 'Edit Feature Service' : 'Add Feature Service'
                };
                
                title.textContent = titles[type];
                
                let html = '';
                
                html += `
                    <div class="form-group">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-input" id="inputName" 
                            value="${existingNode ? existingNode.name : ''}" 
                            placeholder="e.g., User Demographics">
                    </div>
                `;
                
                if (type === 'datasource') {
                    // Generate options from comprehensive database types
                    const dbOptions = Object.entries(this.databaseTypes).map(([key, db]) => 
                        `<option value="${key}" ${existingNode?.kind === key ? 'selected' : ''}>${db.icon} ${db.name}</option>`
                    ).join('');
                    
                    html += `
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Source Type</label>
                                <select class="form-select" id="inputKind" onchange="diagram.updateDBTypeInfo()">
                                    <option value="">Select database...</option>
                                    <optgroup label="Relational">
                                        ${Object.entries(this.databaseTypes).filter(([k,v]) => v.category === 'Relational').map(([k,v]) => `<option value="${k}" ${existingNode?.kind === k ? 'selected' : ''}>${v.icon} ${v.name}</option>`).join('')}
                                    </optgroup>
                                    <optgroup label="NoSQL">
                                        ${Object.entries(this.databaseTypes).filter(([k,v]) => v.category === 'NoSQL').map(([k,v]) => `<option value="${k}" ${existingNode?.kind === k ? 'selected' : ''}>${v.icon} ${v.name}</option>`).join('')}
                                    </optgroup>
                                    <optgroup label="Cloud Warehouse">
                                        ${Object.entries(this.databaseTypes).filter(([k,v]) => v.category === 'Cloud Warehouse').map(([k,v]) => `<option value="${k}" ${existingNode?.kind === k ? 'selected' : ''}>${v.icon} ${v.name}</option>`).join('')}
                                    </optgroup>
                                    <optgroup label="Streaming">
                                        ${Object.entries(this.databaseTypes).filter(([k,v]) => v.category === 'Streaming').map(([k,v]) => `<option value="${k}" ${existingNode?.kind === k ? 'selected' : ''}>${v.icon} ${v.name}</option>`).join('')}
                                    </optgroup>
                                    <optgroup label="Object Storage">
                                        ${Object.entries(this.databaseTypes).filter(([k,v]) => v.category === 'Object Storage').map(([k,v]) => `<option value="${k}" ${existingNode?.kind === k ? 'selected' : ''}>${v.icon} ${v.name}</option>`).join('')}
                                    </optgroup>
                                    <optgroup label="In-Memory">
                                        ${Object.entries(this.databaseTypes).filter(([k,v]) => v.category === 'In-Memory').map(([k,v]) => `<option value="${k}" ${existingNode?.kind === k ? 'selected' : ''}>${v.icon} ${v.name}</option>`).join('')}
                                    </optgroup>
                                    <optgroup label="Graph">
                                        ${Object.entries(this.databaseTypes).filter(([k,v]) => v.category === 'Graph').map(([k,v]) => `<option value="${k}" ${existingNode?.kind === k ? 'selected' : ''}>${v.icon} ${v.name}</option>`).join('')}
                                    </optgroup>
                                    <optgroup label="Time-Series">
                                        ${Object.entries(this.databaseTypes).filter(([k,v]) => v.category === 'Time-Series').map(([k,v]) => `<option value="${k}" ${existingNode?.kind === k ? 'selected' : ''}>${v.icon} ${v.name}</option>`).join('')}
                                    </optgroup>
                                    <optgroup label="Others">
                                        ${Object.entries(this.databaseTypes).filter(([k,v]) => !['Relational', 'NoSQL', 'Cloud Warehouse', 'Streaming', 'Object Storage', 'In-Memory', 'Graph', 'Time-Series'].includes(v.category)).map(([k,v]) => `<option value="${k}" ${existingNode?.kind === k ? 'selected' : ''}>${v.icon} ${v.name}</option>`).join('')}
                                    </optgroup>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Connection (optional)</label>
                                <input type="text" class="form-input" id="inputConnection" 
                                    value="${existingNode?.details?.connection || ''}"
                                    placeholder="host:port/db">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Owned By</label>
                            <input type="text" class="form-input" id="inputOwnedBy" 
                                value="${existingNode?.ownedBy || this.repoSettings.defaultOwner}"
                                placeholder="Team name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Access Process</label>
                            <textarea class="form-textarea" id="inputAccessProcess" placeholder="Steps to get access...">${existingNode?.accessProcess || ''}</textarea>
                            <div class="form-hint" id="dbTypeHint">${existingNode?.dbType ? `Default: ${existingNode.dbType.defaultProcess}` : 'Select a database type to see default access process'}</div>
                        </div>
                    `;
                } else if (type === 'entity') {
                    html += `
                        <div class="form-group">
                            <label class="form-label">Join Key *</label>
                            <input type="text" class="form-input" id="inputJoinKey" 
                                value="${existingNode ? existingNode.joinKey : 'id'}"
                                placeholder="e.g., user_id">
                            <div class="form-hint">The column name used to join features</div>
                        </div>
                    `;
                } else if (type === 'featureview') {
                    const entities = Array.from(this.nodes.values())
                        .filter(n => n.type === 'entity')
                        .map(e => `<option value="${e.id}" ${existingNode?.entities?.includes(e.id) ? 'selected' : ''}>${e.name}</option>`)
                        .join('');
                    
                    html += `
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">View Type</label>
                                <select class="form-select" id="inputSubtype">
                                    <option value="batch" ${existingNode?.subtype === 'batch' ? 'selected' : ''}>Batch</option>
                                    <option value="stream" ${existingNode?.subtype === 'stream' ? 'selected' : ''}>Stream</option>
                                    <option value="on_demand" ${existingNode?.subtype === 'on_demand' ? 'selected' : ''}>On-Demand</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">TTL (seconds)</label>
                                <input type="number" class="form-input" id="inputTTL" 
                                    value="${existingNode?.details?.ttl || ''}"
                                    placeholder="86400">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Entities *</label>
                            <select class="form-select" id="inputEntities" multiple size="3">
                                ${entities}
                            </select>
                            <div class="form-hint">Hold Ctrl/Cmd to select multiple</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Features</label>
                            <div class="features-builder">
                                <div class="features-list-builder" id="featuresList">
                                    ${this.tempFeatures.map((f, idx) => `
                                        <div class="feature-tag-builder">
                                            <div class="feature-tag-info">
                                                <span class="feature-tag-name">${f.name}</span>
                                                <span class="feature-tag-type">${f.type}</span>
                                            </div>
                                            <button class="feature-tag-remove" onclick="diagram.removeFeature(${idx})">√ó</button>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="feature-input-row" style="margin-top: 12px;">
                                    <input type="text" class="form-input feature-input" id="featureName" placeholder="Feature name">
                                    <select class="form-select" id="featureType" style="width: 140px;">
                                        <option value="String">String</option>
                                        <option value="Int64">Int64</option>
                                        <option value="Float32">Float32</option>
                                        <option value="Float64">Float64</option>
                                        <option value="Bool">Bool</option>
                                    </select>
                                    <button class="btn btn-primary" onclick="diagram.addFeature()">Add</button>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (type === 'service') {
                    const views = Array.from(this.nodes.values())
                        .filter(n => n.type === 'featureview')
                        .map(v => `<option value="${v.id}" ${existingNode?.features?.includes(v.id) ? 'selected' : ''}>${v.name}</option>`)
                        .join('');
                    
                    const services = Array.from(this.nodes.values())
                        .filter(n => n.type === 'service' && n.id !== existingNode?.id)
                        .map(s => `<option value="${s.id}" ${existingNode?.featureServices?.includes(s.id) ? 'selected' : ''}>${s.name}</option>`)
                        .join('');
                    
                    html += `
                        <div class="form-group">
                            <label class="form-label">Feature Views</label>
                            <select class="form-select" id="inputFeatures" multiple size="4">
                                ${views}
                            </select>
                        </div>
                        
                        ${services ? `
                        <div class="form-group">
                            <label class="form-label">Feature Services (dependencies)</label>
                            <select class="form-select" id="inputFeatureServices" multiple size="3">
                                ${services}
                            </select>
                            <div class="form-hint">Optional: compose from other services</div>
                        </div>
                        ` : ''}
                        
                        <div class="form-group">
                            <label class="form-label">Used By Applications (comma-separated)</label>
                            <input type="text" class="form-input" id="inputUsedBy" 
                                value="${existingNode?.details?.usedBy ? existingNode.details.usedBy.map(u => typeof u === 'string' ? u : u.name).join(', ') : ''}"
                                placeholder="e.g., recommendation-api, fraud-service">
                            <div class="form-hint">Applications that consume this service</div>
                        </div>
                    `;
                }
                
                html += `
                    <div class="form-group">
                        <label class="form-label">Tags</label>
                        <div class="features-builder">
                            <div class="features-list-builder" id="tagsList">
                                ${this.tempTags.map((tag, idx) => `
                                    <div class="feature-tag-builder">
                                        <div class="feature-tag-info">
                                            <span class="feature-tag-name">#${tag}</span>
                                        </div>
                                        <button class="feature-tag-remove" onclick="diagram.removeTag(${idx})">√ó</button>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="feature-input-row" style="margin-top: 12px;">
                                <input type="text" class="form-input feature-input" id="tagInput" placeholder="Add tag..." onkeypress="if(event.key==='Enter') diagram.addTag()">
                                <button class="btn btn-primary" onclick="diagram.addTag()">Add Tag</button>
                            </div>
                        </div>
                    </div>
                `;
                
                html += `
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" id="inputDescription" placeholder="Describe this component...">${existingNode ? existingNode.description : ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Notes (internal documentation)</label>
                        <textarea class="form-textarea" id="inputNotes" placeholder="Add implementation notes, SLAs, ownership info...">${existingNode ? existingNode.details?.notes || '' : ''}</textarea>
                    </div>
                `;
                
                body.innerHTML = html;
                modal.classList.add('active');
            }

            updateDBTypeInfo() {
                const kind = document.getElementById('inputKind').value;
                const dbType = this.databaseTypes[kind];
                if (dbType) {
                    document.getElementById('dbTypeHint').textContent = `Default process: ${dbType.defaultProcess}`;
                }
            }
            
            addFeature() {
                const name = document.getElementById('featureName').value.trim();
                const type = document.getElementById('featureType').value;
                
                if (name) {
                    this.tempFeatures.push({ name, type });
                    document.getElementById('featureName').value = '';
                    this.renderFeaturesList();
                }
            }
            
            removeFeature(idx) {
                this.tempFeatures.splice(idx, 1);
                this.renderFeaturesList();
            }
            
            renderFeaturesList() {
                const container = document.getElementById('featuresList');
                if (!container) return;
                
                container.innerHTML = this.tempFeatures.map((f, idx) => `
                    <div class="feature-tag-builder">
                        <div class="feature-tag-info">
                            <span class="feature-tag-name">${f.name}</span>
                            <span class="feature-tag-type">${f.type}</span>
                        </div>
                        <button class="feature-tag-remove" onclick="diagram.removeFeature(${idx})">√ó</button>
                    </div>
                `).join('');
            }
            
            addTag() {
                const input = document.getElementById('tagInput');
                const tag = input.value.trim().toLowerCase().replace(/\s+/g, '_');
                
                if (tag && !this.tempTags.includes(tag)) {
                    this.tempTags.push(tag);
                    input.value = '';
                    this.renderTagsList();
                }
            }
            
            removeTag(idx) {
                this.tempTags.splice(idx, 1);
                this.renderTagsList();
            }
            
            renderTagsList() {
                const container = document.getElementById('tagsList');
                if (!container) return;
                
                container.innerHTML = this.tempTags.map((tag, idx) => `
                    <div class="feature-tag-builder">
                        <div class="feature-tag-info">
                            <span class="feature-tag-name">#${tag}</span>
                        </div>
                        <button class="feature-tag-remove" onclick="diagram.removeTag(${idx})">√ó</button>
                    </div>
                `).join('');
            }
            
            saveComponent() {
                const name = document.getElementById('inputName').value.trim();
                if (!name) {
                    alert('Name is required');
                    return;
                }
                
                const description = document.getElementById('inputDescription')?.value || '';
                const notes = document.getElementById('inputNotes')?.value || '';
                
                const baseConfig = {
                    name,
                    description,
                    tags: [...this.tempTags],
                    details: { notes }
                };
                
                if (this.editingNode) {
                    const node = this.nodes.get(this.editingNode);
                    node.name = name;
                    node.description = description;
                    node.tags = [...this.tempTags];
                    node.details.notes = notes;
                    
                    if (node.type === 'datasource') {
                        const kind = document.getElementById('inputKind').value;
                        node.kind = kind;
                        node.dbType = this.databaseTypes[kind];
                        node.details.connection = document.getElementById('inputConnection')?.value || '';
                        node.ownedBy = document.getElementById('inputOwnedBy')?.value || this.repoSettings.defaultOwner;
                        node.accessProcess = document.getElementById('inputAccessProcess')?.value || '';
                        node.debeziumAvailable = node.dbType ? node.dbType.debezium : false;
                        node.sparkPattern = node.dbType ? node.dbType.sparkPattern : 'Custom connector';
                    } else if (node.type === 'entity') {
                        node.joinKey = document.getElementById('inputJoinKey').value || 'id';
                    } else if (node.type === 'featureview') {
                        node.subtype = document.getElementById('inputSubtype').value;
                        node.details.ttl = document.getElementById('inputTTL')?.value || '';
                        node.features = [...this.tempFeatures];
                        
                        const entitySelect = document.getElementById('inputEntities');
                        const selectedEntities = Array.from(entitySelect.selectedOptions).map(o => o.value);
                        
                        this.edges = this.edges.filter(e => e.to !== this.editingNode);
                        node.inputs = [];
                        
                        node.entities = selectedEntities;
                        selectedEntities.forEach(eid => this.addConnection(eid, this.editingNode));
                    } else if (node.type === 'service') {
                        const fvSelect = document.getElementById('inputFeatures');
                        const selectedFVs = Array.from(fvSelect.selectedOptions).map(o => o.value);
                        
                        const fsSelect = document.getElementById('inputFeatureServices');
                        const selectedFSs = fsSelect ? Array.from(fsSelect.selectedOptions).map(o => o.value) : [];
                        
                        this.edges = this.edges.filter(e => e.to !== this.editingNode);
                        node.inputs = [];
                        
                        node.features = selectedFVs;
                        node.featureServices = selectedFSs;
                        selectedFVs.forEach(fvid => this.addConnection(fvid, this.editingNode));
                        selectedFSs.forEach(fsid => this.addConnection(fsid, this.editingNode));
                        
                        const usedBy = document.getElementById('inputUsedBy')?.value || '';
                        node.details.usedBy = usedBy.split(',').map(s => s.trim()).filter(s => s).map(s => ({ name: s, environment: 'Production' }));
                    }
                    
                    if (this.selectedNode === this.editingNode) {
                        this.showPanel(this.editingNode);
                    }
                    
                    this.showNotification('Updated', `"${name}" has been updated`);
                } else {
                    let newId;
                    
                    if (this.currentModalType === 'datasource') {
                        const kind = document.getElementById('inputKind').value;
                        newId = this.addDatasource({
                            ...baseConfig,
                            kind: kind,
                            ownedBy: document.getElementById('inputOwnedBy')?.value || this.repoSettings.defaultOwner,
                            accessProcess: document.getElementById('inputAccessProcess')?.value || '',
                            details: {
                                ...baseConfig.details,
                                connection: document.getElementById('inputConnection')?.value || ''
                            }
                        });
                    } else if (this.currentModalType === 'entity') {
                        newId = this.addEntity({
                            ...baseConfig,
                            joinKey: document.getElementById('inputJoinKey').value || 'id'
                        });
                    } else if (this.currentModalType === 'featureview') {
                        const entitySelect = document.getElementById('inputEntities');
                        const selectedEntities = Array.from(entitySelect.selectedOptions).map(o => o.value);
                        
                        newId = this.addFeatureView({
                            ...baseConfig,
                            subtype: document.getElementById('inputSubtype').value,
                            entities: selectedEntities,
                            features: [...this.tempFeatures],
                            details: {
                                ...baseConfig.details,
                                ttl: document.getElementById('inputTTL')?.value || ''
                            }
                        });
                    } else if (this.currentModalType === 'service') {
                        const fvSelect = document.getElementById('inputFeatures');
                        const selectedFVs = Array.from(fvSelect.selectedOptions).map(o => o.value);
                        
                        const fsSelect = document.getElementById('inputFeatureServices');
                        const selectedFSs = fsSelect ? Array.from(fsSelect.selectedOptions).map(o => o.value) : [];
                        
                        const usedBy = document.getElementById('inputUsedBy')?.value || '';
                        
                        newId = this.addService({
                            ...baseConfig,
                            features: selectedFVs,
                            featureServices: selectedFSs,
                            details: {
                                ...baseConfig.details,
                                usedBy: usedBy.split(',').map(s => s.trim()).filter(s => s).map(s => ({ name: s, environment: 'Production' }))
                            }
                        });
                    }
                    
                    if (newId) {
                        this.selectNode(newId);
                        this.showNotification('Created', `"${name}" has been created`);
                    }
                }
                
                this.closeModal();
                this.autoLayout();
                this.updateCodeEditor();
            }
            
            closeModal() {
                document.getElementById('componentModal').classList.remove('active');
                this.currentModalType = null;
                this.tempFeatures = [];
                this.tempTags = [];
                this.editingNode = null;
            }
            
            toggleLayer(type) {
                this.visibleLayers[type] = !this.visibleLayers[type];
                this.updateLayerToggles();
            }
            
            updateLayerToggles() {
                const toggles = {
                    datasource: 'toggleSources',
                    entity: 'toggleEntities',
                    featureview: 'toggleViews',
                    service: 'toggleServices'
                };
                
                Object.entries(toggles).forEach(([type, id]) => {
                    const btn = document.getElementById(id);
                    if (this.visibleLayers[type]) {
                        btn.classList.remove('hidden-layer');
                        btn.querySelector('.eye-icon').textContent = 'üëÅ';
                    } else {
                        btn.classList.add('hidden-layer');
                        btn.querySelector('.eye-icon').textContent = 'üö´';
                    }
                });
            }
            
            zoomIn() {
                this.scale = Math.min(4, this.scale * 1.2);
            }
            
            zoomOut() {
                this.scale = Math.max(0.1, this.scale / 1.2);
            }
            
            fit() {
                if (this.nodes.size === 0) return;
                
                const bounds = this.getBounds();
                const padding = 100;
                
                const scaleX = (this.width - padding * 2) / bounds.width;
                const scaleY = (this.height - padding * 2) / bounds.height;
                this.scale = Math.min(scaleX, scaleY, 1.5);
                
                this.offsetX = (this.width - bounds.width * this.scale) / 2 - bounds.minX * this.scale;
                this.offsetY = (this.height - bounds.height * this.scale) / 2 - bounds.minY * this.scale;
            }
            
            resetView() {
                this.scale = 1;
                this.offsetX = 50;
                this.offsetY = 50;
            }
            
            reset() {
                this.nodes.clear();
                this.edges = [];
                this.counters = { datasource: 0, entity: 0, featureview: 0, service: 0 };
                this.selectedNode = null;
                this.closePanel();
                this.updateStats();
                this.loadComplexExample();
                this.showNotification('Reset', 'Diagram has been reset to example data');
                setTimeout(() => this.fit(), 100);
            }
            
            async export() {
                // If we have a repo ID, use backend export endpoint for consistency
                if (this.repoId) {
                    try {
                        const response = await fetch(`${this.apiBaseUrl}/repositories/${this.repoId}/export_json/?include_hash=true`);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        // Download
                        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${data.repository.name}-${new Date().toISOString().split('T')[0]}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                        
                        this.showNotification('Exported', 'Architecture exported from server');
                        return;
                        
                    } catch (error) {
                        console.error('Backend export failed, falling back to local:', error);
                        // Fall through to local export
                    }
                }
                
                // Local export fallback
                const data = {
                    repository: this.repoSettings,
                    nodes: Array.from(this.nodes.entries()),
                    edges: this.edges,
                    exportDate: new Date().toISOString(),
                    version: '3.0'
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${this.repoSettings.name}-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                this.showNotification('Exported', 'Architecture saved to JSON file');
            }
            
            import() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    // If we have a repo ID, use backend import
                    if (this.repoId) {
                        if (!confirm('This will create a new repository from the file. Continue?')) {
                            return;
                        }
                        
                        try {
                            const formData = new FormData();
                            formData.append('file', file);
                            
                            const response = await fetch(`${this.apiBaseUrl}/repositories/import_json/`, {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': this.getCsrfToken()
                                },
                                body: formData
                            });
                            
                            const data = await response.json();
                            
                            if (!response.ok) {
                                if (response.status === 409) {
                                    alert(`Import conflict: ${data.detail}\n\nExisting ID: ${data.existing_id}`);
                                    return;
                                }
                                throw new Error(data.detail || `HTTP ${response.status}`);
                            }
                            
                            // Redirect to new repo
                            window.location.href = `/ui/feast?repo_id=${data.id}`;
                            return;
                            
                        } catch (error) {
                            alert('Backend import failed: ' + error.message + '\n\nFalling back to local import.');
                            // Fall through to local import
                        }
                    }
                    
                    // Local import
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            
                            if (data.repository) {
                                this.repoSettings = {
                                    ...data.repository,
                                    id: null // Reset ID since this is local
                                };
                                this.updateRepoSubtitle();
                            }
                            
                            this.nodes.clear();
                            this.edges = [];
                            
                            // Handle both formats (backend export has 'architecture' key)
                            const arch = data.architecture || data;
                            const nodes = arch.nodes || data.nodes;
                            const edges = arch.edges || data.edges;
                            
                            if (nodes) {
                                // Handle both Map entries array and object formats
                                const nodeEntries = Array.isArray(nodes) ? nodes : Object.entries(nodes);
                                nodeEntries.forEach(([id, node]) => {
                                    this.nodes.set(id, node);
                                    const type = node.type;
                                    if (this.counters[type] !== undefined) {
                                        const num = parseInt(id.split('_').pop()) || 0;
                                        if (num > this.counters[type]) {
                                            this.counters[type] = num;
                                        }
                                    }
                                });
                            }
                            
                            if (edges) {
                                this.edges = edges.filter(edge => {
                                    return this.nodes.has(edge.from) && this.nodes.has(edge.to);
                                });
                                
                                this.nodes.forEach(node => {
                                    node.inputs = [];
                                    node.outputs = [];
                                });
                                
                                this.edges.forEach(edge => {
                                    const fromNode = this.nodes.get(edge.from);
                                    const toNode = this.nodes.get(edge.to);
                                    if (fromNode && toNode) {
                                        fromNode.outputs.push(edge.to);
                                        toNode.inputs.push(edge.from);
                                    }
                                });
                            }
                                                        
                            this.updateStats();
                            this.fit();
                            this.showNotification('Imported', `Loaded ${this.nodes.size} components`);
                            this.updateCodeEditor();
                        } catch (err) {
                            alert('Error importing file: ' + err.message);
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            }
            
            showGuide() {
                document.getElementById('guideModal').classList.add('active');
                
                // Initialize mermaid diagrams if library is loaded
                if (window.mermaid) {
                    setTimeout(() => {
                        mermaid.init(undefined, document.querySelectorAll('.mermaid'));
                    }, 100);
                }
                
                // Default to overview context
                this.switchGuideContext('overview');
            }

            renderPatternLibrary() {
                // This method is now deprecated - patterns are shown in Data Engineer context
                // Kept for backward compatibility but does nothing
                console.log('Pattern library moved to Data Engineer guide context');
            }

            loadPattern(patternName) {
                this.showNotification('Loading Pattern', `Importing ${patternName} architecture...`);
                // Implementation would load predefined architectures
                document.getElementById('guideModal').classList.remove('active');
            }
            
            showStatsModal() {
                const modal = document.getElementById('statsModal');
                const grid = document.getElementById('statsGrid');
                
                const stats = {
                    datasource: { count: 0, items: [], color: '#3b82f6', icon: 'üóÑÔ∏è' },
                    entity: { count: 0, items: [], color: '#8b5cf6', icon: 'üë§' },
                    featureview: { count: 0, items: [], color: '#10b981', icon: 'üìä' },
                    service: { count: 0, items: [], color: '#f97316', icon: 'üöÄ' }
                };
                
                this.nodes.forEach((node, id) => {
                    if (stats[node.type]) {
                        stats[node.type].count++;
                        stats[node.type].items.push(node.name);
                    }
                });
                
                grid.innerHTML = Object.entries(stats).map(([type, data]) => `
                    <div class="stat-detail-card">
                        <div class="stat-detail-header">
                            <div class="stat-detail-icon" style="background: ${data.color}20; color: ${data.color};">
                                ${data.icon}
                            </div>
                            <div>
                                <div class="stat-detail-title">${this.config.colors[type].label}s</div>
                                <div class="stat-detail-value">${data.count}</div>
                            </div>
                        </div>
                        <div class="stat-detail-list">
                            ${data.items.map(item => `
                                <div class="stat-detail-item">
                                    <span>${item}</span>
                                    <span style="color: var(--text-muted); font-size: 11px;">${type}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
                
                const fileTree = document.getElementById('fileTree');
                fileTree.innerHTML = `
                    <div class="file-tree-item dir">${this.repoSettings.name}/</div>
                    <div class="file-tree-item dir" style="padding-left: 40px;">data/</div>
                    <div class="file-tree-item" style="padding-left: 60px;">registry.db</div>
                    ${Array.from(this.nodes.values()).filter(n => n.type === 'datasource').map(n => 
                        `<div class="file-tree-item" style="padding-left: 60px;">${n.name.toLowerCase().replace(/\s+/g, '_')}.parquet</div>`
                    ).join('')}
                    <div class="file-tree-item" style="padding-left: 40px;">entities.py</div>
                    <div class="file-tree-item" style="padding-left: 40px;">data_sources.py</div>
                    <div class="file-tree-item" style="padding-left: 40px;">feature_views.py</div>
                    <div class="file-tree-item" style="padding-left: 40px;">services.py</div>
                    <div class="file-tree-item" style="padding-left: 40px;">debezium_configs.py</div>
                    <div class="file-tree-item" style="padding-left: 40px;">spark_jobs.py</div>
                    <div class="file-tree-item" style="padding-left: 40px;">django_models.py</div>
                    <div class="file-tree-item" style="padding-left: 40px;">postgres_rls.sql</div>
                    <div class="file-tree-item" style="padding-left: 40px;">feature_store.yaml</div>
                    <div class="file-tree-item" style="padding-left: 40px;">requirements.txt</div>
                `;
                
                modal.classList.add('active');
            }
            
            showNotification(title, text) {
                const notif = document.getElementById('notification');
                document.getElementById('notifTitle').textContent = title;
                document.getElementById('notifText').textContent = text;
                
                notif.classList.add('show');
                setTimeout(() => {
                    notif.classList.remove('show');
                }, 3000);
            }
            
            // Edge Manager Methods
            toggleEdgeManager() {
                const panel = document.getElementById('edgeManagerPanel');
                const isOpen = panel.classList.contains('open');
                
                if (isOpen) {
                    panel.classList.remove('open');
                    this.edgeManagerOpen = false;
                } else {
                    panel.classList.add('open');
                    this.edgeManagerOpen = true;
                    this.renderEdgeManager();
                }
            }
            
            renderEdgeManager() {
                const edgeList = document.getElementById('edgeList');
                const fromSelect = document.getElementById('edgeFromSelect');
                const toSelect = document.getElementById('edgeToSelect');
                
                const totalEdges = this.edges.length;
                const validEdges = this.edges.filter(e => this.nodes.has(e.from) && this.nodes.has(e.to)).length;
                const orphanedEdges = totalEdges - validEdges;
                
                document.getElementById('edgeCountTotal').textContent = totalEdges;
                document.getElementById('edgeCountValid').textContent = validEdges;
                document.getElementById('edgeCountOrphaned').textContent = orphanedEdges;
                
                if (this.edges.length === 0) {
                    edgeList.innerHTML = `
                        <div class="empty-state" style="padding: 40px 20px;">
                            <div class="empty-icon">üîó</div>
                            <div class="empty-title">No Connections</div>
                            <p style="font-size: 13px;">Create connections between nodes to establish lineage</p>
                        </div>
                    `;
                } else {
                    edgeList.innerHTML = this.edges.map(edge => {
                        const fromNode = this.nodes.get(edge.from);
                        const toNode = this.nodes.get(edge.to);
                        const isValid = fromNode && toNode;
                        
                        if (!isValid) {
                            return `
                                <div class="edge-item" style="border-color: var(--feast-red); opacity: 0.7;">
                                    <div class="edge-header">
                                        <div style="color: var(--feast-red); font-size: 20px;">‚ö†Ô∏è</div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 500; color: var(--feast-red);">Orphaned Connection</div>
                                            <div style="font-size: 12px; color: var(--text-muted);">
                                                ${!fromNode ? `Missing source: ${edge.from}` : ''}
                                                ${!fromNode && !toNode ? ' | ' : ''}
                                                ${!toNode ? `Missing target: ${edge.to}` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="edge-actions">
                                        <button class="edge-btn danger" onclick="diagram.deleteEdge('${edge.id}')">Delete</button>
                                    </div>
                                </div>
                            `;
                        }
                        
                        const fromConfig = this.config.colors[fromNode.type];
                        const toConfig = this.config.colors[toNode.type];
                        
                        let fromIcon = fromConfig.icon;
                        if (fromNode.type === 'datasource' && fromNode.dbType && fromNode.dbType.icon) {
                            fromIcon = fromNode.dbType.icon;
                        }
                        
                        let toIcon = toConfig.icon;
                        if (toNode.type === 'datasource' && toNode.dbType && toNode.dbType.icon) {
                            toIcon = toNode.dbType.icon;
                        }
                        
                        return `
                            <div class="edge-item">
                                <div class="edge-header">
                                    <div class="edge-node-icon" style="background: ${fromConfig.bg}20; color: ${fromConfig.light};">
                                        ${fromIcon}
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500;">${fromNode.name}</div>
                                        <div style="font-size: 11px; color: var(--text-muted);">${fromConfig.label}</div>
                                    </div>
                                    <span class="edge-arrow">‚Üí</span>
                                    <div class="edge-node-icon" style="background: ${toConfig.bg}20; color: ${toConfig.light};">
                                        ${toIcon}
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500;">${toNode.name}</div>
                                        <div style="font-size: 11px; color: var(--text-muted);">${toConfig.label}</div>
                                    </div>
                                </div>
                                <div class="edge-actions">
                                    <button class="edge-btn" onclick="diagram.selectNode('${edge.from}')">View Source</button>
                                    <button class="edge-btn" onclick="diagram.selectNode('${edge.to}')">View Target</button>
                                    <button class="edge-btn danger" onclick="diagram.deleteEdge('${edge.id}')">Disconnect</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                const nodeOptions = Array.from(this.nodes.values()).map(node => {
                    const config = this.config.colors[node.type];
                    let icon = config.icon;
                    if (node.type === 'datasource' && node.dbType && node.dbType.icon) {
                        icon = node.dbType.icon;
                    }
                    return `<option value="${node.id}">${icon} ${node.name}</option>`;
                }).join('');
                
                fromSelect.innerHTML = '<option value="">Select source...</option>' + nodeOptions;
                toSelect.innerHTML = '<option value="">Select target...</option>' + nodeOptions;
            }
            
            deleteEdge(edgeId) {
                if (!confirm('Are you sure you want to delete this connection?')) return;
                
                const edgeIndex = this.edges.findIndex(e => e.id === edgeId);
                if (edgeIndex === -1) return;
                
                const edge = this.edges[edgeIndex];
                
                this.edges.splice(edgeIndex, 1);
                
                const fromNode = this.nodes.get(edge.from);
                const toNode = this.nodes.get(edge.to);
                
                if (fromNode) {
                    fromNode.outputs = fromNode.outputs.filter(id => id !== edge.to);
                }
                if (toNode) {
                    toNode.inputs = toNode.inputs.filter(id => id !== edge.from);
                }
                
                if (toNode && toNode.type === 'featureview') {
                    toNode.entities = toNode.entities.filter(id => id !== edge.from);
                }
                if (toNode && toNode.type === 'service') {
                    toNode.features = toNode.features.filter(id => id !== edge.from);
                    if (toNode.featureServices) {
                        toNode.featureServices = toNode.featureServices.filter(id => id !== edge.from);
                    }
                }
                
                this.renderEdgeManager();
                this.showNotification('Disconnected', 'Connection removed');
                
                if (this.selectedNode) {
                    this.showPanel(this.selectedNode);
                }
            }
            
            addEdgeFromManager() {
                const fromId = document.getElementById('edgeFromSelect').value;
                const toId = document.getElementById('edgeToSelect').value;
                
                if (!fromId || !toId) {
                    alert('Please select both source and target nodes');
                    return;
                }
                
                if (fromId === toId) {
                    alert('Cannot connect a node to itself');
                    return;
                }
                
                const exists = this.edges.some(e => e.from === fromId && e.to === toId);
                if (exists) {
                    alert('Connection already exists');
                    return;
                }
                
                const fromNode = this.nodes.get(fromId);
                const toNode = this.nodes.get(toId);
                
                const validConnections = {
                    'entity': ['featureview'],
                    'datasource': ['featureview'],
                    'featureview': ['service'],
                    'service': ['service']
                };
                
                if (!validConnections[fromNode.type]?.includes(toNode.type)) {
                    alert(`Invalid connection: ${fromNode.type} cannot connect to ${toNode.type}`);
                    return;
                }
                
                this.addConnection(fromId, toId);
                
                if (toNode.type === 'featureview' && fromNode.type === 'entity') {
                    if (!toNode.entities.includes(fromId)) {
                        toNode.entities.push(fromId);
                    }
                }
                
                if (toNode.type === 'service' && fromNode.type === 'featureview') {
                    if (!toNode.features.includes(fromId)) {
                        toNode.features.push(fromId);
                    }
                }
                
                this.renderEdgeManager();
                this.showNotification('Connected', `${fromNode.name} ‚Üí ${toNode.name}`);
                
                document.getElementById('edgeFromSelect').value = '';
                document.getElementById('edgeToSelect').value = '';
            }
            
            centerOnNode(id) {
                const node = this.nodes.get(id);
                if (!node) return;
                
                const targetScale = 1.5;
                const targetOffsetX = (this.width / 2) - (node.x + this.config.nodeWidth / 2) * targetScale;
                const targetOffsetY = (this.height / 2) - (node.y + this.config.nodeHeight / 2) * targetScale;
                
                const startScale = this.scale;
                const startOffsetX = this.offsetX;
                const startOffsetY = this.offsetY;
                
                const duration = 500;
                const startTime = Date.now();
                
                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const eased = 1 - Math.pow(1 - progress, 3);
                    
                    this.scale = startScale + (targetScale - startScale) * eased;
                    this.offsetX = startOffsetX + (targetOffsetX - startOffsetX) * eased;
                    this.offsetY = startOffsetY + (targetOffsetY - startOffsetY) * eased;
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    }
                };
                
                animate();
            }

            // LLM Helper Methods
            toggleLLMHelper() {
                const panel = document.getElementById('llmPanel');
                const isOpen = panel.classList.contains('open');
                
                if (isOpen) {
                    panel.classList.remove('open');
                    this.llmPanelOpen = false;
                } else {
                    panel.classList.add('open');
                    this.llmPanelOpen = true;
                    this.updateLLMContext();
                }
            }

            updateLLMContext() {
                const container = document.getElementById('llmContextContent');
                
                if (!this.selectedNode) {
                    const stats = {
                        nodes: this.nodes.size,
                        edges: this.edges.length,
                        sources: Array.from(this.nodes.values()).filter(n => n.type === 'datasource').length,
                        entities: Array.from(this.nodes.values()).filter(n => n.type === 'entity').length,
                        views: Array.from(this.nodes.values()).filter(n => n.type === 'featureview').length,
                        services: Array.from(this.nodes.values()).filter(n => n.type === 'service').length
                    };
                    
                    container.innerHTML = `
                        <div class="llm-context-item">
                            <span>üìä</span>
                            <span>Architecture Overview: ${stats.nodes} components</span>
                        </div>
                        <div class="llm-context-item">
                            <span>üîó</span>
                            <span>${stats.edges} connections</span>
                        </div>
                        <div class="llm-context-item">
                            <span>üóÑÔ∏è</span>
                            <span>${stats.sources} sources, ${stats.entities} entities</span>
                        </div>
                        <div class="llm-context-item">
                            <span>‚ö°</span>
                            <span>${stats.views} views, ${stats.services} services</span>
                        </div>
                    `;
                } else {
                    const node = this.nodes.get(this.selectedNode);
                    const config = this.config.colors[node.type];
                    
                    let icon = config.icon;
                    if (node.type === 'datasource' && node.dbType && node.dbType.icon) {
                        icon = node.dbType.icon;
                    }
                    
                    container.innerHTML = `
                        <div class="llm-context-item">
                            <span>${icon}</span>
                            <span><strong>${node.name}</strong> (${config.label})</span>
                        </div>
                        ${node.description ? `
                        <div class="llm-context-item">
                            <span>üìù</span>
                            <span>${node.description.substring(0, 60)}${node.description.length > 60 ? '...' : ''}</span>
                        </div>
                        ` : ''}
                        ${node.features ? `
                        <div class="llm-context-item">
                            <span>‚ö°</span>
                            <span>${node.features.length} features</span>
                        </div>
                        ` : ''}
                        ${node.entities ? `
                        <div class="llm-context-item">
                            <span>üë§</span>
                            <span>${node.entities.length} entities</span>
                        </div>
                        ` : ''}
                    `;
                }
            }

            async askLLM(promptType) {
                const messagesContainer = document.getElementById('llmMessages');
                const context = this.selectedNode ? this.nodes.get(this.selectedNode) : null;
                
                let userMessage = '';
                
                switch(promptType) {
                    case 'generate_code':
                        userMessage = 'Generate Feast code for this architecture';
                        break;
                    case 'optimize':
                        userMessage = 'Suggest optimizations for my feature views';
                        break;
                    case 'lineage':
                        userMessage = 'Explain this data lineage';
                        break;
                    case 'validate':
                        userMessage = 'Validate my entity relationships';
                        break;
                }
                
                // Add user message
                const userMsgDiv = document.createElement('div');
                userMsgDiv.className = 'llm-message user';
                userMsgDiv.textContent = userMessage;
                messagesContainer.appendChild(userMsgDiv);
                
                // Show loading
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'llm-message assistant';
                loadingDiv.innerHTML = '<div class="spinner"></div> Thinking...';
                messagesContainer.appendChild(loadingDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Check if we have a chat session
                if (!this.currentChatSession) {
                    // Create new session via backend
                    try {
                        const response = await fetch(`${this.apiBaseUrl}/chats/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCsrfToken()
                            },
                            body: JSON.stringify({
                                repository_id: this.repoId,
                                title: `Chat about ${this.repoSettings.name}`,
                                initial_message: userMessage,
                                query_type: promptType
                            })
                        });
                        
                        if (!response.ok) {
                            throw new Error('Failed to create chat session');
                        }
                        
                        const data = await response.json();
                        this.currentChatSession = data.id;
                        
                        // Remove loading, messages already in response
                        loadingDiv.remove();
                        
                        // Display messages from response
                        if (data.messages) {
                            data.messages.forEach(msg => {
                                if (msg.role === 'assistant') {
                                    const assistantMsgDiv = document.createElement('div');
                                    assistantMsgDiv.className = 'llm-message assistant';
                                    assistantMsgDiv.innerHTML = msg.content;
                                    messagesContainer.appendChild(assistantMsgDiv);
                                }
                            });
                        }
                        
                        this.addLLMActionButtons(messagesContainer.lastChild);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        return;
                        
                    } catch (error) {
                        console.error('LLM session creation failed:', error);
                        loadingDiv.innerHTML = 'Error: LLM service unavailable. Using local fallback...';
                        
                        // Fall back to local generation
                        setTimeout(() => {
                            loadingDiv.remove();
                            this.fallbackLLMResponse(promptType, context, messagesContainer);
                        }, 1000);
                        return;
                    }
                }
                
                // Existing session - send message
                try {
                    const response = await fetch(`${this.apiBaseUrl}/chats/${this.currentChatSession}/send_message/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCsrfToken()
                        },
                        body: JSON.stringify({
                            message: userMessage,
                            query_type: promptType
                        })
                    });
                    
                    const data = await response.json();
                    
                    loadingDiv.remove();
                    
                    if (data.success) {
                        const assistantMsgDiv = document.createElement('div');
                        assistantMsgDiv.className = 'llm-message assistant';
                        assistantMsgDiv.innerHTML = data.response;
                        messagesContainer.appendChild(assistantMsgDiv);
                        this.addLLMActionButtons(assistantMsgDiv);
                    } else {
                        throw new Error(data.error || 'Unknown error');
                    }
                    
                } catch (error) {
                    console.error('LLM query failed:', error);
                    loadingDiv.remove();
                    this.fallbackLLMResponse(promptType, context, messagesContainer);
                }
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            fallbackLLMResponse(promptType, context, container) {
                // Your existing mock response logic as fallback
                let assistantResponse = '';
                
                switch(promptType) {
                    case 'generate_code':
                        assistantResponse = this.generateLLMCodeResponse(context);
                        break;
                    case 'optimize':
                        assistantResponse = this.generateLLMOptimizeResponse(context);
                        break;
                    case 'lineage':
                        assistantResponse = this.generateLLMLineageResponse(context);
                        break;
                    case 'validate':
                        assistantResponse = this.generateLLMValidateResponse();
                        break;
                }
                
                const assistantMsgDiv = document.createElement('div');
                assistantMsgDiv.className = 'llm-message assistant';
                assistantMsgDiv.innerHTML = assistantResponse + '<p style="color: var(--text-muted); font-size: 11px; margin-top: 8px;">[Local fallback - backend unavailable]</p>';
                container.appendChild(assistantMsgDiv);
                this.addLLMActionButtons(assistantMsgDiv);
            }
            
            addLLMActionButtons(messageDiv) {
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'llm-actions';
                actionsDiv.innerHTML = `
                    <button class="llm-action-btn" onclick="diagram.applyLLMSuggestion()">Apply to Diagram</button>
                    <button class="llm-action-btn" onclick="diagram.copyLLMResponse(this)">Copy</button>
                    <button class="llm-action-btn" onclick="diagram.dismissLLM(this)">Dismiss</button>
                `;
                messageDiv.appendChild(actionsDiv);
            }

            sendLLMMessage() {
                const input = document.getElementById('llmInput');
                const message = input.value.trim();
                if (!message) return;
                
                const messagesContainer = document.getElementById('llmMessages');
                
                const userMsgDiv = document.createElement('div');
                userMsgDiv.className = 'llm-message user';
                userMsgDiv.textContent = message;
                messagesContainer.appendChild(userMsgDiv);
                
                input.value = '';
                
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'llm-message assistant';
                loadingDiv.innerHTML = '<div class="spinner"></div> Analyzing your feature store...';
                messagesContainer.appendChild(loadingDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                setTimeout(() => {
                    loadingDiv.remove();
                    
                    const assistantMsgDiv = document.createElement('div');
                    assistantMsgDiv.className = 'llm-message assistant';
                    assistantMsgDiv.innerHTML = `
                        <p>I've analyzed your question about "${message}".</p>
                        <p>Based on your current architecture with ${this.nodes.size} components, I recommend reviewing the data lineage from sources to services to ensure consistency.</p>
                        <p>Would you like me to:</p>
                        <ul style="margin-left: 20px; margin-top: 8px;">
                            <li>Generate specific code for a component</li>
                            <li>Analyze feature dependencies</li>
                            <li>Suggest performance improvements</li>
                        </ul>
                    `;
                    messagesContainer.appendChild(assistantMsgDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 2000);
            }

            async sendLLMMessage() {
                const input = document.getElementById('llmInput');
                const message = input.value.trim();
                if (!message) return;
                
                const messagesContainer = document.getElementById('llmMessages');
                
                const userMsgDiv = document.createElement('div');
                userMsgDiv.className = 'llm-message user';
                userMsgDiv.textContent = message;
                messagesContainer.appendChild(userMsgDiv);
                
                input.value = '';
                
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'llm-message assistant';
                loadingDiv.innerHTML = '<div class="spinner"></div> Analyzing your feature store...';
                messagesContainer.appendChild(loadingDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Use backend if available
                if (!this.currentChatSession) {
                    // Create session first
                    try {
                        const response = await fetch(`${this.apiBaseUrl}/chats/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCsrfToken()
                            },
                            body: JSON.stringify({
                                repository_id: this.repoId,
                                title: `Chat about ${this.repoSettings.name}`,
                                initial_message: message,
                                query_type: 'default'
                            })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            this.currentChatSession = data.id;
                            
                            loadingDiv.remove();
                            
                            // Display response
                            if (data.messages) {
                                const lastMsg = data.messages[data.messages.length - 1];
                                if (lastMsg && lastMsg.role === 'assistant') {
                                    const assistantMsgDiv = document.createElement('div');
                                    assistantMsgDiv.className = 'llm-message assistant';
                                    assistantMsgDiv.innerHTML = lastMsg.content;
                                    messagesContainer.appendChild(assistantMsgDiv);
                                    this.addLLMActionButtons(assistantMsgDiv);
                                }
                            }
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            return;
                        }
                    } catch (error) {
                        console.error('Failed to create chat:', error);
                    }
                } else {
                    // Use existing session
                    try {
                        const response = await fetch(`${this.apiBaseUrl}/chats/${this.currentChatSession}/send_message/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCsrfToken()
                            },
                            body: JSON.stringify({
                                message: message,
                                query_type: 'default'
                            })
                        });
                        
                        const data = await response.json();
                        
                        loadingDiv.remove();
                        
                        if (data.success) {
                            const assistantMsgDiv = document.createElement('div');
                            assistantMsgDiv.className = 'llm-message assistant';
                            assistantMsgDiv.innerHTML = data.response;
                            messagesContainer.appendChild(assistantMsgDiv);
                            this.addLLMActionButtons(assistantMsgDiv);
                            messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            return;
                        }
                    } catch (error) {
                        console.error('Send message failed:', error);
                    }
                }
                
                // Fallback to local response
                loadingDiv.remove();
                const assistantMsgDiv = document.createElement('div');
                assistantMsgDiv.className = 'llm-message assistant';
                assistantMsgDiv.innerHTML = `
                    <p>I've analyzed your question about "${message}".</p>
                    <p>Based on your current architecture with ${this.nodes.size} components, I recommend reviewing the data lineage from sources to services to ensure consistency.</p>
                    <p style="color: var(--text-muted); font-size: 11px;">[Local fallback - backend unavailable]</p>
                `;
                messagesContainer.appendChild(assistantMsgDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            generateLLMCodeResponse(context) {
                if (!context) {
                    return `<p>Here's a complete Feast repository structure for your architecture:</p>
<pre>feature_repo/
‚îú‚îÄ‚îÄ entities.py          # ${Array.from(this.nodes.values()).filter(n => n.type === 'entity').length} entities
‚îú‚îÄ‚îÄ data_sources.py      # ${Array.from(this.nodes.values()).filter(n => n.type === 'datasource').length} sources
‚îú‚îÄ‚îÄ feature_views.py     # ${Array.from(this.nodes.values()).filter(n => n.type === 'featureview').length} views
‚îú‚îÄ‚îÄ services.py          # ${Array.from(this.nodes.values()).filter(n => n.type === 'service').length} services
‚îî‚îÄ‚îÄ feature_store.yaml   # Configuration</pre>
<p>All files include proper docstrings and follow Feast best practices.</p>`;
                }
                
                return `<p>Generated code for <strong>${context.name}</strong>:</p>
<pre># ${context.name} configuration
${context.type === 'featureview' ? `
feature_view = FeatureView(
    name="${context.name}",
    entities=[${context.entities.map(e => '"' + (this.nodes.get(e)?.name || 'entity') + '"').join(', ')}],
    features=[
${context.features.map(f => `        Feature(name="${f.name}", dtype=${f.type}),`).join('\n')}
    ],
    source=${context.inputs[0] ? this.nodes.get(context.inputs[0])?.name + '_source' : 'None'}
)` : context.type === 'entity' ? `
entity = Entity(
    name="${context.name}",
    join_keys=["${context.joinKey}"],
    value_type=ValueType.STRING
)` : ''}
</pre>`;
            }

            generateLLMOptimizeResponse(context) {
                if (!context) {
                    return `<p>Architecture Optimization Suggestions:</p>
<ul style="margin-left: 20px; margin-top: 8px;">
    <li><strong>Streaming Efficiency:</strong> Consider increasing Kafka partitions for high-throughput sources</li>
    <li><strong>Feature TTL:</strong> Review TTL settings - some features may expire too quickly</li>
    <li><strong>Entity Cardinality:</strong> High cardinality entities may benefit from caching</li>
    <li><strong>Data Source Consolidation:</strong> 3 sources have similar schemas - consider merging</li>
</ul>`;
                }
                
                return `<p>Optimization recommendations for <strong>${context.name}</strong>:</p>
<ul style="margin-left: 20px; margin-top: 8px;">
    <li>Reduce feature granularity to improve serving latency</li>
    <li>Add feature validation to catch data quality issues</li>
    <li>Consider materialization for frequently accessed features</li>
</ul>`;
            }

            generateLLMLineageResponse(context) {
                if (!context) {
                    return `<p>Full Data Lineage Overview:</p>
<p>Your architecture flows from ${Array.from(this.nodes.values()).filter(n => n.type === 'datasource').length} sources through ${Array.from(this.nodes.values()).filter(n => n.type === 'featureview').length} feature views to ${Array.from(this.nodes.values()).filter(n => n.type === 'service').length} services.</p>
<p>Key lineage paths:</p>
<ul style="margin-left: 20px; margin-top: 8px;">
    <li>User Database ‚Üí User Demographics ‚Üí Recommendation API</li>
    <li>Kafka Stream ‚Üí User Behavior ‚Üí Fraud Detection</li>
</ul>`;
                }
                
                const inputs = context.inputs.map(id => this.nodes.get(id)?.name).filter(Boolean);
                const outputs = context.outputs.map(id => this.nodes.get(id)?.name).filter(Boolean);
                
                return `<p>Data Lineage for <strong>${context.name}</strong>:</p>
<p><strong>Inputs:</strong> ${inputs.length > 0 ? inputs.join(', ') : 'None'}</p>
<p><strong>Outputs:</strong> ${outputs.length > 0 ? outputs.join(', ') : 'None'}</p>
<p>This component is ${context.inputs.length === 0 ? 'a root source' : context.outputs.length === 0 ? 'a terminal sink' : 'a middle transformation'} in your data flow.</p>`;
            }

            generateLLMValidateResponse() {
                const issues = [];
                const warnings = [];
                
                this.nodes.forEach(node => {
                    if (node.type === 'featureview') {
                        if (node.entities.length === 0) {
                            issues.push(`${node.name} has no entities defined`);
                        }
                        if (node.features.length === 0) {
                            issues.push(`${node.name} has no features defined`);
                        }
                    }
                    if (node.type === 'service' && node.features.length === 0) {
                        warnings.push(`${node.name} has no feature views attached`);
                    }
                });
                
                if (issues.length === 0 && warnings.length === 0) {
                    return `<p>‚úÖ <strong>Validation Passed!</strong></p>
<p>All entity relationships are properly configured. Your architecture is ready for deployment.</p>`;
                }
                
                return `<p>${issues.length > 0 ? '‚ùå <strong>Issues Found:</strong>' : '‚ö†Ô∏è <strong>Warnings:</strong>'}</p>
${issues.length > 0 ? `<ul style="margin-left: 20px; color: var(--feast-red);">${issues.map(i => `<li>${i}</li>`).join('')}</ul>` : ''}
${warnings.length > 0 ? `<ul style="margin-left: 20px; color: var(--feast-yellow);">${warnings.map(w => `<li>${w}</li>`).join('')}</ul>` : ''}`;
            }

            applyLLMSuggestion() {
                this.showNotification('Applied', 'LLM suggestions applied to diagram');
            }

            copyLLMResponse(btn) {
                const message = btn.closest('.llm-message');
                const text = message.querySelector('p')?.textContent || '';
                navigator.clipboard.writeText(text);
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = 'Copy', 2000);
            }

            dismissLLM(btn) {
                btn.closest('.llm-message').remove();
            }

            // Django Admin Methods
            toggleDjangoAdmin() {
                const panel = document.getElementById('djangoPanel');
                const isOpen = panel.classList.contains('open');
                
                if (isOpen) {
                    panel.classList.remove('open');
                    this.djangoPanelOpen = false;
                } else {
                    panel.classList.add('open');
                    this.djangoPanelOpen = true;
                    this.updateDjangoPanel();
                }
            }

            async updateDjangoPanel() {
                // Fetch current user from backend
                try {
                    const userResponse = await fetch(`${this.apiBaseUrl}/auth/user/`);
                    if (userResponse.ok) {
                        const userData = await userResponse.json();
                        this.currentUser = {
                            id: userData.id,
                            name: `${userData.first_name} ${userData.last_name}`.trim() || userData.username,
                            initials: (userData.first_name?.[0] || userData.username[0]).toUpperCase(),
                            role: 'Authenticated User',
                            team: 'Django User'
                        };
                    }
                } catch (e) {
                    // Use existing mock user
                }
                
                document.getElementById('djangoCurrentUser').textContent = this.currentUser.name;
                document.getElementById('djangoTeam').textContent = this.currentUser.team;
                document.getElementById('djangoRole').textContent = this.currentUser.role;
                
                // Fetch real audit logs
                try {
                    const auditResponse = await fetch(`${this.apiBaseUrl}/audit-logs/?limit=10`);
                    if (auditResponse.ok) {
                        const auditData = await auditResponse.json();
                        const auditContainer = document.getElementById('djangoAuditLog');
                        
                        if (auditData.results && auditData.results.length > 0) {
                            auditContainer.innerHTML = auditData.results.map(event => {
                                const time = new Date(event.timestamp).toLocaleTimeString();
                                return `
                                    <div class="audit-log-item">
                                        <div class="audit-time">${time}</div>
                                        <div>
                                            <span class="audit-action">${event.action}</span>
                                            <span style="color: var(--text-muted);"> ‚Ä¢ </span>
                                            <span>${event.resource_name}</span>
                                        </div>
                                        <div class="audit-user">${event.user_username || 'System'}</div>
                                    </div>
                                `;
                            }).join('');
                        }
                    }
                } catch (e) {
                    // Fallback to mock data
                    const auditContainer = document.getElementById('djangoAuditLog');
                    const auditEvents = [
                        { time: '2 min ago', action: 'Viewed', resource: 'User Database', user: this.currentUser.name },
                        { time: '15 min ago', action: 'Modified', resource: 'Transaction History', user: this.currentUser.name }
                    ];
                    auditContainer.innerHTML = auditEvents.map(event => `
                        <div class="audit-log-item">
                            <div class="audit-time">${event.time}</div>
                            <div>
                                <span class="audit-action">${event.action}</span>
                                <span style="color: var(--text-muted);"> ‚Ä¢ </span>
                                <span>${event.resource}</span>
                            </div>
                            <div class="audit-user">${event.user}</div>
                        </div>
                    `).join('');
                }
                
                // Update permissions based on actual data sources
                const permsContainer = document.getElementById('djangoPermissions');
                const datasources = Array.from(this.nodes.values()).filter(n => n.type === 'datasource');
                
                permsContainer.innerHTML = datasources.map(ds => {
                    const perm = this.calculatePermission(ds);
                    const permClass = {
                        'owned': 'perm-owned',
                        'granted': 'perm-granted',
                        'pending': 'perm-pending',
                        'denied': 'perm-denied'
                    }[perm];
                    
                    return `
                        <div class="detail-row">
                            <span class="detail-label">${ds.name}</span>
                            <span class="permission-badge ${permClass}">
                                ${perm === 'owned' ? 'üëë Owned' : 
                                  perm === 'granted' ? '‚úÖ Granted' : 
                                  perm === 'pending' ? '‚è≥ Pending' : '‚ùå Denied'}
                            </span>
                        </div>
                    `;
                }).join('') || '<p style="color: var(--text-muted);">No data sources</p>';
                
                // Column security - use actual node data
                const colContainer = document.getElementById('djangoColumnSecurity');
                if (this.selectedNode && this.nodes.get(this.selectedNode)?.type === 'datasource') {
                    const node = this.nodes.get(this.selectedNode);
                    const columns = node.columnSecurity || { piiColumns: [], maskedColumns: [], restrictedColumns: [] };
                    
                    colContainer.innerHTML = `
                        <div class="column-security-grid">
                            ${['user_id', 'email', 'name', 'phone', 'ssn', 'created_at', 'updated_at'].map(col => {
                                const isPii = columns.piiColumns.includes(col);
                                const isMasked = columns.maskedColumns.includes(col);
                                const isRestricted = columns.restrictedColumns.includes(col);
                                
                                let status = 'accessible';
                                let statusClass = 'status-accessible';
                                
                                if (isRestricted) {
                                    status = 'denied';
                                    statusClass = 'status-denied';
                                } else if (isMasked) {
                                    status = 'masked';
                                    statusClass = 'status-masked';
                                }
                                
                                return `
                                    <div class="column-item">
                                        <span>${col} ${isPii ? 'üîí' : ''}</span>
                                        <span class="column-status ${statusClass}" title="${status}"></span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                } else {
                    colContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">Select a data source to view column security</p>';
                }
            }

            calculatePermission(datasource) {
                if (datasource.ownedBy === this.currentUser.team || 
                    datasource.ownedBy === this.currentUser.name) {
                    return 'owned';
                }
                // Simulate permission logic
                const hash = datasource.name.split('').reduce((a,b)=>a+b.charCodeAt(0),0);
                const perms = ['granted', 'granted', 'pending', 'denied'];
                return perms[hash % perms.length];
            }

            showUserSelector() {
                document.getElementById('userSelectorModal').classList.add('active');
            }

            switchUser() {
                const select = document.getElementById('userSelect');
                const users = {
                    john: { name: 'John Doe', initials: 'JD', role: 'Data Engineer', team: 'Data Engineering' },
                    jane: { name: 'Jane Smith', initials: 'JS', role: 'Data Scientist', team: 'Machine Learning' },
                    bob: { name: 'Bob Johnson', initials: 'BJ', role: 'Platform Admin', team: 'Platform' },
                    alice: { name: 'Alice Chen', initials: 'AC', role: 'ML Engineer', team: 'Machine Learning' }
                };
                
                const user = users[select.value];
                if (user) {
                    document.getElementById('teamSelect').value = user.team;
                    document.getElementById('roleSelect').value = user.role;
                }
            }

            applyUserContext() {
                const select = document.getElementById('userSelect');
                const users = {
                    john: { name: 'John Doe', initials: 'JD', role: 'Data Engineer', team: 'Data Engineering' },
                    jane: { name: 'Jane Smith', initials: 'JS', role: 'Data Scientist', team: 'Machine Learning' },
                    bob: { name: 'Bob Johnson', initials: 'BJ', role: 'Platform Admin', team: 'Platform' },
                    alice: { name: 'Alice Chen', initials: 'AC', role: 'ML Engineer', team: 'Machine Learning' }
                };
                
                this.currentUser = {
                    ...users[select.value],
                    id: select.value
                };
                
                document.getElementById('userAvatar').textContent = this.currentUser.initials;
                document.getElementById('userName').textContent = this.currentUser.name;
                document.getElementById('userRole').textContent = this.currentUser.role;
                
                document.getElementById('userSelectorModal').classList.remove('active');
                this.showNotification('Context Switched', `Now viewing as ${this.currentUser.name}`);
                
                if (this.djangoPanelOpen) {
                    this.updateDjangoPanel();
                }
            }

            // Data Flow Visualization
            showDataFlow() {
                const modal = document.getElementById('dataFlowModal');
                const stagesContainer = document.getElementById('dataFlowStages');
                
                const stages = [
                    {
                        name: 'Source Database',
                        icon: 'üóÑÔ∏è',
                        status: 'healthy',
                        details: 'PostgreSQL 14.2\nConnections: 45/100\nReplication: Active'
                    },
                    {
                        name: 'Debezium Connector',
                        icon: '‚ö°',
                        status: 'healthy',
                        details: 'Version: 2.1\nLag: 120ms\nEvents/sec: 1,240'
                    },
                    {
                        name: 'Kafka Topic',
                        icon: 'üì®',
                        status: 'healthy',
                        details: 'Partitions: 12\nReplication: 3\nRetention: 7 days'
                    },
                    {
                        name: 'Spark Structured Streaming',
                        icon: 'üî•',
                        status: 'warning',
                        details: 'Executors: 4/4\nBatch Duration: 5s\nLatency: 8s (elevated)'
                    },
                    {
                        name: 'Postgres Offline Store',
                        icon: 'üêò',
                        status: 'healthy',
                        details: 'Size: 2.4TB\nTables: 156\nConnections: 23'
                    }
                ];
                
                stagesContainer.innerHTML = stages.map((stage, idx) => `
                    <div class="data-flow-stage ${idx === 0 ? 'active' : ''}" onclick="this.classList.toggle('expanded')">
                        <div class="stage-icon" style="background: var(--bg-tertiary);">
                            ${stage.icon}
                        </div>
                        <div class="stage-info">
                            <div class="stage-title">${stage.name}</div>
                            <div class="stage-status">
                                <span class="stage-status-dot status-${stage.status === 'healthy' ? 'green' : stage.status === 'warning' ? 'yellow' : 'red'}"></span>
                                <span style="color: var(--${stage.status === 'healthy' ? 'feast-green' : stage.status === 'warning' ? 'feast-yellow' : 'feast-red'});">
                                    ${stage.status === 'healthy' ? 'Healthy' : stage.status === 'warning' ? 'Warning' : 'Error'}
                                </span>
                            </div>
                            <div class="stage-details">
                                ${stage.details.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                    </div>
                    ${idx < stages.length - 1 ? '<div class="flow-connector">‚Üì</div>' : ''}
                `).join('');
                
                modal.classList.add('active');
            }
            
            // Push repository to Django backend
            async pushRepo() {
                const repoId = this.repoSettings.id;
                const repoName = this.repoSettings.name;
                
                // Confirmation based on repo ID presence
                if (!repoId) {
                    if (!confirm('No repository ID found. Are you sure you want to create a new repository?')) {
                        return;
                    }
                } else {
                    if (!confirm(`Are you sure you want to update repository "${repoName}"?`)) {
                        return;
                    }
                }
                
                // Show modal with progress
                const modal = document.getElementById('pushRepoModal');
                document.getElementById('pushModalMessage').innerHTML = repoId 
                    ? `Updating repository "${repoName}"...` 
                    : 'Creating new repository...';
                document.getElementById('pushProgress').style.width = '0%';
                document.getElementById('pushStatus').innerHTML = 'Initializing...';
                modal.classList.add('active');
                
                // Prepare payload
                const payload = {
                    name: this.repoSettings.name,
                    location: this.repoSettings.location,
                    description: this.repoSettings.description,
                    default_owner: this.repoSettings.defaultOwner,
                    architecture_json: this.exportToJSON(),
                    settings: this.searchSettings
                };
                
                // Add hash for conflict detection if updating
                if (repoId) {
                    // Compute simple hash of current state
                    const stateStr = JSON.stringify(this.exportToJSON());
                    payload.client_hash = SparkMD5.hash(stateStr);
                    payload.client_timestamp = new Date().toISOString();
                }
                
                try {
                    document.getElementById('pushProgress').style.width = '30%';
                    document.getElementById('pushStatus').innerHTML = 'Sending to server...';
                    
                    let response;
                    
                    if (repoId) {
                        // Update existing
                        response = await fetch(`${this.apiBaseUrl}/repositories/${repoId}/`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCsrfToken()
                            },
                            body: JSON.stringify(payload)
                        });
                    } else {
                        // Create new
                        response = await fetch(`${this.apiBaseUrl}/repositories/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCsrfToken()
                            },
                            body: JSON.stringify(payload)
                        });
                    }
                    
                    document.getElementById('pushProgress').style.width = '70%';
                    document.getElementById('pushStatus').innerHTML = 'Processing response...';
                    
                    const data = await response.json();
                    
                    if (!response.ok) {
                        // Handle specific error cases
                        if (response.status === 409) {
                            // Conflict detected
                            document.getElementById('pushStatus').innerHTML = 
                                `‚ùå Conflict: ${data.detail || 'Repository modified by another session'}`;
                            document.getElementById('pushProgress').style.backgroundColor = 'var(--feast-red)';
                            
                            // Offer force update option
                            if (confirm('Conflict detected. Force overwrite server version?')) {
                                await this.forcePushRepo(payload);
                                return;
                            }
                            return;
                        }
                        throw new Error(data.detail || `HTTP ${response.status}`);
                    }
                    
                    // Success
                    document.getElementById('pushProgress').style.width = '100%';
                    document.getElementById('pushProgress').style.backgroundColor = 'var(--feast-green)';
                    
                    if (!repoId) {
                        // New repo created
                        this.repoSettings.id = data.id;
                        // Update URL without reload
                        const newUrl = new URL(window.location);
                        newUrl.searchParams.set('repo_id', data.id);
                        window.history.pushState({}, '', newUrl);
                        document.getElementById('pushStatus').innerHTML = 
                            `‚úÖ Repository created! ID: ${data.id}`;
                    } else {
                        document.getElementById('pushStatus').innerHTML = 
                            `‚úÖ Repository "${repoName}" updated successfully!`;
                    }
                    
                    this.updateRepoSubtitle();
                    this.showNotification('Push Successful', 
                        `Repository ${repoId ? 'updated' : 'created'}`);
                    
                } catch (error) {
                    console.error('Push failed:', error);
                    document.getElementById('pushStatus').innerHTML = 
                        `‚ùå Error: ${error.message}`;
                    document.getElementById('pushProgress').style.backgroundColor = 'var(--feast-red)';
                }
            }
            
            async forcePushRepo(payload) {
                document.getElementById('pushStatus').innerHTML = 'Force updating...';
                
                try {
                    const response = await fetch(`${this.apiBaseUrl}/repositories/${this.repoSettings.id}/force_update/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCsrfToken()
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        document.getElementById('pushProgress').style.width = '100%';
                        document.getElementById('pushProgress').style.backgroundColor = 'var(--feast-green)';
                        document.getElementById('pushStatus').innerHTML = 
                            '‚úÖ Force update successful!';
                        this.showNotification('Force Updated', 'Repository overwritten');
                    } else {
                        throw new Error(data.detail || 'Force update failed');
                    }
                } catch (error) {
                    document.getElementById('pushStatus').innerHTML = 
                        `‚ùå Force update failed: ${error.message}`;
                    document.getElementById('pushProgress').style.backgroundColor = 'var(--feast-red)';
                }
            }
            
            getCsrfToken() {
                // Get CSRF token from cookie for Django
                const name = 'csrftoken';
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            

            // Close push modal and clear interval
            closePushModal() {
                if (this.pushInterval) {
                    clearInterval(this.pushInterval);
                    this.pushInterval = null;
                }
                document.getElementById('pushRepoModal').classList.remove('active');
            }

            // Refresh repository from backend
            async refreshRepo() {
                if (!this.repoId) {
                    this.showNotification('Error', 'No repository ID to refresh');
                    return;
                }
                
                this.showNotification('Refresh', 'Fetching latest repository state...');
                
                try {
                    const response = await fetch(`${this.apiBaseUrl}/repositories/${this.repoId}/check_status/`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Check if server has newer version
                    const currentHash = SparkMD5.hash(JSON.stringify(this.exportToJSON()));
                    
                    if (data.server_hash && data.server_hash !== currentHash) {
                        // Server has different version - reload
                        if (confirm('Server has a different version. Reload? (local changes will be lost)')) {
                            await this.loadFromBackend();
                        }
                    } else {
                        this.showNotification('Up to date', 'Repository is synchronized');
                    }
                    
                } catch (error) {
                    console.error('Refresh failed:', error);
                    this.showNotification('Error', 'Failed to refresh repository');
                }
            }

            loadComplexExample() {
                // Create a comprehensive multi-source architecture
                
                // 1. PostgreSQL with Debezium CDC
                const userDb = this.addDatasource({
                    name: 'User Database',
                    kind: 'postgres',
                    description: 'Primary transactional database with user profiles and authentication data',
                    ownedBy: 'Platform Team',
                    accessProcess: '1. Submit request in ServiceNow\n2. Get approval from Platform Team lead\n3. Credentials delivered via Vault',
                    tags: ['critical', 'pii', 'platform'],
                    details: { 
                        connection: 'postgresql://prod.db.internal:5432/users',
                        notes: 'Owner: Platform Team\nSLA: 99.99%\nBackup: Daily snapshots\nEncryption: AES-256 at rest'
                    }
                });
                
                // 2. MongoDB (NoSQL with Debezium)
                const mongoEvents = this.addDatasource({
                    name: 'Event Store',
                    kind: 'mongodb',
                    description: 'NoSQL event store for user activity streams',
                    ownedBy: 'Analytics Team',
                    accessProcess: 'Contact analytics-oncall@company.com for read replicas',
                    tags: ['analytics', 'stream'],
                    details: {
                        connection: 'mongodb://analytics.mongo.internal:27017/events',
                        notes: 'Debezium CDC enabled\nRequires Spark streaming job\nRetention: 30 days'
                    }
                });
                
                // 3. Kafka (Streaming)
                const kafkaStream = this.addDatasource({
                    name: 'Kafka Stream',
                    kind: 'kafka',
                    description: 'Real-time event streaming platform',
                    ownedBy: 'Streaming Team',
                    accessProcess: 'Self-service via Kafka Manager UI',
                    tags: ['streaming', 'real-time'],
                    details: {
                        connection: 'kafka.prod.internal:9092',
                        topic: 'user-events',
                        notes: 'Topic: user-events\nRetention: 7 days\nPartitions: 24'
                    }
                });
                
                // 4. Snowflake (Cloud Warehouse)
                const dataWarehouse = this.addDatasource({
                    name: 'Snowflake Warehouse',
                    kind: 'snowflake',
                    description: 'Enterprise data warehouse for analytics',
                    ownedBy: 'Data Engineering',
                    accessProcess: 'Request access via internal Data Portal',
                    tags: ['warehouse', 'analytics', 'batch'],
                    details: {
                        connection: 'snowflake://prod.warehouse/ANALYTICS',
                        notes: 'Role-based access control\nTime travel: 90 days\nCredit usage monitored'
                    }
                });
                
                // 5. DynamoDB (NoSQL without Debezium)
                const dynamoCache = this.addDatasource({
                    name: 'DynamoDB Cache',
                    kind: 'dynamodb',
                    description: 'Low-latency cache for session data',
                    ownedBy: 'Backend Team',
                    accessProcess: 'IAM role escalation required',
                    tags: ['cache', 'low-latency'],
                    details: {
                        connection: 'dynamodb://us-east-1/session-cache',
                        notes: 'PushSource via Lambda streams\nTTL: 24 hours\nRCU/WCU: auto-scaling'
                    }
                });
                
                // 6. Redis (In-Memory)
                const redisCache = this.addDatasource({
                    name: 'Redis Cache',
                    kind: 'redis',
                    description: 'In-memory store for real-time features',
                    ownedBy: 'Platform Team',
                    accessProcess: 'Redis ACL set via config',
                    tags: ['cache', 'in-memory', 'fast'],
                    details: {
                        connection: 'redis://redis.internal:6379',
                        notes: 'Cluster mode enabled\nEviction: allkeys-lru\nMaxmemory: 64GB'
                    }
                });
                
                // 7. S3 (Object Storage)
                const s3Store = this.addDatasource({
                    name: 'S3 Data Lake',
                    kind: 's3',
                    description: 'Parquet files for historical batch processing',
                    ownedBy: 'Data Platform',
                    accessProcess: 'S3 bucket policy update via IAM',
                    tags: ['datalake', 'parquet', 'batch'],
                    details: {
                        connection: 's3://data-lake-prod/features/',
                        notes: 'Partitioned by date\nFormat: Parquet\nCompression: Snappy'
                    }
                });
                
                // 8. Neo4j (Graph)
                const graphDb = this.addDatasource({
                    name: 'Graph Database',
                    kind: 'neo4j',
                    description: 'Graph relationships for fraud detection',
                    ownedBy: 'Security Team',
                    accessProcess: 'Security review required',
                    tags: ['graph', 'fraud', 'relationships'],
                    details: {
                        connection: 'bolt://neo4j.internal:7687',
                        notes: 'Debezium CDC via plugin\nGraph algorithms: GDS\nEncryption: SSL'
                    }
                });
                
                // 9. Elasticsearch (Search)
                const searchIndex = this.addDatasource({
                    name: 'Search Index',
                    kind: 'elasticsearch',
                    description: 'Full-text search and log analytics',
                    ownedBy: 'Search Team',
                    accessProcess: 'Kibana role assignment',
                    tags: ['search', 'logs', 'analytics'],
                    details: {
                        connection: 'https://elasticsearch.internal:9200',
                        notes: 'Debezium CDC enabled\nIndices: daily rollover\nShards: 5 primary'
                    }
                });
                
                // 10. InfluxDB (Time-Series)
                const timeSeriesDb = this.addDatasource({
                    name: 'Metrics Store',
                    kind: 'influxdb',
                    description: 'Time-series metrics and monitoring data',
                    ownedBy: 'Observability Team',
                    accessProcess: 'InfluxDB token generation',
                    tags: ['metrics', 'time-series', 'monitoring'],
                    details: {
                        connection: 'http://influxdb.internal:8086',
                        notes: 'Retention: 90 days\nDownsampling: continuous queries\nPrecision: nanosecond'
                    }
                });
                
                // Entities
                const user = this.addEntity({
                    name: 'User',
                    joinKey: 'user_id',
                    description: 'Registered application users across all platforms',
                    tags: ['core', 'pii'],
                    details: {
                        notes: '100M+ users globally\nGDPR compliant\nPII masking required\nJoins: user_id (string)'
                    }
                });
                
                const session = this.addEntity({
                    name: 'Session',
                    joinKey: 'session_id',
                    description: 'Ephemeral user sessions for real-time features',
                    tags: ['ephemeral', 'real-time'],
                    details: {
                        notes: 'TTL: 4 hours\nHigh cardinality\nUsed for real-time personalization'
                    }
                });
                
                const product = this.addEntity({
                    name: 'Product',
                    joinKey: 'product_id',
                    description: 'Product catalog with variants and categories',
                    tags: ['catalog', 'reference'],
                    details: {
                        notes: '2.5M active products\nUpdated: hourly\nCategories: hierarchical'
                    }
                });
                
                const merchant = this.addEntity({
                    name: 'Merchant',
                    joinKey: 'merchant_id',
                    description: 'Seller accounts with risk profiles',
                    tags: ['seller', 'risk'],
                    details: {
                        notes: '50K active merchants\nKYC verified\nRisk scoring enabled'
                    }
                });
                
                const device = this.addEntity({
                    name: 'Device',
                    joinKey: 'device_fingerprint',
                    description: 'Device fingerprinting for fraud detection',
                    tags: ['fraud', 'security'],
                    details: {
                        notes: 'Fingerprinting via JS SDK\nBot detection enabled\nPrivacy compliant'
                    }
                });
                
                // Feature Views - Batch
                const userDemographics = this.addFeatureView({
                    name: 'User Demographics',
                    subtype: 'batch',
                    description: 'Static user attributes from registration and profile updates',
                    entities: [user],
                    tags: ['profile', 'batch', 'pii'],
                    features: [
                        { name: 'age', type: 'Int64' },
                        { name: 'country_code', type: 'String' },
                        { name: 'gender', type: 'String' },
                        { name: 'signup_date', type: 'String' },
                        { name: 'account_tier', type: 'String' },
                        { name: 'language_preference', type: 'String' },
                        { name: 'timezone', type: 'String' }
                    ],
                    details: {
                        ttl: '86400',
                        notes: 'Updated daily via Airflow\nBackfill: 5 years\nQuality: 99.5% complete\nPII: hashed in online store'
                    }
                });
                
                const userTransactions = this.addFeatureView({
                    name: 'Transaction History',
                    subtype: 'batch',
                    description: 'Aggregated purchase history and spending patterns',
                    entities: [user],
                    tags: ['financial', 'sensitive', 'batch'],
                    features: [
                        { name: 'total_lifetime_spend', type: 'Float32' },
                        { name: 'order_count_30d', type: 'Int64' },
                        { name: 'avg_order_value', type: 'Float32' },
                        { name: 'favorite_category', type: 'String' },
                        { name: 'days_since_last_order', type: 'Int64' },
                        { name: 'refund_rate', type: 'Float32' },
                        { name: 'payment_methods_used', type: 'Int64' }
                    ],
                    details: {
                        ttl: '86400',
                        notes: 'Updated hourly\nSensitive: financial data\nAudit: required\nEncryption: column-level'
                    }
                });
                
                const productCatalog = this.addFeatureView({
                    name: 'Product Catalog Features',
                    subtype: 'batch',
                    description: 'Product embeddings and catalog metadata',
                    entities: [product],
                    tags: ['catalog', 'embeddings', 'ml'],
                    features: [
                        { name: 'category_embedding', type: 'Float32' },
                        { name: 'price_percentile', type: 'Float32' },
                        { name: 'stock_availability', type: 'String' },
                        { name: 'seller_rating', type: 'Float32' },
                        { name: 'return_rate', type: 'Float32' },
                        { name: 'view_to_purchase_ratio', type: 'Float32' }
                    ],
                    details: {
                        ttl: '14400',
                        notes: 'Embeddings: 128-dim\nUpdated: every 4 hours\nSource: Snowflake\nModel: BERT-based'
                    }
                });
                
                const merchantRiskProfile = this.addFeatureView({
                    name: 'Merchant Risk Profile',
                    subtype: 'batch',
                    description: 'Risk indicators and trust scores for merchants',
                    entities: [merchant],
                    tags: ['risk', 'compliance', 'fraud'],
                    features: [
                        { name: 'chargeback_rate_30d', type: 'Float32' },
                        { name: 'account_age_days', type: 'Int64' },
                        { name: 'risk_score', type: 'Float32' },
                        { name: 'kyc_verified', type: 'Bool' },
                        { name: 'suspicious_activity_flag', type: 'Bool' },
                        { name: 'avg_settlement_time', type: 'Int64' }
                    ],
                    details: {
                        ttl: '86400',
                        notes: 'Sensitive: compliance data\nOwner: Risk Team\nAccess: restricted\nModel: XGBoost classifier'
                    }
                });
                
                // Feature Views - Stream
                const userBehaviorStream = this.addFeatureView({
                    name: 'User Behavior Stream',
                    subtype: 'stream',
                    description: 'Real-time behavioral features from clickstream',
                    entities: [user, session],
                    tags: ['real-time', 'behavior', 'ml'],
                    features: [
                        { name: 'page_views_5m', type: 'Int64' },
                        { name: 'clicks_5m', type: 'Int64' },
                        { name: 'scroll_depth_avg', type: 'Float32' },
                        { name: 'time_on_site_5m', type: 'Int64' },
                        { name: 'bounce_rate_1h', type: 'Float32' },
                        { name: 'session_duration', type: 'Int64' },
                        { name: 'referrer_category', type: 'String' }
                    ],
                    details: {
                        ttl: '3600',
                        notes: 'Window: 5 minutes\nLatency: <100ms p99\nSource: Kafka\nAggregation: tumbling window'
                    }
                });
                
                const deviceFingerprint = this.addFeatureView({
                    name: 'Device Intelligence',
                    subtype: 'stream',
                    description: 'Device-level fraud signals and reputation',
                    entities: [device],
                    tags: ['fraud', 'security', 'real-time'],
                    features: [
                        { name: 'device_reputation_score', type: 'Float32' },
                        { name: 'bot_probability', type: 'Float32' },
                        { name: 'vpn_proxy_detected', type: 'Bool' },
                        { name: 'device_age_hours', type: 'Int64' },
                        { name: 'associated_accounts_count', type: 'Int64' }
                    ],
                    details: {
                        ttl: '7200',
                        notes: 'Source: DynamoDB streams\nLatency: <50ms\nIntegration: MaxMind\nML: real-time inference'
                    }
                });
                
                // Feature Views - On-Demand
                const sessionContext = this.addFeatureView({
                    name: 'Session Context',
                    subtype: 'on_demand',
                    description: 'Computed session features for real-time personalization',
                    entities: [session],
                    tags: ['on-demand', 'real-time', 'context'],
                    features: [
                        { name: 'contextual_discount_eligible', type: 'Bool' },
                        { name: 'ab_test_variant', type: 'String' },
                        { name: 'device_type', type: 'String' },
                        { name: 'geo_region', type: 'String' }
                    ],
                    details: {
                        notes: 'On-demand transformation\nNo TTL (computed live)\nSource: request context\nPerformance: <10ms compute'
                    }
                });
                
                // Cross-source feature view (joining multiple sources)
                const unifiedUserProfile = this.addFeatureView({
                    name: 'Unified User Profile',
                    subtype: 'batch',
                    description: 'Comprehensive user profile combining Postgres, MongoDB, and S3 data',
                    entities: [user],
                    tags: ['unified', 'cross-source', 'batch'],
                    features: [
                        { name: 'engagement_score', type: 'Float32' },
                        { name: 'lifetime_value_predicted', type: 'Float32' },
                        { name: 'churn_risk_score', type: 'Float32' },
                        { name: 'preferred_channel', type: 'String' },
                        { name: 'segment', type: 'String' }
                    ],
                    details: {
                        ttl: '86400',
                        notes: 'Joins: User DB + Event Store + S3 historical\nSpark job: hourly\nModel: Ensemble classifier'
                    }
                });
                
                // Services
                const recommendationService = this.addService({
                    name: 'Recommendation API',
                    description: 'Personalized product recommendations for homepage and product pages',
                    features: [userDemographics, userBehaviorStream, userTransactions, productCatalog, unifiedUserProfile],
                    tags: ['recommendations', 'personalization', 'core'],
                    details: {
                        usedBy: [
                            { name: 'web-frontend', environment: 'Production', sla: '99.9%', contact: 'web-team@company.com', description: 'Main e-commerce website' },
                            { name: 'mobile-app', environment: 'Production', sla: '99.9%', contact: 'mobile-team@company.com', description: 'iOS and Android apps' },
                            { name: 'email-service', environment: 'Production', sla: '99.5%', contact: 'marketing-tech@company.com', description: 'Personalized email campaigns' }
                        ],
                        notes: 'QPS: 15K peak\nLatency p99: 45ms\nDeploy: k8s-feast\nModel: Two-tower neural network\nCache: Redis 1 hour TTL'
                    }
                });
                
                const fraudDetectionService = this.addService({
                    name: 'Fraud Detection',
                    description: 'Real-time transaction fraud scoring and risk assessment',
                    features: [userDemographics, userTransactions, merchantRiskProfile, deviceFingerprint, unifiedUserProfile],
                    tags: ['fraud', 'security', 'critical'],
                    details: {
                        usedBy: [
                            { name: 'payment-gateway', environment: 'Production', sla: '99.99%', contact: 'payments@company.com', description: 'Payment processing pipeline' },
                            { name: 'risk-dashboard', environment: 'Production', sla: '99.5%', contact: 'risk-ops@company.com', description: 'Analyst investigation UI' },
                            { name: 'merchant-onboarding', environment: 'Production', sla: '99.9%', contact: 'merchant-team@company.com', description: 'New seller verification' }
                        ],
                        notes: 'QPS: 8K\nLatency p99: 30ms\nCritical: blocking path\nModel: Ensemble XGBoost + DL\nAlerting: PagerDuty integration'
                    }
                });
                
                const searchRankingService = this.addService({
                    name: 'Search Ranking',
                    description: 'Learned ranking features for search and category pages',
                    features: [productCatalog, userBehaviorStream, userDemographics, unifiedUserProfile],
                    tags: ['search', 'ranking', 'ml'],
                    details: {
                        usedBy: [
                            { name: 'search-service', environment: 'Production', sla: '99.9%', contact: 'search-team@company.com', description: 'Elasticsearch integration' },
                            { name: 'category-pages', environment: 'Production', sla: '99.5%', contact: 'web-team@company.com', description: 'Browse navigation' }
                        ],
                        notes: 'QPS: 12K\nLatency p99: 35ms\nModel: LambdaMART\nA/B test: 5% holdout\nFeature importance logged'
                    }
                });
                
                const analyticsWarehouseService = this.addService({
                    name: 'Analytics Features',
                    description: 'Batch features for BI, reporting, and data science',
                    features: [userTransactions, productCatalog, merchantRiskProfile, userDemographics, unifiedUserProfile],
                    tags: ['analytics', 'batch', 'warehouse'],
                    details: {
                        usedBy: [
                            { name: 'bi-dashboard', environment: 'Production', sla: '95%', contact: 'analytics@company.com', description: 'Tableau dashboards' },
                            { name: 'data-science', environment: 'Development', sla: 'Best effort', contact: 'ds-platform@company.com', description: 'Jupyter notebooks' },
                            { name: 'executive-reports', environment: 'Production', sla: '99%', contact: 'bi-team@company.com', description: 'Weekly business reports' }
                        ],
                        notes: 'Batch only\nSchedule: hourly\nOutput: Snowflake\nNo online serving\nCost: $2K/month compute'
                    }
                });
                
                const realTimePersonalization = this.addService({
                    name: 'Real-Time Personalization',
                    description: 'Session-based personalization using on-demand features',
                    features: [sessionContext, userBehaviorStream],
                    featureServices: [recommendationService],
                    tags: ['real-time', 'personalization', 'composite'],
                    details: {
                        usedBy: [
                            { name: 'promo-engine', environment: 'Production', sla: '99.9%', contact: 'growth@company.com', description: 'Dynamic pricing and offers' },
                            { name: 'cart-abandonment', environment: 'Production', sla: '99.5%', contact: 'crm@company.com', description: 'Recovery campaigns' }
                        ],
                        notes: 'Composite service\nOn-demand + precomputed\nLatency: <20ms\nUses Recommendation API as base'
                    }
                });

                
                
                // Add some manual connections for cross-source views
                this.addConnection(s3Store, unifiedUserProfile);
                this.addConnection(graphDb, fraudDetectionService);
                this.addConnection(searchIndex, searchRankingService);
                this.addConnection(timeSeriesDb, analyticsWarehouseService);
                
                this.autoLayout();
            }

            switchGuideContext(context) {
                // Update tab states
                document.querySelectorAll('.context-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                const activeTab = document.getElementById(`tab-${context}`);
                if (activeTab) {
                    activeTab.classList.add('active');
                }
                
                // Update content visibility
                document.querySelectorAll('.guide-content').forEach(content => {
                    content.style.display = 'none';
                });
                const activeContent = document.getElementById(`guide-${context}`);
                if (activeContent) {
                    activeContent.style.display = 'block';
                }
                
                // Re-render mermaid diagrams for the visible context
                if (window.mermaid) {
                    setTimeout(() => {
                        mermaid.init(undefined, document.querySelectorAll('.mermaid'));
                    }, 50);
                }
            }

            showPattern(patternId) {
                // Update pattern tabs
                const clickedTab = event.target;
                document.querySelectorAll('.pattern-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                clickedTab.classList.add('active');
                
                // Update pattern content
                document.querySelectorAll('.pattern-content').forEach(content => {
                    content.style.display = 'none';
                });
                const targetContent = document.getElementById(`pattern-${patternId}`);
                if (targetContent) {
                    targetContent.style.display = 'block';
                }
                
                // Re-render mermaid
                if (window.mermaid) {
                    setTimeout(() => {
                        mermaid.init(undefined, document.querySelectorAll('.mermaid'));
                    }, 50);
                }
            }
        
        
            }
        
        const diagram = new FeastDiagram('diagramCanvas');
    </script>
</body>
</html>


