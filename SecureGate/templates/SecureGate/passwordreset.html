{% extends 'SecureGate/base.html' %} 
{% block content %}
<form id="reset-password" class="myform100-form validate-form">
  {% csrf_token %}
  <input type="hidden" name="token" id="token">
  <span class="myform100-form-title"> Create password </span>

  <div class="wrap-input100 validate-input" data-validate="Valid username is required">
    <input class="input100" type="text" name="username" placeholder="Username" />
    <span class="focus-input100"></span>
    <span class="symbol-input100">
      <i class="fa fa-user" aria-hidden="true"></i>
    </span>
  </div>

  <div class="wrap-input100 validate-input" data-validate="Password is required">
    <input class="input100" type="password" name="password" placeholder="Password" />
    <span class="focus-input100"></span>
    <span class="symbol-input100">
      <i class="fa fa-lock" aria-hidden="true"></i>
    </span>
  </div>

  <div class="wrap-input100 validate-input" data-validate="Passwords are not the same">
    <input class="input100" type="password" name="confirm_password" placeholder="Password" />
    <span class="focus-input100"></span>
    <span class="symbol-input100">
      <i class="fa fa-lock" aria-hidden="true"></i>
    </span>
  </div>

  <span class="myform100-form-title" style="font-size: 12px; color: red; text-align: center; padding: 5px" id="error"></span>

  <div class="container-myform100-form-btn">
    <button type="submit" class="myform100-form-btn" id="submit-reset-password">Change Password</button>
  </div>


  <div class="text-center p-t-80">
    <a onclick="goToLogin()" class="txt2" href="#login">
      Go to login	
      <i class="fa fa-long-arrow-left m-l-5" aria-hidden="true"></i>
    </a>
  </div>
</form>

{% endblock%}

{% block custom_script %}
<script>
  $(document).ready(function() {
      // Function to get token from URL
      function getTokenFromURL() {
          var url = window.location.href;
          var token = null;

          // Check if URL contains a token parameter
          if (url.includes('?token=')) {
              // Extract the token from the URL
              var params = new URLSearchParams(url.split('?')[1]);
              token = params.get('token');
          }

          return token;
      }

      // Set token value in the hidden input field
      var token = getTokenFromURL();
      if (token) {
          $('#token').val(token);
      }

      // Function to submit the form via AJAX
      function submitResetForm(formData) {
        $.ajax({
            //url: '../reset_password', 
            type: 'POST', 
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if(response.status==200){
                  // clear form
                  $("#reset-password")[0].innerHTML = `
                      <span class="myform100-form-title" 
                        style="font-size: 12px; 
                        color: green; text-align: 
                        center; padding: 5px">
                          ${response.message}
                      </span>
                      <div class="text-center p-t-80">
                      <a onclick="goToLogin()" class="txt2" href="#login">
                          Go to login	
                      <i class="fa fa-long-arrow-left m-l-5" aria-hidden="true"></i>
                      </a>
                      </div>`
                } 
                else if (response.error){
                    $('#error').text("Could not reset password: " + response.error);
                } 
                else {
                  $('#error').text("Could not reset password.");
                }
            },
            error: function(xhr, status) {
                console.error('Could not reset password. Status:', status, 'Response:', xhr.responseText);              
                if (xhr.responseText) {
                    $('#error').text("Could not reset password: " + xhr.responseText);
                } else {
                    $('#error').text("Could not reset password.");
                }
            }
        });
    }

      // Event listener for form submission
      $('#reset-password').submit(function(event) {
          event.preventDefault(); // Prevent default form submission

          // Get password and confirm password values
          var password = $('input[name="password"]').val().trim();
          var confirmPassword = $('input[name="confirm_password"]').val().trim();

          // Check if passwords match
          if (password !== confirmPassword) {
              $('#error').text("Passwords do not match");
          } else {
              // Passwords match, proceed with form submission via AJAX
              var formData = new FormData(this);
              submitResetForm(formData);
          }
      });
  });
</script>
{% endblock %}